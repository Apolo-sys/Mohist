--- a/net/minecraft/entity/LivingEntity.java
+++ b/net/minecraft/entity/LivingEntity.java
@@ -1,26 +_,49 @@
 package net.minecraft.entity;
 
-import com.google.common.base.Objects;
-import com.google.common.collect.ImmutableList;
-import com.google.common.collect.ImmutableMap;
-import com.google.common.collect.Lists;
-import com.google.common.collect.Maps;
-import com.mojang.datafixers.util.Pair;
-import com.mojang.serialization.DataResult;
-import com.mojang.serialization.Dynamic;
+import java.util.ArrayList;
 import java.util.Collection;
 import java.util.ConcurrentModificationException;
+import java.util.HashSet;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
 import java.util.Optional;
 import java.util.Random;
+import java.util.Set;
 import java.util.UUID;
 import java.util.function.Predicate;
+
 import javax.annotation.Nullable;
+
+import org.bukkit.Bukkit;
+import org.bukkit.Location;
+import org.bukkit.craftbukkit.v1_16_R3.attribute.CraftAttributeMap;
+import org.bukkit.craftbukkit.v1_16_R3.entity.CraftLivingEntity;
+import org.bukkit.craftbukkit.v1_16_R3.event.CraftEventFactory;
+import org.bukkit.craftbukkit.v1_16_R3.inventory.CraftItemStack;
+import org.bukkit.entity.Player;
+import org.bukkit.event.entity.ArrowBodyCountChangeEvent;
+import org.bukkit.event.entity.EntityDamageEvent;
+import org.bukkit.event.entity.EntityPotionEffectEvent;
+import org.bukkit.event.entity.EntityPotionEffectEvent.Cause;
+import org.bukkit.event.entity.EntityRegainHealthEvent;
+import org.bukkit.event.entity.EntityResurrectEvent;
+import org.bukkit.event.entity.EntityTeleportEvent;
+import org.bukkit.event.player.PlayerItemConsumeEvent;
+
+import com.google.common.base.Function;
+import com.google.common.base.Objects;
+import com.google.common.collect.ImmutableList;
+import com.google.common.collect.ImmutableMap;
+import com.google.common.collect.Lists;
+import com.google.common.collect.Maps;
+import com.mojang.datafixers.util.Pair;
+import com.mojang.serialization.DataResult;
+import com.mojang.serialization.Dynamic;
+
+import io.papermc.paper.event.entity.EntityMoveEvent;
 import net.minecraft.advancements.CriteriaTriggers;
 import net.minecraft.block.BedBlock;
-import net.minecraft.block.Block;
 import net.minecraft.block.BlockState;
 import net.minecraft.block.Blocks;
 import net.minecraft.block.HoneyBlock;
@@ -42,8 +_,9 @@
 import net.minecraft.entity.boss.WitherEntity;
 import net.minecraft.entity.item.ExperienceOrbEntity;
 import net.minecraft.entity.item.ItemEntity;
+import net.minecraft.entity.passive.AnimalEntity;
 import net.minecraft.entity.passive.IFlyingAnimal;
-import net.minecraft.entity.passive.WolfEntity;
+import net.minecraft.entity.passive.TameableEntity;
 import net.minecraft.entity.player.PlayerEntity;
 import net.minecraft.entity.player.ServerPlayerEntity;
 import net.minecraft.entity.projectile.AbstractArrowEntity;
@@ -62,7 +_,9 @@
 import net.minecraft.loot.LootParameters;
 import net.minecraft.loot.LootTable;
 import net.minecraft.nbt.CompoundNBT;
+import net.minecraft.nbt.FloatNBT;
 import net.minecraft.nbt.INBT;
+import net.minecraft.nbt.IntNBT;
 import net.minecraft.nbt.ListNBT;
 import net.minecraft.nbt.NBTDynamicOps;
 import net.minecraft.network.IPacket;
@@ -113,2982 +_,3621 @@
 import net.minecraft.world.server.ServerWorld;
 import net.minecraftforge.api.distmarker.Dist;
 import net.minecraftforge.api.distmarker.OnlyIn;
+import net.minecraftforge.common.ForgeHooks;
 
 public abstract class LivingEntity extends Entity {
-   private static final UUID field_110156_b = UUID.fromString("662A6B8D-DA3E-4C1C-8813-96EA6097278D");
-   private static final UUID field_233625_c_ = UUID.fromString("87f46a96-686f-4796-b035-22e16ee9e038");
-   private static final AttributeModifier field_110157_c = new AttributeModifier(field_110156_b, "Sprinting speed boost", (double)0.3F, AttributeModifier.Operation.MULTIPLY_TOTAL);
-   protected static final DataParameter<Byte> field_184621_as = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187191_a);
-   private static final DataParameter<Float> field_184632_c = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187193_c);
-   private static final DataParameter<Integer> field_184633_f = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187192_b);
-   private static final DataParameter<Boolean> field_184634_g = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187198_h);
-   private static final DataParameter<Integer> field_184635_h = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187192_b);
-   private static final DataParameter<Integer> field_226291_bp_ = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187192_b);
-   private static final DataParameter<Optional<BlockPos>> field_213379_bs = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187201_k);
-   protected static final EntitySize field_213377_as = EntitySize.func_220311_c(0.2F, 0.2F);
-   private final AttributeModifierManager field_110155_d;
-   private final CombatTracker field_94063_bt = new CombatTracker(this);
-   private final Map<Effect, EffectInstance> field_70713_bf = Maps.newHashMap();
-   private final NonNullList<ItemStack> field_184630_bs = NonNullList.func_191197_a(2, ItemStack.field_190927_a);
-   private final NonNullList<ItemStack> field_184631_bt = NonNullList.func_191197_a(4, ItemStack.field_190927_a);
-   public boolean field_82175_bq;
-   public Hand field_184622_au;
-   public int field_110158_av;
-   public int field_70720_be;
-   public int field_226290_au_;
-   public int field_70737_aN;
-   public int field_70738_aO;
-   public float field_70739_aP;
-   public int field_70725_aQ;
-   public float field_70732_aI;
-   public float field_70733_aJ;
-   protected int field_184617_aD;
-   public float field_184618_aE;
-   public float field_70721_aZ;
-   public float field_184619_aG;
-   public final int field_70771_an = 20;
-   public final float field_70769_ao;
-   public final float field_70770_ap;
-   public float field_70761_aq;
-   public float field_70760_ar;
-   public float field_70759_as;
-   public float field_70758_at;
-   public float field_70747_aH = 0.02F;
-   @Nullable
-   protected PlayerEntity field_70717_bb;
-   protected int field_70718_bc;
-   protected boolean field_70729_aU;
-   protected int field_70708_bq;
-   protected float field_70768_au;
-   protected float field_110154_aX;
-   protected float field_70764_aw;
-   protected float field_70763_ax;
-   protected float field_70741_aB;
-   protected int field_70744_aE;
-   protected float field_110153_bc;
-   protected boolean field_70703_bu;
-   public float field_70702_br;
-   public float field_70701_bs;
-   public float field_191988_bg;
-   protected int field_70716_bi;
-   protected double field_184623_bh;
-   protected double field_184624_bi;
-   protected double field_184625_bj;
-   protected double field_184626_bk;
-   protected double field_70709_bj;
-   protected double field_208001_bq;
-   protected int field_208002_br;
-   private boolean field_70752_e = true;
-   @Nullable
-   private LivingEntity field_70755_b;
-   private int field_70756_c;
-   private LivingEntity field_110150_bn;
-   private int field_142016_bo;
-   private float field_70746_aG;
-   private int field_70773_bE;
-   private float field_110151_bq;
-   protected ItemStack field_184627_bm = ItemStack.field_190927_a;
-   protected int field_184628_bn;
-   protected int field_184629_bo;
-   private BlockPos field_184620_bC;
-   private Optional<BlockPos> field_233624_bE_ = Optional.empty();
-   private DamageSource field_189750_bF;
-   private long field_189751_bG;
-   protected int field_204807_bs;
-   private float field_205017_bL;
-   private float field_205018_bM;
-   protected Brain<?> field_213378_br;
-
-   protected LivingEntity(EntityType<? extends LivingEntity> p_i48577_1_, World p_i48577_2_) {
-      super(p_i48577_1_, p_i48577_2_);
-      this.field_110155_d = new AttributeModifierManager(GlobalEntityTypeAttributes.func_233835_a_(p_i48577_1_));
-      this.func_70606_j(this.func_110138_aP());
-      this.field_70156_m = true;
-      this.field_70770_ap = (float)((Math.random() + 1.0D) * (double)0.01F);
-      this.func_226264_Z_();
-      this.field_70769_ao = (float)Math.random() * 12398.0F;
-      this.field_70177_z = (float)(Math.random() * (double)((float)Math.PI * 2F));
-      this.field_70759_as = this.field_70177_z;
-      this.field_70138_W = 0.6F;
-      NBTDynamicOps nbtdynamicops = NBTDynamicOps.field_210820_a;
-      this.field_213378_br = this.func_213364_a(new Dynamic<>(nbtdynamicops, nbtdynamicops.createMap(ImmutableMap.of(nbtdynamicops.createString("memories"), nbtdynamicops.emptyMap()))));
-   }
-
-   public Brain<?> func_213375_cj() {
-      return this.field_213378_br;
-   }
-
-   protected Brain.BrainCodec<?> func_230289_cH_() {
-      return Brain.func_233705_a_(ImmutableList.of(), ImmutableList.of());
-   }
-
-   protected Brain<?> func_213364_a(Dynamic<?> p_213364_1_) {
-      return this.func_230289_cH_().func_233748_a_(p_213364_1_);
-   }
-
-   public void func_174812_G() {
-      this.func_70097_a(DamageSource.field_76380_i, Float.MAX_VALUE);
-   }
-
-   public boolean func_213358_a(EntityType<?> p_213358_1_) {
-      return true;
-   }
-
-   protected void func_70088_a() {
-      this.field_70180_af.func_187214_a(field_184621_as, (byte)0);
-      this.field_70180_af.func_187214_a(field_184633_f, 0);
-      this.field_70180_af.func_187214_a(field_184634_g, false);
-      this.field_70180_af.func_187214_a(field_184635_h, 0);
-      this.field_70180_af.func_187214_a(field_226291_bp_, 0);
-      this.field_70180_af.func_187214_a(field_184632_c, 1.0F);
-      this.field_70180_af.func_187214_a(field_213379_bs, Optional.empty());
-   }
-
-   public static AttributeModifierMap.MutableAttribute func_233639_cI_() {
-      return AttributeModifierMap.func_233803_a_().func_233814_a_(Attributes.field_233818_a_).func_233814_a_(Attributes.field_233820_c_).func_233814_a_(Attributes.field_233821_d_).func_233814_a_(Attributes.field_233826_i_).func_233814_a_(Attributes.field_233827_j_);
-   }
-
-   protected void func_184231_a(double p_184231_1_, boolean p_184231_3_, BlockState p_184231_4_, BlockPos p_184231_5_) {
-      if (!this.func_70090_H()) {
-         this.func_233567_aH_();
-      }
-
-      if (!this.field_70170_p.field_72995_K && p_184231_3_ && this.field_70143_R > 0.0F) {
-         this.func_233641_cN_();
-         this.func_233642_cO_();
-      }
-
-      if (!this.field_70170_p.field_72995_K && this.field_70143_R > 3.0F && p_184231_3_) {
-         float f = (float)MathHelper.func_76123_f(this.field_70143_R - 3.0F);
-         if (!p_184231_4_.func_196958_f()) {
-            double d0 = Math.min((double)(0.2F + f / 15.0F), 2.5D);
-            int i = (int)(150.0D * d0);
-            ((ServerWorld)this.field_70170_p).func_195598_a(new BlockParticleData(ParticleTypes.field_197611_d, p_184231_4_), this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), i, 0.0D, 0.0D, 0.0D, (double)0.15F);
-         }
-      }
-
-      super.func_184231_a(p_184231_1_, p_184231_3_, p_184231_4_, p_184231_5_);
-   }
-
-   public boolean func_70648_aU() {
-      return this.func_70668_bt() == CreatureAttribute.field_223223_b_;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public float func_205015_b(float p_205015_1_) {
-      return MathHelper.func_219799_g(p_205015_1_, this.field_205018_bM, this.field_205017_bL);
-   }
-
-   public void func_70030_z() {
-      this.field_70732_aI = this.field_70733_aJ;
-      if (this.field_70148_d) {
-         this.func_213374_dv().ifPresent(this::func_213370_a);
-      }
-
-      if (this.func_230490_cK_()) {
-         this.func_233640_cL_();
-      }
-
-      super.func_70030_z();
-      this.field_70170_p.func_217381_Z().func_76320_a("livingEntityBaseTick");
-      boolean flag = this instanceof PlayerEntity;
-      if (this.func_70089_S()) {
-         if (this.func_70094_T()) {
-            this.func_70097_a(DamageSource.field_76368_d, 1.0F);
-         } else if (flag && !this.field_70170_p.func_175723_af().func_177743_a(this.func_174813_aQ())) {
-            double d0 = this.field_70170_p.func_175723_af().func_177745_a(this) + this.field_70170_p.func_175723_af().func_177742_m();
-            if (d0 < 0.0D) {
-               double d1 = this.field_70170_p.func_175723_af().func_177727_n();
-               if (d1 > 0.0D) {
-                  this.func_70097_a(DamageSource.field_76368_d, (float)Math.max(1, MathHelper.func_76128_c(-d0 * d1)));
-               }
-            }
-         }
-      }
-
-      if (this.func_230279_az_() || this.field_70170_p.field_72995_K) {
-         this.func_70066_B();
-      }
-
-      boolean flag1 = flag && ((PlayerEntity)this).field_71075_bZ.field_75102_a;
-      if (this.func_70089_S()) {
-         if (this.func_208600_a(FluidTags.field_206959_a) && !this.field_70170_p.func_180495_p(new BlockPos(this.func_226277_ct_(), this.func_226280_cw_(), this.func_226281_cx_())).func_203425_a(Blocks.field_203203_C)) {
-            if (!this.func_70648_aU() && !EffectUtils.func_205133_c(this) && !flag1) {
-               this.func_70050_g(this.func_70682_h(this.func_70086_ai()));
-               if (this.func_70086_ai() == -20) {
-                  this.func_70050_g(0);
-                  Vector3d vector3d = this.func_213322_ci();
-
-                  for(int i = 0; i < 8; ++i) {
-                     double d2 = this.field_70146_Z.nextDouble() - this.field_70146_Z.nextDouble();
-                     double d3 = this.field_70146_Z.nextDouble() - this.field_70146_Z.nextDouble();
-                     double d4 = this.field_70146_Z.nextDouble() - this.field_70146_Z.nextDouble();
-                     this.field_70170_p.func_195594_a(ParticleTypes.field_197612_e, this.func_226277_ct_() + d2, this.func_226278_cu_() + d3, this.func_226281_cx_() + d4, vector3d.field_72450_a, vector3d.field_72448_b, vector3d.field_72449_c);
-                  }
-
-                  this.func_70097_a(DamageSource.field_76369_e, 2.0F);
-               }
-            }
-
-            if (!this.field_70170_p.field_72995_K && this.func_184218_aH() && this.func_184187_bx() != null && !this.func_184187_bx().func_205710_ba()) {
-               this.func_184210_p();
-            }
-         } else if (this.func_70086_ai() < this.func_205010_bg()) {
-            this.func_70050_g(this.func_207300_l(this.func_70086_ai()));
-         }
-
-         if (!this.field_70170_p.field_72995_K) {
-            BlockPos blockpos = this.func_233580_cy_();
-            if (!Objects.equal(this.field_184620_bC, blockpos)) {
-               this.field_184620_bC = blockpos;
-               this.func_184594_b(blockpos);
-            }
-         }
-      }
-
-      if (this.func_70089_S() && this.func_203008_ap()) {
-         this.func_70066_B();
-      }
-
-      if (this.field_70737_aN > 0) {
-         --this.field_70737_aN;
-      }
-
-      if (this.field_70172_ad > 0 && !(this instanceof ServerPlayerEntity)) {
-         --this.field_70172_ad;
-      }
-
-      if (this.func_233643_dh_()) {
-         this.func_70609_aI();
-      }
-
-      if (this.field_70718_bc > 0) {
-         --this.field_70718_bc;
-      } else {
-         this.field_70717_bb = null;
-      }
-
-      if (this.field_110150_bn != null && !this.field_110150_bn.func_70089_S()) {
-         this.field_110150_bn = null;
-      }
-
-      if (this.field_70755_b != null) {
-         if (!this.field_70755_b.func_70089_S()) {
-            this.func_70604_c((LivingEntity)null);
-         } else if (this.field_70173_aa - this.field_70756_c > 100) {
-            this.func_70604_c((LivingEntity)null);
-         }
-      }
-
-      this.func_70679_bo();
-      this.field_70763_ax = this.field_70764_aw;
-      this.field_70760_ar = this.field_70761_aq;
-      this.field_70758_at = this.field_70759_as;
-      this.field_70126_B = this.field_70177_z;
-      this.field_70127_C = this.field_70125_A;
-      this.field_70170_p.func_217381_Z().func_76319_b();
-   }
-
-   public boolean func_230490_cK_() {
-      return this.field_70173_aa % 5 == 0 && this.func_213322_ci().field_72450_a != 0.0D && this.func_213322_ci().field_72449_c != 0.0D && !this.func_175149_v() && EnchantmentHelper.func_234846_j_(this) && this.func_230296_cM_();
-   }
-
-   protected void func_233640_cL_() {
-      Vector3d vector3d = this.func_213322_ci();
-      this.field_70170_p.func_195594_a(ParticleTypes.field_239812_C_, this.func_226277_ct_() + (this.field_70146_Z.nextDouble() - 0.5D) * (double)this.func_213311_cf(), this.func_226278_cu_() + 0.1D, this.func_226281_cx_() + (this.field_70146_Z.nextDouble() - 0.5D) * (double)this.func_213311_cf(), vector3d.field_72450_a * -0.2D, 0.1D, vector3d.field_72449_c * -0.2D);
-      float f = this.field_70146_Z.nextFloat() * 0.4F + this.field_70146_Z.nextFloat() > 0.9F ? 0.6F : 0.0F;
-      this.func_184185_a(SoundEvents.field_232831_nS_, f, 0.6F + this.field_70146_Z.nextFloat() * 0.4F);
-   }
-
-   protected boolean func_230296_cM_() {
-      return this.field_70170_p.func_180495_p(this.func_226270_aj_()).func_235714_a_(BlockTags.field_232876_aq_);
-   }
-
-   protected float func_225515_ai_() {
-      return this.func_230296_cM_() && EnchantmentHelper.func_185284_a(Enchantments.field_234847_l_, this) > 0 ? 1.0F : super.func_225515_ai_();
-   }
-
-   protected boolean func_230295_b_(BlockState p_230295_1_) {
-      return !p_230295_1_.func_196958_f() || this.func_184613_cA();
-   }
-
-   protected void func_233641_cN_() {
-      ModifiableAttributeInstance modifiableattributeinstance = this.func_110148_a(Attributes.field_233821_d_);
-      if (modifiableattributeinstance != null) {
-         if (modifiableattributeinstance.func_111127_a(field_233625_c_) != null) {
-            modifiableattributeinstance.func_188479_b(field_233625_c_);
-         }
-
-      }
-   }
-
-   protected void func_233642_cO_() {
-      if (!this.func_233568_aJ_().func_196958_f()) {
-         int i = EnchantmentHelper.func_185284_a(Enchantments.field_234847_l_, this);
-         if (i > 0 && this.func_230296_cM_()) {
-            ModifiableAttributeInstance modifiableattributeinstance = this.func_110148_a(Attributes.field_233821_d_);
-            if (modifiableattributeinstance == null) {
-               return;
-            }
-
-            modifiableattributeinstance.func_233767_b_(new AttributeModifier(field_233625_c_, "Soul speed boost", (double)(0.03F * (1.0F + (float)i * 0.35F)), AttributeModifier.Operation.ADDITION));
-            if (this.func_70681_au().nextFloat() < 0.04F) {
-               ItemStack itemstack = this.func_184582_a(EquipmentSlotType.FEET);
-               itemstack.func_222118_a(1, this, (p_233654_0_) -> {
-                  p_233654_0_.func_213361_c(EquipmentSlotType.FEET);
-               });
-            }
-         }
-      }
-
-   }
-
-   protected void func_184594_b(BlockPos p_184594_1_) {
-      int i = EnchantmentHelper.func_185284_a(Enchantments.field_185301_j, this);
-      if (i > 0) {
-         FrostWalkerEnchantment.func_185266_a(this, this.field_70170_p, p_184594_1_, i);
-      }
-
-      if (this.func_230295_b_(this.func_233568_aJ_())) {
-         this.func_233641_cN_();
-      }
-
-      this.func_233642_cO_();
-   }
-
-   public boolean func_70631_g_() {
-      return false;
-   }
-
-   public float func_213355_cm() {
-      return this.func_70631_g_() ? 0.5F : 1.0F;
-   }
-
-   protected boolean func_241208_cS_() {
-      return true;
-   }
-
-   public boolean func_205710_ba() {
-      return false;
-   }
-
-   protected void func_70609_aI() {
-      ++this.field_70725_aQ;
-      if (this.field_70725_aQ == 20) {
-         this.func_70106_y();
-
-         for(int i = 0; i < 20; ++i) {
-            double d0 = this.field_70146_Z.nextGaussian() * 0.02D;
-            double d1 = this.field_70146_Z.nextGaussian() * 0.02D;
-            double d2 = this.field_70146_Z.nextGaussian() * 0.02D;
-            this.field_70170_p.func_195594_a(ParticleTypes.field_197598_I, this.func_226282_d_(1.0D), this.func_226279_cv_(), this.func_226287_g_(1.0D), d0, d1, d2);
-         }
-      }
-
-   }
-
-   protected boolean func_146066_aG() {
-      return !this.func_70631_g_();
-   }
-
-   protected boolean func_230282_cS_() {
-      return !this.func_70631_g_();
-   }
-
-   protected int func_70682_h(int p_70682_1_) {
-      int i = EnchantmentHelper.func_185292_c(this);
-      return i > 0 && this.field_70146_Z.nextInt(i + 1) > 0 ? p_70682_1_ : p_70682_1_ - 1;
-   }
-
-   protected int func_207300_l(int p_207300_1_) {
-      return Math.min(p_207300_1_ + 4, this.func_205010_bg());
-   }
-
-   protected int func_70693_a(PlayerEntity p_70693_1_) {
-      return 0;
-   }
-
-   protected boolean func_70684_aJ() {
-      return false;
-   }
-
-   public Random func_70681_au() {
-      return this.field_70146_Z;
-   }
-
-   @Nullable
-   public LivingEntity func_70643_av() {
-      return this.field_70755_b;
-   }
-
-   public int func_142015_aE() {
-      return this.field_70756_c;
-   }
-
-   public void func_230246_e_(@Nullable PlayerEntity p_230246_1_) {
-      this.field_70717_bb = p_230246_1_;
-      this.field_70718_bc = this.field_70173_aa;
-   }
-
-   public void func_70604_c(@Nullable LivingEntity p_70604_1_) {
-      this.field_70755_b = p_70604_1_;
-      this.field_70756_c = this.field_70173_aa;
-   }
-
-   @Nullable
-   public LivingEntity func_110144_aD() {
-      return this.field_110150_bn;
-   }
-
-   public int func_142013_aG() {
-      return this.field_142016_bo;
-   }
-
-   public void func_130011_c(Entity p_130011_1_) {
-      if (p_130011_1_ instanceof LivingEntity) {
-         this.field_110150_bn = (LivingEntity)p_130011_1_;
-      } else {
-         this.field_110150_bn = null;
-      }
-
-      this.field_142016_bo = this.field_70173_aa;
-   }
-
-   public int func_70654_ax() {
-      return this.field_70708_bq;
-   }
-
-   public void func_213332_m(int p_213332_1_) {
-      this.field_70708_bq = p_213332_1_;
-   }
-
-   protected void func_184606_a_(ItemStack p_184606_1_) {
-      if (!p_184606_1_.func_190926_b()) {
-         SoundEvent soundevent = SoundEvents.field_187719_p;
-         Item item = p_184606_1_.func_77973_b();
-         if (item instanceof ArmorItem) {
-            soundevent = ((ArmorItem)item).func_200880_d().func_200899_b();
-         } else if (item == Items.field_185160_cR) {
-            soundevent = SoundEvents.field_191258_p;
-         }
-
-         this.func_184185_a(soundevent, 1.0F, 1.0F);
-      }
-   }
-
-   public void func_213281_b(CompoundNBT p_213281_1_) {
-      p_213281_1_.func_74776_a("Health", this.func_110143_aJ());
-      p_213281_1_.func_74777_a("HurtTime", (short)this.field_70737_aN);
-      p_213281_1_.func_74768_a("HurtByTimestamp", this.field_70756_c);
-      p_213281_1_.func_74777_a("DeathTime", (short)this.field_70725_aQ);
-      p_213281_1_.func_74776_a("AbsorptionAmount", this.func_110139_bj());
-      p_213281_1_.func_218657_a("Attributes", this.func_233645_dx_().func_233794_c_());
-      if (!this.field_70713_bf.isEmpty()) {
-         ListNBT listnbt = new ListNBT();
-
-         for(EffectInstance effectinstance : this.field_70713_bf.values()) {
-            listnbt.add(effectinstance.func_82719_a(new CompoundNBT()));
-         }
-
-         p_213281_1_.func_218657_a("ActiveEffects", listnbt);
-      }
-
-      p_213281_1_.func_74757_a("FallFlying", this.func_184613_cA());
-      this.func_213374_dv().ifPresent((p_213338_1_) -> {
-         p_213281_1_.func_74768_a("SleepingX", p_213338_1_.func_177958_n());
-         p_213281_1_.func_74768_a("SleepingY", p_213338_1_.func_177956_o());
-         p_213281_1_.func_74768_a("SleepingZ", p_213338_1_.func_177952_p());
-      });
-      DataResult<INBT> dataresult = this.field_213378_br.func_233702_a_(NBTDynamicOps.field_210820_a);
-      dataresult.resultOrPartial(field_184243_a::error).ifPresent((p_233636_1_) -> {
-         p_213281_1_.func_218657_a("Brain", p_233636_1_);
-      });
-   }
-
-   public void func_70037_a(CompoundNBT p_70037_1_) {
-      this.func_110149_m(p_70037_1_.func_74760_g("AbsorptionAmount"));
-      if (p_70037_1_.func_150297_b("Attributes", 9) && this.field_70170_p != null && !this.field_70170_p.field_72995_K) {
-         this.func_233645_dx_().func_233788_a_(p_70037_1_.func_150295_c("Attributes", 10));
-      }
-
-      if (p_70037_1_.func_150297_b("ActiveEffects", 9)) {
-         ListNBT listnbt = p_70037_1_.func_150295_c("ActiveEffects", 10);
-
-         for(int i = 0; i < listnbt.size(); ++i) {
-            CompoundNBT compoundnbt = listnbt.func_150305_b(i);
-            EffectInstance effectinstance = EffectInstance.func_82722_b(compoundnbt);
+    private static final UUID field_110156_b = UUID.fromString("662A6B8D-DA3E-4C1C-8813-96EA6097278D");
+    private static final UUID field_233625_c_ = UUID.fromString("87f46a96-686f-4796-b035-22e16ee9e038");
+    private static final UUID SLOW_FALLING_ID = UUID.fromString("A5B6CF2A-2F7C-31EF-9022-7C3E7D5E6ABA");
+    private static final AttributeModifier field_110157_c = new AttributeModifier(field_110156_b, "Sprinting speed boost", 0.3F, AttributeModifier.Operation.MULTIPLY_TOTAL);
+    private static final AttributeModifier SLOW_FALLING = new AttributeModifier(SLOW_FALLING_ID, "Slow falling acceleration reduction", -0.07, AttributeModifier.Operation.ADDITION); // Add -0.07 to 0.08 so we get the vanilla default of 0.01
+    protected static final DataParameter<Byte> field_184621_as = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187191_a);
+    public static final DataParameter<Float> field_184632_c = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187193_c); // private->public CraftBukkit
+    private static final DataParameter<Integer> field_184633_f = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187192_b);
+    private static final DataParameter<Boolean> field_184634_g = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187198_h);
+    public static final DataParameter<Integer> field_184635_h = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187192_b);
+    private static final DataParameter<Integer> field_226291_bp_ = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187192_b);
+    private static final DataParameter<Optional<BlockPos>> field_213379_bs = EntityDataManager.func_187226_a(LivingEntity.class, DataSerializers.field_187201_k);
+    protected static final EntitySize field_213377_as = EntitySize.func_220311_c(0.2F, 0.2F);
+    private final AttributeModifierManager field_110155_d;
+    public CombatTracker field_94063_bt = new CombatTracker(this); // private->public CraftBukkit
+    public final Map<Effect, EffectInstance> field_70713_bf = Maps.newHashMap(); // private->public CraftBukkit
+    private final NonNullList<ItemStack> field_184630_bs = NonNullList.func_191197_a(2, ItemStack.field_190927_a);
+    private final NonNullList<ItemStack> field_184631_bt = NonNullList.func_191197_a(4, ItemStack.field_190927_a);
+    public boolean field_82175_bq;
+    public Hand field_184622_au;
+    public int field_110158_av;
+    public int field_70720_be;
+    public int field_226290_au_;
+    public int field_70737_aN;
+    public int field_70738_aO;
+    public float field_70739_aP;
+    public int field_70725_aQ;
+    public float field_70732_aI;
+    public float field_70733_aJ;
+    protected int field_184617_aD;
+    public float field_184618_aE;
+    public float field_70721_aZ;
+    public float field_184619_aG;
+    public int field_70771_an = 20;
+    public final float field_70769_ao;
+    public final float field_70770_ap;
+    public float field_70761_aq;
+    public float field_70760_ar;
+    public float field_70759_as;
+    public float field_70758_at;
+    public float field_70747_aH = 0.02F;
+    @Nullable
+    public PlayerEntity field_70717_bb;
+    protected int field_70718_bc;
+    protected boolean field_70729_aU;
+    protected int field_70708_bq;
+    protected float field_70768_au;
+    protected float field_110154_aX;
+    protected float field_70764_aw;
+    protected float field_70763_ax;
+    protected float field_70741_aB;
+    protected int field_70744_aE;
+    public float field_110153_bc;
+    protected boolean field_70703_bu;
+    public float field_70702_br;
+    public float field_70701_bs;
+    public float field_191988_bg;
+    protected int field_70716_bi;
+    protected double field_184623_bh;
+    protected double field_184624_bi;
+    protected double field_184625_bj;
+    protected double field_184626_bk;
+    protected double field_70709_bj;
+    protected double field_208001_bq;
+    protected int field_208002_br;
+    public boolean field_70752_e = true;
+    @Nullable
+    public LivingEntity field_70755_b;
+    public int field_70756_c;
+    private LivingEntity field_110150_bn;
+    private int field_142016_bo;
+    private float field_70746_aG;
+    private int field_70773_bE;
+    private float field_110151_bq;
+    protected ItemStack field_184627_bm = ItemStack.field_190927_a;
+    protected int field_184628_bn;
+    protected int field_184629_bo;
+    private BlockPos field_184620_bC;
+    private Optional<BlockPos> field_233624_bE_ = Optional.empty();
+    private DamageSource field_189750_bF;
+    private long field_189751_bG;
+    protected int field_204807_bs;
+    private float field_205017_bL;
+    private float field_205018_bM;
+    protected Brain<?> field_213378_br;
+
+    // CraftBukkit start
+    public int expToDrop;
+    public int maxAirTicks = 300;
+    public boolean forceDrops;
+    public ArrayList<org.bukkit.inventory.ItemStack> drops = new ArrayList<org.bukkit.inventory.ItemStack>();
+    public CraftAttributeMap craftAttributes;
+    public boolean collides = true;
+    public Set<UUID> collidableExemptions = new HashSet<>();
+    public boolean canPickUpLoot;
+
+    public CraftLivingEntity getBukkitLivingEntity() {
+        return (CraftLivingEntity) super.getBukkitEntity();
+    } // Paper
+
+    @Override
+    public float getBukkitYaw() {
+        return func_70079_am();
+    }
+
+    // CraftBukkit end
+    // Spigot start
+    public void inactiveTick() {
+        super.inactiveTick();
+        ++this.field_70708_bq; // Above all the floats
+    }
+    // Spigot end
+
+    protected LivingEntity(EntityType<? extends LivingEntity> p_i48577_1_, World p_i48577_2_) {
+        super(p_i48577_1_, p_i48577_2_);
+        this.field_110155_d = new AttributeModifierManager(GlobalEntityTypeAttributes.func_233835_a_(p_i48577_1_));
+        this.func_70606_j(this.func_110138_aP());
+        this.craftAttributes = new CraftAttributeMap(field_110155_d); // CraftBukkit
+        // CraftBukkit - setHealth(getMaxHealth()) inlined and simplified to skip the instanceof check for EntityPlayer, as getBukkitEntity() is not initialized in constructor
+        this.field_70180_af.func_187227_b(LivingEntity.field_184632_c, (float) this.func_110148_a(Attributes.field_233818_a_).func_111126_e());
+        this.field_70156_m = true;
+        this.field_70770_ap = (float) ((Math.random() + 1.0D) * (double) 0.01F);
+        this.func_226264_Z_();
+        this.field_70769_ao = (float) Math.random() * 12398.0F;
+        this.field_70177_z = (float) (Math.random() * (double) ((float) Math.PI * 2F));
+        this.field_70759_as = this.field_70177_z;
+        this.field_70138_W = 0.6F;
+        NBTDynamicOps nbtdynamicops = NBTDynamicOps.field_210820_a;
+        this.field_213378_br = this.func_213364_a(new Dynamic<>(nbtdynamicops, nbtdynamicops.createMap(ImmutableMap.of(nbtdynamicops.createString("memories"), nbtdynamicops.emptyMap()))));
+    }
+
+    public Brain<?> func_213375_cj() {
+        return this.field_213378_br;
+    }
+
+    protected Brain.BrainCodec<?> func_230289_cH_() {
+        return Brain.func_233705_a_(ImmutableList.of(), ImmutableList.of());
+    }
+
+    protected Brain<?> func_213364_a(Dynamic<?> p_213364_1_) {
+        return this.func_230289_cH_().func_233748_a_(p_213364_1_);
+    }
+
+    public void func_174812_G() {
+        this.func_70097_a(DamageSource.field_76380_i, Float.MAX_VALUE);
+    }
+
+    public boolean func_213358_a(EntityType<?> p_213358_1_) {
+        return true;
+    }
+
+    protected void func_70088_a() {
+        this.field_70180_af.func_187214_a(field_184621_as, (byte) 0);
+        this.field_70180_af.func_187214_a(field_184633_f, 0);
+        this.field_70180_af.func_187214_a(field_184634_g, false);
+        this.field_70180_af.func_187214_a(field_184635_h, 0);
+        this.field_70180_af.func_187214_a(field_226291_bp_, 0);
+        this.field_70180_af.func_187214_a(field_184632_c, 1.0F);
+        this.field_70180_af.func_187214_a(field_213379_bs, Optional.empty());
+    }
+
+    public static AttributeModifierMap.MutableAttribute func_233639_cI_() {
+        return AttributeModifierMap.func_233803_a_().func_233814_a_(Attributes.field_233818_a_).func_233814_a_(Attributes.field_233820_c_).func_233814_a_(Attributes.field_233821_d_).func_233814_a_(Attributes.field_233826_i_).func_233814_a_(Attributes.field_233827_j_).func_233814_a_(net.minecraftforge.common.ForgeMod.SWIM_SPEED.get()).func_233814_a_(net.minecraftforge.common.ForgeMod.NAMETAG_DISTANCE.get()).func_233814_a_(net.minecraftforge.common.ForgeMod.ENTITY_GRAVITY.get());
+    }
+
+    protected void func_184231_a(double p_184231_1_, boolean p_184231_3_, BlockState p_184231_4_, BlockPos p_184231_5_) {
+        if (!this.func_70090_H()) {
+            this.func_233567_aH_();
+        }
+
+        if (!this.field_70170_p.field_72995_K && p_184231_3_ && this.field_70143_R > 0.0F) {
+            this.func_233641_cN_();
+            this.func_233642_cO_();
+        }
+
+        if (!this.field_70170_p.field_72995_K && this.field_70143_R > 3.0F && p_184231_3_) {
+            float f = (float) MathHelper.func_76123_f(this.field_70143_R - 3.0F);
+            if (!p_184231_4_.isAir(field_70170_p, p_184231_5_)) {
+                double d0 = Math.min(0.2F + f / 15.0F, 2.5D);
+                int i = (int) (150.0D * d0);
+                if (!p_184231_4_.addLandingEffects((ServerWorld) this.field_70170_p, p_184231_5_, p_184231_4_, this, i)) {
+                    // CraftBukkit start
+                    if (this instanceof ServerPlayerEntity) {
+                        ((ServerWorld) this.field_70170_p).sendParticles((ServerPlayerEntity) this, new BlockParticleData(ParticleTypes.field_197611_d, p_184231_4_).setPos(p_184231_5_), this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), i, 0.0D, 0.0D, 0.0D, 0.15F, false);
+                    } else {
+                        ((ServerWorld) this.field_70170_p).func_195598_a(new BlockParticleData(ParticleTypes.field_197611_d, p_184231_4_).setPos(p_184231_5_), this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), i, 0.0D, 0.0D, 0.0D, 0.15F);
+                    }
+                    // CraftBukkit end
+                }
+            }
+        }
+
+        super.func_184231_a(p_184231_1_, p_184231_3_, p_184231_4_, p_184231_5_);
+    }
+
+    public boolean func_70648_aU() {
+        return this.func_70668_bt() == CreatureAttribute.field_223223_b_;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public float func_205015_b(float p_205015_1_) {
+        return MathHelper.func_219799_g(p_205015_1_, this.field_205018_bM, this.field_205017_bL);
+    }
+
+    public void func_70030_z() {
+        this.field_70732_aI = this.field_70733_aJ;
+        if (this.field_70148_d) {
+            this.func_213374_dv().ifPresent(this::func_213370_a);
+        }
+
+        if (this.func_230490_cK_()) {
+            this.func_233640_cL_();
+        }
+
+        super.func_70030_z();
+        this.field_70170_p.func_217381_Z().func_76320_a("livingEntityBaseTick");
+        boolean flag = this instanceof PlayerEntity;
+        if (this.func_70089_S()) {
+            if (this.func_70094_T()) {
+                this.func_70097_a(DamageSource.field_76368_d, 1.0F);
+            } else if (flag && !this.field_70170_p.func_175723_af().func_177743_a(this.func_174813_aQ())) {
+                double d0 = this.field_70170_p.func_175723_af().func_177745_a(this) + this.field_70170_p.func_175723_af().func_177742_m();
+                if (d0 < 0.0D) {
+                    double d1 = this.field_70170_p.func_175723_af().func_177727_n();
+                    if (d1 > 0.0D) {
+                        this.func_70097_a(DamageSource.field_76368_d, (float) Math.max(1, MathHelper.func_76128_c(-d0 * d1)));
+                    }
+                }
+            }
+        }
+
+        if (this.func_230279_az_() || this.field_70170_p.field_72995_K) {
+            this.func_70066_B();
+        }
+
+        boolean flag1 = flag && ((PlayerEntity) this).field_71075_bZ.field_75102_a;
+        if (this.func_70089_S()) {
+            if (this.func_208600_a(FluidTags.field_206959_a) && !this.field_70170_p.func_180495_p(new BlockPos(this.func_226277_ct_(), this.func_226280_cw_(), this.func_226281_cx_())).func_203425_a(Blocks.field_203203_C)) {
+                if (!this.func_70648_aU() && !EffectUtils.func_205133_c(this) && !flag1) {
+                    this.func_70050_g(this.func_70682_h(this.func_70086_ai()));
+                    if (this.func_70086_ai() == -20) {
+                        this.func_70050_g(0);
+                        Vector3d vector3d = this.func_213322_ci();
+
+                        for (int i = 0; i < 8; ++i) {
+                            double d2 = this.field_70146_Z.nextDouble() - this.field_70146_Z.nextDouble();
+                            double d3 = this.field_70146_Z.nextDouble() - this.field_70146_Z.nextDouble();
+                            double d4 = this.field_70146_Z.nextDouble() - this.field_70146_Z.nextDouble();
+                            this.field_70170_p.func_195594_a(ParticleTypes.field_197612_e, this.func_226277_ct_() + d2, this.func_226278_cu_() + d3, this.func_226281_cx_() + d4, vector3d.field_72450_a, vector3d.field_72448_b, vector3d.field_72449_c);
+                        }
+
+                        this.func_70097_a(DamageSource.field_76369_e, 2.0F);
+                    }
+                }
+
+                if (!this.field_70170_p.field_72995_K && this.func_184218_aH() && this.func_184187_bx() != null && !this.func_184187_bx().canBeRiddenInWater(this)) {
+                    this.func_184210_p();
+                }
+            } else if (this.func_70086_ai() < this.func_205010_bg()) {
+                this.func_70050_g(this.func_207300_l(this.func_70086_ai()));
+            }
+
+            if (!this.field_70170_p.field_72995_K) {
+                BlockPos blockpos = this.func_233580_cy_();
+                if (!Objects.equal(this.field_184620_bC, blockpos)) {
+                    this.field_184620_bC = blockpos;
+                    this.func_184594_b(blockpos);
+                }
+            }
+        }
+
+        if (this.func_70089_S() && this.func_203008_ap()) {
+            this.func_70066_B();
+        }
+
+        if (this.field_70737_aN > 0) {
+            --this.field_70737_aN;
+        }
+
+        if (this.field_70172_ad > 0 && !(this instanceof ServerPlayerEntity)) {
+            --this.field_70172_ad;
+        }
+
+        if (this.func_233643_dh_()) {
+            this.func_70609_aI();
+        }
+
+        if (this.field_70718_bc > 0) {
+            --this.field_70718_bc;
+        } else {
+            this.field_70717_bb = null;
+        }
+
+        if (this.field_110150_bn != null && !this.field_110150_bn.func_70089_S()) {
+            this.field_110150_bn = null;
+        }
+
+        if (this.field_70755_b != null) {
+            if (!this.field_70755_b.func_70089_S()) {
+                this.func_70604_c(null);
+            } else if (this.field_70173_aa - this.field_70756_c > 100) {
+                this.func_70604_c(null);
+            }
+        }
+
+        this.func_70679_bo();
+        this.field_70763_ax = this.field_70764_aw;
+        this.field_70760_ar = this.field_70761_aq;
+        this.field_70758_at = this.field_70759_as;
+        this.field_70126_B = this.field_70177_z;
+        this.field_70127_C = this.field_70125_A;
+        this.field_70170_p.func_217381_Z().func_76319_b();
+    }
+
+    public boolean func_230490_cK_() {
+        return this.field_70173_aa % 5 == 0 && this.func_213322_ci().field_72450_a != 0.0D && this.func_213322_ci().field_72449_c != 0.0D && !this.func_175149_v() && EnchantmentHelper.func_234846_j_(this) && this.func_230296_cM_();
+    }
+
+    protected void func_233640_cL_() {
+        Vector3d vector3d = this.func_213322_ci();
+        this.field_70170_p.func_195594_a(ParticleTypes.field_239812_C_, this.func_226277_ct_() + (this.field_70146_Z.nextDouble() - 0.5D) * (double) this.func_213311_cf(), this.func_226278_cu_() + 0.1D, this.func_226281_cx_() + (this.field_70146_Z.nextDouble() - 0.5D) * (double) this.func_213311_cf(), vector3d.field_72450_a * -0.2D, 0.1D, vector3d.field_72449_c * -0.2D);
+        float f = this.field_70146_Z.nextFloat() * 0.4F + this.field_70146_Z.nextFloat() > 0.9F ? 0.6F : 0.0F;
+        this.func_184185_a(SoundEvents.field_232831_nS_, f, 0.6F + this.field_70146_Z.nextFloat() * 0.4F);
+    }
+
+    protected boolean func_230296_cM_() {
+        return this.field_70170_p.func_180495_p(this.func_226270_aj_()).func_235714_a_(BlockTags.field_232876_aq_);
+    }
+
+    protected float func_225515_ai_() {
+        return this.func_230296_cM_() && EnchantmentHelper.func_185284_a(Enchantments.field_234847_l_, this) > 0 ? 1.0F : super.func_225515_ai_();
+    }
+
+    protected boolean func_230295_b_(BlockState p_230295_1_) {
+        return !p_230295_1_.func_196958_f() || this.func_184613_cA();
+    }
+
+    protected void func_233641_cN_() {
+        ModifiableAttributeInstance modifiableattributeinstance = this.func_110148_a(Attributes.field_233821_d_);
+        if (modifiableattributeinstance != null) {
+            if (modifiableattributeinstance.func_111127_a(field_233625_c_) != null) {
+                modifiableattributeinstance.func_188479_b(field_233625_c_);
+            }
+
+        }
+    }
+
+    protected void func_233642_cO_() {
+        if (!this.func_233568_aJ_().func_196958_f()) {
+            int i = EnchantmentHelper.func_185284_a(Enchantments.field_234847_l_, this);
+            if (i > 0 && this.func_230296_cM_()) {
+                ModifiableAttributeInstance modifiableattributeinstance = this.func_110148_a(Attributes.field_233821_d_);
+                if (modifiableattributeinstance == null) {
+                    return;
+                }
+
+                modifiableattributeinstance.func_233767_b_(new AttributeModifier(field_233625_c_, "Soul speed boost", 0.03F * (1.0F + (float) i * 0.35F), AttributeModifier.Operation.ADDITION));
+                if (this.func_70681_au().nextFloat() < 0.04F) {
+                    ItemStack itemstack = this.func_184582_a(EquipmentSlotType.FEET);
+                    itemstack.func_222118_a(1, this, (p_233654_0_) -> {
+                        p_233654_0_.func_213361_c(EquipmentSlotType.FEET);
+                    });
+                }
+            }
+        }
+
+    }
+
+    protected void func_184594_b(BlockPos p_184594_1_) {
+        int i = EnchantmentHelper.func_185284_a(Enchantments.field_185301_j, this);
+        if (i > 0) {
+            FrostWalkerEnchantment.func_185266_a(this, this.field_70170_p, p_184594_1_, i);
+        }
+
+        if (this.func_230295_b_(this.func_233568_aJ_())) {
+            this.func_233641_cN_();
+        }
+
+        this.func_233642_cO_();
+    }
+
+    public boolean func_70631_g_() {
+        return false;
+    }
+
+    public float func_213355_cm() {
+        return this.func_70631_g_() ? 0.5F : 1.0F;
+    }
+
+    protected boolean func_241208_cS_() {
+        return true;
+    }
+
+    public boolean func_205710_ba() {
+        return false;
+    }
+
+    protected void func_70609_aI() {
+        ++this.field_70725_aQ;
+        if (this.field_70725_aQ >= 20 && !this.field_70128_L) { // CraftBukkit - (this.deathTime == 20) -> (this.deathTime >= 20 && !this.removed)
+            this.remove(this instanceof net.minecraft.entity.player.ServerPlayerEntity); //Forge keep data until we revive player
+
+            for (int i = 0; i < 20; ++i) {
+                double d0 = this.field_70146_Z.nextGaussian() * 0.02D;
+                double d1 = this.field_70146_Z.nextGaussian() * 0.02D;
+                double d2 = this.field_70146_Z.nextGaussian() * 0.02D;
+                this.field_70170_p.func_195594_a(ParticleTypes.field_197598_I, this.func_226282_d_(1.0D), this.func_226279_cv_(), this.func_226287_g_(1.0D), d0, d1, d2);
+            }
+        }
+
+    }
+
+    protected boolean func_146066_aG() {
+        return !this.func_70631_g_();
+    }
+
+    protected boolean func_230282_cS_() {
+        return !this.func_70631_g_();
+    }
+
+    protected int func_70682_h(int p_70682_1_) {
+        int i = EnchantmentHelper.func_185292_c(this);
+        return i > 0 && this.field_70146_Z.nextInt(i + 1) > 0 ? p_70682_1_ : p_70682_1_ - 1;
+    }
+
+    protected int func_207300_l(int p_207300_1_) {
+        return Math.min(p_207300_1_ + 4, this.func_205010_bg());
+    }
+
+    protected int func_70693_a(PlayerEntity p_70693_1_) {
+        return 0;
+    }
+
+    protected boolean func_70684_aJ() {
+        return false;
+    }
+
+    public Random func_70681_au() {
+        return this.field_70146_Z;
+    }
+
+    @Nullable
+    public LivingEntity func_70643_av() {
+        return this.field_70755_b;
+    }
+
+    public int func_142015_aE() {
+        return this.field_70756_c;
+    }
+
+    public void func_230246_e_(@Nullable PlayerEntity p_230246_1_) {
+        this.field_70717_bb = p_230246_1_;
+        this.field_70718_bc = this.field_70173_aa;
+    }
+
+    public void func_70604_c(@Nullable LivingEntity p_70604_1_) {
+        this.field_70755_b = p_70604_1_;
+        this.field_70756_c = this.field_70173_aa;
+    }
+
+    @Nullable
+    public LivingEntity func_110144_aD() {
+        return this.field_110150_bn;
+    }
+
+    public int func_142013_aG() {
+        return this.field_142016_bo;
+    }
+
+    public void func_130011_c(Entity p_130011_1_) {
+        if (p_130011_1_ instanceof LivingEntity) {
+            this.field_110150_bn = (LivingEntity) p_130011_1_;
+        } else {
+            this.field_110150_bn = null;
+        }
+
+        this.field_142016_bo = this.field_70173_aa;
+    }
+
+    public int func_70654_ax() {
+        return this.field_70708_bq;
+    }
+
+    public void func_213332_m(int p_213332_1_) {
+        this.field_70708_bq = p_213332_1_;
+    }
+
+    protected void func_184606_a_(ItemStack p_184606_1_) {
+        this.playEquipSound(p_184606_1_, false);
+    }
+
+    protected void playEquipSound(ItemStack stack, boolean silent) {
+        if (!stack.func_190926_b() && !silent) {
+            SoundEvent soundevent = SoundEvents.field_187719_p;
+            Item item = stack.func_77973_b();
+            if (item instanceof ArmorItem) {
+                soundevent = ((ArmorItem) item).func_200880_d().func_200899_b();
+            } else if (item == Items.field_185160_cR) {
+                soundevent = SoundEvents.field_191258_p;
+            }
+
+            this.func_184185_a(soundevent, 1.0F, 1.0F);
+        }
+    }
+
+    public void func_213281_b(CompoundNBT p_213281_1_) {
+        p_213281_1_.func_74776_a("Health", this.func_110143_aJ());
+        p_213281_1_.func_74777_a("HurtTime", (short) this.field_70737_aN);
+        p_213281_1_.func_74768_a("HurtByTimestamp", this.field_70756_c);
+        p_213281_1_.func_74777_a("DeathTime", (short) this.field_70725_aQ);
+        p_213281_1_.func_74776_a("AbsorptionAmount", this.func_110139_bj());
+        p_213281_1_.func_218657_a("Attributes", this.func_233645_dx_().func_233794_c_());
+        if (!this.field_70713_bf.isEmpty()) {
+            ListNBT listnbt = new ListNBT();
+
+            for (EffectInstance effectinstance : this.field_70713_bf.values()) {
+                listnbt.add(effectinstance.func_82719_a(new CompoundNBT()));
+            }
+
+            p_213281_1_.func_218657_a("ActiveEffects", listnbt);
+        }
+
+        p_213281_1_.func_74757_a("FallFlying", this.func_184613_cA());
+        this.func_213374_dv().ifPresent((p_213338_1_) -> {
+            p_213281_1_.func_74768_a("SleepingX", p_213338_1_.func_177958_n());
+            p_213281_1_.func_74768_a("SleepingY", p_213338_1_.func_177956_o());
+            p_213281_1_.func_74768_a("SleepingZ", p_213338_1_.func_177952_p());
+        });
+        DataResult<INBT> dataresult = this.field_213378_br.func_233702_a_(NBTDynamicOps.field_210820_a);
+        dataresult.resultOrPartial(field_184243_a::error).ifPresent((p_233636_1_) -> {
+            p_213281_1_.func_218657_a("Brain", p_233636_1_);
+        });
+    }
+
+    public void func_70037_a(CompoundNBT p_70037_1_) {
+        this.func_110149_m(p_70037_1_.func_74760_g("AbsorptionAmount"));
+        if (p_70037_1_.func_150297_b("Attributes", 9) && this.field_70170_p != null && !this.field_70170_p.field_72995_K) {
+            this.func_233645_dx_().func_233788_a_(p_70037_1_.func_150295_c("Attributes", 10));
+        }
+
+        if (p_70037_1_.func_150297_b("ActiveEffects", 9)) {
+            ListNBT listnbt = p_70037_1_.func_150295_c("ActiveEffects", 10);
+
+            for (int i = 0; i < listnbt.size(); ++i) {
+                CompoundNBT compoundnbt = listnbt.func_150305_b(i);
+                EffectInstance effectinstance = EffectInstance.func_82722_b(compoundnbt);
+                if (effectinstance != null) {
+                    this.field_70713_bf.put(effectinstance.func_188419_a(), effectinstance);
+                }
+            }
+        }
+
+        // CraftBukkit start
+        if (p_70037_1_.func_74764_b("Bukkit.MaxHealth")) {
+            INBT nbtbase = p_70037_1_.func_74781_a("Bukkit.MaxHealth");
+            if (nbtbase.func_74732_a() == 5) {
+                this.func_110148_a(Attributes.field_233818_a_).func_111128_a(((FloatNBT) nbtbase).func_150286_g());
+            } else if (nbtbase.func_74732_a() == 3) {
+                this.func_110148_a(Attributes.field_233818_a_).func_111128_a(((IntNBT) nbtbase).func_150286_g());
+            }
+        }
+        // CraftBukkit end
+
+        if (p_70037_1_.func_150297_b("Health", 99)) {
+            this.func_70606_j(p_70037_1_.func_74760_g("Health"));
+        }
+
+        this.field_70737_aN = p_70037_1_.func_74765_d("HurtTime");
+        this.field_70725_aQ = p_70037_1_.func_74765_d("DeathTime");
+        this.field_70756_c = p_70037_1_.func_74762_e("HurtByTimestamp");
+        if (p_70037_1_.func_150297_b("Team", 8)) {
+            String s = p_70037_1_.func_74779_i("Team");
+            ScorePlayerTeam scoreplayerteam = this.field_70170_p.func_96441_U().func_96508_e(s);
+            boolean flag = scoreplayerteam != null && this.field_70170_p.func_96441_U().func_197901_a(this.func_189512_bd(), scoreplayerteam);
+            if (!flag) {
+                field_184243_a.warn(com.mohistmc.util.i18n.i18n.get("livingentity.1", s));
+            }
+        }
+
+        if (p_70037_1_.func_74767_n("FallFlying")) {
+            this.func_70052_a(7, true);
+        }
+
+        if (p_70037_1_.func_150297_b("SleepingX", 99) && p_70037_1_.func_150297_b("SleepingY", 99) && p_70037_1_.func_150297_b("SleepingZ", 99)) {
+            BlockPos blockpos = new BlockPos(p_70037_1_.func_74762_e("SleepingX"), p_70037_1_.func_74762_e("SleepingY"), p_70037_1_.func_74762_e("SleepingZ"));
+            this.func_213369_d(blockpos);
+            this.field_70180_af.func_187227_b(field_213330_X, Pose.SLEEPING);
+            if (!this.field_70148_d) {
+                this.func_213370_a(blockpos);
+            }
+        }
+
+        if (p_70037_1_.func_150297_b("Brain", 10)) {
+            this.field_213378_br = this.func_213364_a(new Dynamic<>(NBTDynamicOps.field_210820_a, p_70037_1_.func_74781_a("Brain")));
+        }
+
+    }
+
+    // CraftBukkit start
+    private boolean isTickingEffects = false;
+    private final List<ProcessableEffect> effectsToProcess = Lists.newArrayList();
+
+    private static class ProcessableEffect {
+
+        private Effect type;
+        private EffectInstance effect;
+        private final EntityPotionEffectEvent.Cause cause;
+
+        private ProcessableEffect(EffectInstance effect, EntityPotionEffectEvent.Cause cause) {
+            this.effect = effect;
+            this.cause = cause;
+        }
+
+        private ProcessableEffect(Effect type, EntityPotionEffectEvent.Cause cause) {
+            this.type = type;
+            this.cause = cause;
+        }
+    }
+    // CraftBukkit end
+
+    protected void func_70679_bo() {
+        Iterator<Effect> iterator = this.field_70713_bf.keySet().iterator();
+
+        isTickingEffects = true; // CraftBukkit
+        try {
+            while (iterator.hasNext()) {
+                Effect effect = iterator.next();
+                EffectInstance effectinstance = this.field_70713_bf.get(effect);
+                if (!effectinstance.func_76455_a(this, () -> {
+                    this.func_70695_b(effectinstance, true);
+                })) {
+                    if (!this.field_70170_p.field_72995_K && !net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.living.PotionEvent.PotionExpiryEvent(this, effectinstance))) {
+                        // CraftBukkit start
+                        EntityPotionEffectEvent event = CraftEventFactory.callEntityPotionEffectChangeEvent(this, effectinstance, null, org.bukkit.event.entity.EntityPotionEffectEvent.Cause.EXPIRATION);
+                        if (event.isCancelled()) {
+                            continue;
+                        }
+                        // CraftBukkit end
+                        iterator.remove();
+                        this.func_70688_c(effectinstance);
+                    }
+                } else if (effectinstance.func_76459_b() % 600 == 0) {
+                    this.func_70695_b(effectinstance, false);
+                }
+            }
+        } catch (ConcurrentModificationException concurrentmodificationexception) {
+        }
+        // CraftBukkit start
+        isTickingEffects = false;
+        for (ProcessableEffect e : effectsToProcess) {
+            if (e.effect != null) {
+                addEffect(e.effect, e.cause);
+            } else {
+                removeEffect(e.type, e.cause);
+            }
+        }
+        effectsToProcess.clear();
+        // CraftBukkit end
+
+        if (this.field_70752_e) {
+            if (!this.field_70170_p.field_72995_K) {
+                this.func_175135_B();
+            }
+
+            this.field_70752_e = false;
+        }
+
+        int i = this.field_70180_af.func_187225_a(field_184633_f);
+        boolean flag1 = this.field_70180_af.func_187225_a(field_184634_g);
+        if (i > 0) {
+            boolean flag;
+            if (this.func_82150_aj()) {
+                flag = this.field_70146_Z.nextInt(15) == 0;
+            } else {
+                flag = this.field_70146_Z.nextBoolean();
+            }
+
+            if (flag1) {
+                flag &= this.field_70146_Z.nextInt(5) == 0;
+            }
+
+            if (flag && i > 0) {
+                double d0 = (double) (i >> 16 & 255) / 255.0D;
+                double d1 = (double) (i >> 8 & 255) / 255.0D;
+                double d2 = (double) (i >> 0 & 255) / 255.0D;
+                this.field_70170_p.func_195594_a(flag1 ? ParticleTypes.field_197608_a : ParticleTypes.field_197625_r, this.func_226282_d_(0.5D), this.func_226279_cv_(), this.func_226287_g_(0.5D), d0, d1, d2);
+            }
+        }
+
+    }
+
+    protected void func_175135_B() {
+        if (this.field_70713_bf.isEmpty()) {
+            this.func_175133_bi();
+            this.func_82142_c(false);
+        } else {
+            Collection<EffectInstance> collection = this.field_70713_bf.values();
+            net.minecraftforge.event.entity.living.PotionColorCalculationEvent event = new net.minecraftforge.event.entity.living.PotionColorCalculationEvent(this, PotionUtils.func_185181_a(collection), func_184593_a(collection), collection);
+            net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(event);
+            this.field_70180_af.func_187227_b(field_184634_g, event.areParticlesHidden());
+            this.field_70180_af.func_187227_b(field_184633_f, event.getColor());
+            this.func_82142_c(this.func_70644_a(Effects.field_76441_p));
+        }
+
+    }
+
+    public double func_213340_A(@Nullable Entity p_213340_1_) {
+        double d0 = 1.0D;
+        if (this.func_226273_bm_()) {
+            d0 *= 0.8D;
+        }
+
+        if (this.func_82150_aj()) {
+            float f = this.func_213343_cS();
+            if (f < 0.1F) {
+                f = 0.1F;
+            }
+
+            d0 *= 0.7D * (double) f;
+        }
+
+        if (p_213340_1_ != null) {
+            ItemStack itemstack = this.func_184582_a(EquipmentSlotType.HEAD);
+            Item item = itemstack.func_77973_b();
+            EntityType<?> entitytype = p_213340_1_.func_200600_R();
+            if (entitytype == EntityType.field_200741_ag && item == Items.field_196182_dv || entitytype == EntityType.field_200725_aD && item == Items.field_196186_dz || entitytype == EntityType.field_200797_k && item == Items.field_196185_dy) {
+                d0 *= 0.5D;
+            }
+        }
+
+        d0 = net.minecraftforge.common.ForgeHooks.getEntityVisibilityMultiplier(this, p_213340_1_, d0);
+        return d0;
+    }
+
+    public boolean func_213336_c(LivingEntity p_213336_1_) {
+        return true;
+    }
+
+    public boolean func_213344_a(LivingEntity p_213344_1_, EntityPredicate p_213344_2_) {
+        return p_213344_2_.func_221015_a(this, p_213344_1_);
+    }
+
+    public static boolean func_184593_a(Collection<EffectInstance> p_184593_0_) {
+        for (EffectInstance effectinstance : p_184593_0_) {
+            if (!effectinstance.func_82720_e()) {
+                return false;
+            }
+        }
+
+        return true;
+    }
+
+    protected void func_175133_bi() {
+        this.field_70180_af.func_187227_b(field_184634_g, false);
+        this.field_70180_af.func_187227_b(field_184633_f, 0);
+    }
+
+    // CraftBukkit start
+    public boolean func_195061_cb() {
+        return clearActivePotions(org.bukkit.event.entity.EntityPotionEffectEvent.Cause.UNKNOWN);
+    }
+
+    public boolean clearActivePotions(EntityPotionEffectEvent.Cause cause) {
+        // CraftBukkit end
+        if (this.field_70170_p.field_72995_K) {
+            return false;
+        } else {
+            Iterator<EffectInstance> iterator = this.field_70713_bf.values().iterator();
+
+            boolean flag;
+            for (flag = false; iterator.hasNext(); flag = true) {
+                // CraftBukkit start
+                EffectInstance effect = iterator.next();
+                EntityPotionEffectEvent event = CraftEventFactory.callEntityPotionEffectChangeEvent(this, effect, null, cause, EntityPotionEffectEvent.Action.CLEARED);
+                if (event.isCancelled()) {
+                    continue;
+                }
+                // CraftBukkit end
+                if (net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.living.PotionEvent.PotionRemoveEvent(this, effect)))
+                    continue;
+                this.func_70688_c(effect);
+                iterator.remove();
+            }
+
+            return flag;
+        }
+    }
+
+    public Collection<EffectInstance> func_70651_bq() {
+        return this.field_70713_bf.values();
+    }
+
+    public Map<Effect, EffectInstance> func_193076_bZ() {
+        return this.field_70713_bf;
+    }
+
+    public boolean func_70644_a(Effect p_70644_1_) {
+        return this.field_70713_bf.containsKey(p_70644_1_);
+    }
+
+    @Nullable
+    public EffectInstance func_70660_b(Effect p_70660_1_) {
+        return this.field_70713_bf.get(p_70660_1_);
+    }
+
+    public boolean func_195064_c(EffectInstance p_195064_1_) {
+        // CraftBkkit start
+        return addEffect(p_195064_1_, org.bukkit.event.entity.EntityPotionEffectEvent.Cause.UNKNOWN);
+    }
+
+    public boolean addEffect(EffectInstance effectInstanceIn, EntityPotionEffectEvent.Cause cause) {
+        if (isTickingEffects) {
+            effectsToProcess.add(new ProcessableEffect(effectInstanceIn, cause));
+            return true;
+        }
+        // CraftBukkit end
+        if (!this.func_70687_e(effectInstanceIn)) {
+            return false;
+        } else {
+            EffectInstance effectinstance = this.field_70713_bf.get(effectInstanceIn.func_188419_a());
+            net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.living.PotionEvent.PotionAddedEvent(this, effectinstance, effectInstanceIn));
+
+            // CraftBukkit start
+            boolean override = false;
             if (effectinstance != null) {
-               this.field_70713_bf.put(effectinstance.func_188419_a(), effectinstance);
-            }
-         }
-      }
-
-      if (p_70037_1_.func_150297_b("Health", 99)) {
-         this.func_70606_j(p_70037_1_.func_74760_g("Health"));
-      }
-
-      this.field_70737_aN = p_70037_1_.func_74765_d("HurtTime");
-      this.field_70725_aQ = p_70037_1_.func_74765_d("DeathTime");
-      this.field_70756_c = p_70037_1_.func_74762_e("HurtByTimestamp");
-      if (p_70037_1_.func_150297_b("Team", 8)) {
-         String s = p_70037_1_.func_74779_i("Team");
-         ScorePlayerTeam scoreplayerteam = this.field_70170_p.func_96441_U().func_96508_e(s);
-         boolean flag = scoreplayerteam != null && this.field_70170_p.func_96441_U().func_197901_a(this.func_189512_bd(), scoreplayerteam);
-         if (!flag) {
-            field_184243_a.warn("Unable to add mob to team \"{}\" (that team probably doesn't exist)", (Object)s);
-         }
-      }
-
-      if (p_70037_1_.func_74767_n("FallFlying")) {
-         this.func_70052_a(7, true);
-      }
-
-      if (p_70037_1_.func_150297_b("SleepingX", 99) && p_70037_1_.func_150297_b("SleepingY", 99) && p_70037_1_.func_150297_b("SleepingZ", 99)) {
-         BlockPos blockpos = new BlockPos(p_70037_1_.func_74762_e("SleepingX"), p_70037_1_.func_74762_e("SleepingY"), p_70037_1_.func_74762_e("SleepingZ"));
-         this.func_213369_d(blockpos);
-         this.field_70180_af.func_187227_b(field_213330_X, Pose.SLEEPING);
-         if (!this.field_70148_d) {
-            this.func_213370_a(blockpos);
-         }
-      }
-
-      if (p_70037_1_.func_150297_b("Brain", 10)) {
-         this.field_213378_br = this.func_213364_a(new Dynamic<>(NBTDynamicOps.field_210820_a, p_70037_1_.func_74781_a("Brain")));
-      }
-
-   }
-
-   protected void func_70679_bo() {
-      Iterator<Effect> iterator = this.field_70713_bf.keySet().iterator();
-
-      try {
-         while(iterator.hasNext()) {
-            Effect effect = iterator.next();
-            EffectInstance effectinstance = this.field_70713_bf.get(effect);
-            if (!effectinstance.func_76455_a(this, () -> {
-               this.func_70695_b(effectinstance, true);
-            })) {
-               if (!this.field_70170_p.field_72995_K) {
-                  iterator.remove();
-                  this.func_70688_c(effectinstance);
-               }
-            } else if (effectinstance.func_76459_b() % 600 == 0) {
-               this.func_70695_b(effectinstance, false);
-            }
-         }
-      } catch (ConcurrentModificationException concurrentmodificationexception) {
-      }
-
-      if (this.field_70752_e) {
-         if (!this.field_70170_p.field_72995_K) {
-            this.func_175135_B();
-         }
-
-         this.field_70752_e = false;
-      }
-
-      int i = this.field_70180_af.func_187225_a(field_184633_f);
-      boolean flag1 = this.field_70180_af.func_187225_a(field_184634_g);
-      if (i > 0) {
-         boolean flag;
-         if (this.func_82150_aj()) {
-            flag = this.field_70146_Z.nextInt(15) == 0;
-         } else {
-            flag = this.field_70146_Z.nextBoolean();
-         }
-
-         if (flag1) {
-            flag &= this.field_70146_Z.nextInt(5) == 0;
-         }
-
-         if (flag && i > 0) {
-            double d0 = (double)(i >> 16 & 255) / 255.0D;
-            double d1 = (double)(i >> 8 & 255) / 255.0D;
-            double d2 = (double)(i >> 0 & 255) / 255.0D;
-            this.field_70170_p.func_195594_a(flag1 ? ParticleTypes.field_197608_a : ParticleTypes.field_197625_r, this.func_226282_d_(0.5D), this.func_226279_cv_(), this.func_226287_g_(0.5D), d0, d1, d2);
-         }
-      }
-
-   }
-
-   protected void func_175135_B() {
-      if (this.field_70713_bf.isEmpty()) {
-         this.func_175133_bi();
-         this.func_82142_c(false);
-      } else {
-         Collection<EffectInstance> collection = this.field_70713_bf.values();
-         this.field_70180_af.func_187227_b(field_184634_g, func_184593_a(collection));
-         this.field_70180_af.func_187227_b(field_184633_f, PotionUtils.func_185181_a(collection));
-         this.func_82142_c(this.func_70644_a(Effects.field_76441_p));
-      }
-
-   }
-
-   public double func_213340_A(@Nullable Entity p_213340_1_) {
-      double d0 = 1.0D;
-      if (this.func_226273_bm_()) {
-         d0 *= 0.8D;
-      }
-
-      if (this.func_82150_aj()) {
-         float f = this.func_213343_cS();
-         if (f < 0.1F) {
-            f = 0.1F;
-         }
-
-         d0 *= 0.7D * (double)f;
-      }
-
-      if (p_213340_1_ != null) {
-         ItemStack itemstack = this.func_184582_a(EquipmentSlotType.HEAD);
-         Item item = itemstack.func_77973_b();
-         EntityType<?> entitytype = p_213340_1_.func_200600_R();
-         if (entitytype == EntityType.field_200741_ag && item == Items.field_196182_dv || entitytype == EntityType.field_200725_aD && item == Items.field_196186_dz || entitytype == EntityType.field_200797_k && item == Items.field_196185_dy) {
-            d0 *= 0.5D;
-         }
-      }
-
-      return d0;
-   }
-
-   public boolean func_213336_c(LivingEntity p_213336_1_) {
-      return true;
-   }
-
-   public boolean func_213344_a(LivingEntity p_213344_1_, EntityPredicate p_213344_2_) {
-      return p_213344_2_.func_221015_a(this, p_213344_1_);
-   }
-
-   public static boolean func_184593_a(Collection<EffectInstance> p_184593_0_) {
-      for(EffectInstance effectinstance : p_184593_0_) {
-         if (!effectinstance.func_82720_e()) {
-            return false;
-         }
-      }
-
-      return true;
-   }
-
-   protected void func_175133_bi() {
-      this.field_70180_af.func_187227_b(field_184634_g, false);
-      this.field_70180_af.func_187227_b(field_184633_f, 0);
-   }
-
-   public boolean func_195061_cb() {
-      if (this.field_70170_p.field_72995_K) {
-         return false;
-      } else {
-         Iterator<EffectInstance> iterator = this.field_70713_bf.values().iterator();
-
-         boolean flag;
-         for(flag = false; iterator.hasNext(); flag = true) {
-            this.func_70688_c(iterator.next());
-            iterator.remove();
-         }
-
-         return flag;
-      }
-   }
-
-   public Collection<EffectInstance> func_70651_bq() {
-      return this.field_70713_bf.values();
-   }
-
-   public Map<Effect, EffectInstance> func_193076_bZ() {
-      return this.field_70713_bf;
-   }
-
-   public boolean func_70644_a(Effect p_70644_1_) {
-      return this.field_70713_bf.containsKey(p_70644_1_);
-   }
-
-   @Nullable
-   public EffectInstance func_70660_b(Effect p_70660_1_) {
-      return this.field_70713_bf.get(p_70660_1_);
-   }
-
-   public boolean func_195064_c(EffectInstance p_195064_1_) {
-      if (!this.func_70687_e(p_195064_1_)) {
-         return false;
-      } else {
-         EffectInstance effectinstance = this.field_70713_bf.get(p_195064_1_.func_188419_a());
-         if (effectinstance == null) {
-            this.field_70713_bf.put(p_195064_1_.func_188419_a(), p_195064_1_);
-            this.func_70670_a(p_195064_1_);
-            return true;
-         } else if (effectinstance.func_199308_a(p_195064_1_)) {
-            this.func_70695_b(effectinstance, true);
-            return true;
-         } else {
-            return false;
-         }
-      }
-   }
-
-   public boolean func_70687_e(EffectInstance p_70687_1_) {
-      if (this.func_70668_bt() == CreatureAttribute.field_223223_b_) {
-         Effect effect = p_70687_1_.func_188419_a();
-         if (effect == Effects.field_76428_l || effect == Effects.field_76436_u) {
-            return false;
-         }
-      }
-
-      return true;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public void func_233646_e_(EffectInstance p_233646_1_) {
-      if (this.func_70687_e(p_233646_1_)) {
-         EffectInstance effectinstance = this.field_70713_bf.put(p_233646_1_.func_188419_a(), p_233646_1_);
-         if (effectinstance == null) {
-            this.func_70670_a(p_233646_1_);
-         } else {
-            this.func_70695_b(p_233646_1_, true);
-         }
-
-      }
-   }
-
-   public boolean func_70662_br() {
-      return this.func_70668_bt() == CreatureAttribute.field_223223_b_;
-   }
-
-   @Nullable
-   public EffectInstance func_184596_c(@Nullable Effect p_184596_1_) {
-      return this.field_70713_bf.remove(p_184596_1_);
-   }
-
-   public boolean func_195063_d(Effect p_195063_1_) {
-      EffectInstance effectinstance = this.func_184596_c(p_195063_1_);
-      if (effectinstance != null) {
-         this.func_70688_c(effectinstance);
-         return true;
-      } else {
-         return false;
-      }
-   }
-
-   protected void func_70670_a(EffectInstance p_70670_1_) {
-      this.field_70752_e = true;
-      if (!this.field_70170_p.field_72995_K) {
-         p_70670_1_.func_188419_a().func_111185_a(this, this.func_233645_dx_(), p_70670_1_.func_76458_c());
-      }
-
-   }
-
-   protected void func_70695_b(EffectInstance p_70695_1_, boolean p_70695_2_) {
-      this.field_70752_e = true;
-      if (p_70695_2_ && !this.field_70170_p.field_72995_K) {
-         Effect effect = p_70695_1_.func_188419_a();
-         effect.func_111187_a(this, this.func_233645_dx_(), p_70695_1_.func_76458_c());
-         effect.func_111185_a(this, this.func_233645_dx_(), p_70695_1_.func_76458_c());
-      }
-
-   }
-
-   protected void func_70688_c(EffectInstance p_70688_1_) {
-      this.field_70752_e = true;
-      if (!this.field_70170_p.field_72995_K) {
-         p_70688_1_.func_188419_a().func_111187_a(this, this.func_233645_dx_(), p_70688_1_.func_76458_c());
-      }
-
-   }
-
-   public void func_70691_i(float p_70691_1_) {
-      float f = this.func_110143_aJ();
-      if (f > 0.0F) {
-         this.func_70606_j(f + p_70691_1_);
-      }
-
-   }
-
-   public float func_110143_aJ() {
-      return this.field_70180_af.func_187225_a(field_184632_c);
-   }
-
-   public void func_70606_j(float p_70606_1_) {
-      this.field_70180_af.func_187227_b(field_184632_c, MathHelper.func_76131_a(p_70606_1_, 0.0F, this.func_110138_aP()));
-   }
-
-   public boolean func_233643_dh_() {
-      return this.func_110143_aJ() <= 0.0F;
-   }
-
-   public boolean func_70097_a(DamageSource p_70097_1_, float p_70097_2_) {
-      if (this.func_180431_b(p_70097_1_)) {
-         return false;
-      } else if (this.field_70170_p.field_72995_K) {
-         return false;
-      } else if (this.func_233643_dh_()) {
-         return false;
-      } else if (p_70097_1_.func_76347_k() && this.func_70644_a(Effects.field_76426_n)) {
-         return false;
-      } else {
-         if (this.func_70608_bn() && !this.field_70170_p.field_72995_K) {
-            this.func_213366_dy();
-         }
-
-         this.field_70708_bq = 0;
-         float f = p_70097_2_;
-         if ((p_70097_1_ == DamageSource.field_82728_o || p_70097_1_ == DamageSource.field_82729_p) && !this.func_184582_a(EquipmentSlotType.HEAD).func_190926_b()) {
-            this.func_184582_a(EquipmentSlotType.HEAD).func_222118_a((int)(p_70097_2_ * 4.0F + this.field_70146_Z.nextFloat() * p_70097_2_ * 2.0F), this, (p_233653_0_) -> {
-               p_233653_0_.func_213361_c(EquipmentSlotType.HEAD);
-            });
-            p_70097_2_ *= 0.75F;
-         }
-
-         boolean flag = false;
-         float f1 = 0.0F;
-         if (p_70097_2_ > 0.0F && this.func_184583_d(p_70097_1_)) {
-            this.func_184590_k(p_70097_2_);
-            f1 = p_70097_2_;
-            p_70097_2_ = 0.0F;
-            if (!p_70097_1_.func_76352_a()) {
-               Entity entity = p_70097_1_.func_76364_f();
-               if (entity instanceof LivingEntity) {
-                  this.func_190629_c((LivingEntity)entity);
-               }
-            }
-
-            flag = true;
-         }
-
-         this.field_70721_aZ = 1.5F;
-         boolean flag1 = true;
-         if ((float)this.field_70172_ad > 10.0F) {
-            if (p_70097_2_ <= this.field_110153_bc) {
-               return false;
-            }
-
-            this.func_70665_d(p_70097_1_, p_70097_2_ - this.field_110153_bc);
-            this.field_110153_bc = p_70097_2_;
-            flag1 = false;
-         } else {
-            this.field_110153_bc = p_70097_2_;
-            this.field_70172_ad = 20;
-            this.func_70665_d(p_70097_1_, p_70097_2_);
-            this.field_70738_aO = 10;
-            this.field_70737_aN = this.field_70738_aO;
-         }
-
-         this.field_70739_aP = 0.0F;
-         Entity entity1 = p_70097_1_.func_76346_g();
-         if (entity1 != null) {
-            if (entity1 instanceof LivingEntity) {
-               this.func_70604_c((LivingEntity)entity1);
-            }
-
-            if (entity1 instanceof PlayerEntity) {
-               this.field_70718_bc = 100;
-               this.field_70717_bb = (PlayerEntity)entity1;
-            } else if (entity1 instanceof WolfEntity) {
-               WolfEntity wolfentity = (WolfEntity)entity1;
-               if (wolfentity.func_70909_n()) {
-                  this.field_70718_bc = 100;
-                  LivingEntity livingentity = wolfentity.func_70902_q();
-                  if (livingentity != null && livingentity.func_200600_R() == EntityType.field_200729_aH) {
-                     this.field_70717_bb = (PlayerEntity)livingentity;
-                  } else {
-                     this.field_70717_bb = null;
-                  }
-               }
-            }
-         }
-
-         if (flag1) {
-            if (flag) {
-               this.field_70170_p.func_72960_a(this, (byte)29);
-            } else if (p_70097_1_ instanceof EntityDamageSource && ((EntityDamageSource)p_70097_1_).func_180139_w()) {
-               this.field_70170_p.func_72960_a(this, (byte)33);
-            } else {
-               byte b0;
-               if (p_70097_1_ == DamageSource.field_76369_e) {
-                  b0 = 36;
-               } else if (p_70097_1_.func_76347_k()) {
-                  b0 = 37;
-               } else if (p_70097_1_ == DamageSource.field_220302_v) {
-                  b0 = 44;
-               } else {
-                  b0 = 2;
-               }
-
-               this.field_70170_p.func_72960_a(this, b0);
-            }
-
-            if (p_70097_1_ != DamageSource.field_76369_e && (!flag || p_70097_2_ > 0.0F)) {
-               this.func_70018_K();
-            }
-
+                override = new EffectInstance(effectinstance).func_199308_a(effectInstanceIn);
+            }
+
+            EntityPotionEffectEvent event = CraftEventFactory.callEntityPotionEffectChangeEvent(this, effectinstance, effectInstanceIn, cause, override);
+            if (event.isCancelled()) {
+                return false;
+            }
+            // CraftBukkit end
+
+            if (effectinstance == null) {
+                this.field_70713_bf.put(effectInstanceIn.func_188419_a(), effectInstanceIn);
+                this.func_70670_a(effectInstanceIn);
+                return true;
+                // CraftBukkit start
+                // } else if (effectinstance.combine(effectInstanceIn)) {
+            } else if (event.isOverride()) {
+                effectinstance.func_199308_a(effectInstanceIn);
+                this.func_70695_b(effectinstance, true);
+                // CraftBukkit end
+                return true;
+            } else {
+                return false;
+            }
+        }
+    }
+
+    public boolean func_70687_e(EffectInstance p_70687_1_) {
+        net.minecraftforge.event.entity.living.PotionEvent.PotionApplicableEvent event = new net.minecraftforge.event.entity.living.PotionEvent.PotionApplicableEvent(this, p_70687_1_);
+        net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(event);
+        if (event.getResult() != net.minecraftforge.eventbus.api.Event.Result.DEFAULT)
+            return event.getResult() == net.minecraftforge.eventbus.api.Event.Result.ALLOW;
+        if (this.func_70668_bt() == CreatureAttribute.field_223223_b_) {
+            Effect effect = p_70687_1_.func_188419_a();
+           return effect != Effects.field_76428_l && effect != Effects.field_76436_u;
+        }
+
+        return true;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public void func_233646_e_(EffectInstance p_233646_1_) {
+        if (this.func_70687_e(p_233646_1_)) {
+            EffectInstance effectinstance = this.field_70713_bf.put(p_233646_1_.func_188419_a(), p_233646_1_);
+            if (effectinstance == null) {
+                this.func_70670_a(p_233646_1_);
+            } else {
+                this.func_70695_b(p_233646_1_, true);
+            }
+
+        }
+    }
+
+    public boolean func_70662_br() {
+        return this.func_70668_bt() == CreatureAttribute.field_223223_b_;
+    }
+
+    //CraftBukkit start
+    @Nullable
+    public EffectInstance func_184596_c(@Nullable Effect p_184596_1_) {
+        return removeActivePotionEffect(p_184596_1_, EntityPotionEffectEvent.Cause.UNKNOWN);
+    }
+
+    @Nullable
+    public EffectInstance removeActivePotionEffect(@Nullable Effect potioneffectin, EntityPotionEffectEvent.Cause cause) {
+        if (isTickingEffects) {
+            effectsToProcess.add(new ProcessableEffect(potioneffectin, cause));
+            return null;
+        }
+
+        EffectInstance effect = this.field_70713_bf.get(potioneffectin);
+        if (effect == null) {
+            return null;
+        }
+
+        EntityPotionEffectEvent event = CraftEventFactory.callEntityPotionEffectChangeEvent(this, effect, null, cause);
+        if (event.isCancelled()) {
+            return null;
+        }
+        return this.field_70713_bf.remove(potioneffectin);
+    }
+
+    public boolean func_195063_d(Effect p_195063_1_) {
+        return removeEffect(p_195063_1_, org.bukkit.event.entity.EntityPotionEffectEvent.Cause.UNKNOWN);
+    }
+
+    public boolean removeEffect(Effect effectIn, EntityPotionEffectEvent.Cause cause) {
+        if (net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.living.PotionEvent.PotionRemoveEvent(this, effectIn)))
+            return false;
+        EffectInstance effectinstance = this.func_184596_c(effectIn);
+        // CraftBukkit end
+        if (effectinstance != null) {
+            this.func_70688_c(effectinstance);
+            return true;
+        } else {
+            return false;
+        }
+    }
+
+    protected void func_70670_a(EffectInstance p_70670_1_) {
+        this.field_70752_e = true;
+        if (!this.field_70170_p.field_72995_K) {
+            p_70670_1_.func_188419_a().func_111185_a(this, this.func_233645_dx_(), p_70670_1_.func_76458_c());
+        }
+
+    }
+
+    protected void func_70695_b(EffectInstance p_70695_1_, boolean p_70695_2_) {
+        this.field_70752_e = true;
+        if (p_70695_2_ && !this.field_70170_p.field_72995_K) {
+            Effect effect = p_70695_1_.func_188419_a();
+            effect.func_111187_a(this, this.func_233645_dx_(), p_70695_1_.func_76458_c());
+            effect.func_111185_a(this, this.func_233645_dx_(), p_70695_1_.func_76458_c());
+        }
+
+    }
+
+    protected void func_70688_c(EffectInstance p_70688_1_) {
+        this.field_70752_e = true;
+        if (!this.field_70170_p.field_72995_K) {
+            p_70688_1_.func_188419_a().func_111187_a(this, this.func_233645_dx_(), p_70688_1_.func_76458_c());
+        }
+
+    }
+
+    // CraftBukkit start - Delegate so we can handle providing a reason for health being regained
+    public void func_70691_i(float p_70691_1_) {
+        heal(p_70691_1_, EntityRegainHealthEvent.RegainReason.CUSTOM);
+    }
+
+    public void heal(float healAmount, EntityRegainHealthEvent.RegainReason regainReason) {
+        healAmount = net.minecraftforge.event.ForgeEventFactory.onLivingHeal(this, healAmount);
+        if (healAmount <= 0) {
+            return;
+        }
+        float f = this.func_110143_aJ();
+        if (f > 0.0F) {
+            EntityRegainHealthEvent event = new EntityRegainHealthEvent(this.getBukkitEntity(), healAmount, regainReason);
+            // Suppress during worldgen
+            if (this.valid) {
+                this.field_70170_p.getCBServer().getPluginManager().callEvent(event);
+            }
+
+            if (!event.isCancelled()) {
+                this.func_70606_j((float) (this.func_110143_aJ() + event.getAmount()));
+            }
+            // CraftBukkit end
+        }
+
+    }
+
+    public float func_110143_aJ() {
+        // CraftBukkit start - Use unscaled health
+        if (this instanceof ServerPlayerEntity && ((ServerPlayerEntity) this).initialized()) {
+            return (float) ((ServerPlayerEntity) this).getBukkitEntity().getHealth();
+        }
+        // CraftBukkit end
+        return this.field_70180_af.func_187225_a(field_184632_c);
+    }
+
+    public void func_70606_j(float p_70606_1_) {
+        // CraftBukkit start - Handle scaled health
+        if (this instanceof ServerPlayerEntity && ((ServerPlayerEntity) this).initialized()) {
+            org.bukkit.craftbukkit.v1_16_R3.entity.CraftPlayer player = ((ServerPlayerEntity) this).getBukkitEntity();
+            // Squeeze
+            double realHealth = MathHelper.func_151237_a(p_70606_1_, 0.0F, player.getMaxHealth());
+            player.setRealHealth(realHealth);
+            player.updateScaledHealth(false);
+            player.setRealHealth(realHealth);
+            return;
+        }
+        // CraftBukkit end
+        this.field_70180_af.func_187227_b(field_184632_c, MathHelper.func_76131_a(p_70606_1_, 0.0F, this.func_110138_aP()));
+    }
+
+    public boolean func_233643_dh_() {
+        return this.func_110143_aJ() <= 0.0F;
+    }
+
+    public boolean func_70097_a(DamageSource p_70097_1_, float p_70097_2_) {
+        if (!net.minecraftforge.common.ForgeHooks.onLivingAttack(this, p_70097_1_, p_70097_2_)) return false;
+        if (this.func_180431_b(p_70097_1_)) {
+            return false;
+        } else if (this.field_70170_p.field_72995_K) {
+            return false;
+        } else if (this.field_70128_L || this.field_70729_aU || this.func_233643_dh_()) {
+            return false;
+        } else if (p_70097_1_.func_76347_k() && this.func_70644_a(Effects.field_76426_n)) {
+            return false;
+        } else {
+            if (this.func_70608_bn() && !this.field_70170_p.field_72995_K) {
+                this.func_213366_dy();
+            }
+
+            this.field_70708_bq = 0;
+            float f = p_70097_2_;
+            if ((p_70097_1_ == DamageSource.field_82728_o || p_70097_1_ == DamageSource.field_82729_p) && !this.func_184582_a(EquipmentSlotType.HEAD).func_190926_b()) {
+                this.func_184582_a(EquipmentSlotType.HEAD).func_222118_a((int) (p_70097_2_ * 4.0F + this.field_70146_Z.nextFloat() * p_70097_2_ * 2.0F), this, (p_233653_0_) -> {
+                    p_233653_0_.func_213361_c(EquipmentSlotType.HEAD);
+                });
+                p_70097_2_ *= 0.75F;
+            }
+
+            boolean flag = p_70097_2_ > 0.0F && this.func_184583_d(p_70097_1_); // Copied from below
+            float f1 = 0.0F;
+            if (p_70097_2_ > 0.0F && this.func_184583_d(p_70097_1_)) {
+                this.func_184590_k(p_70097_2_);
+                f1 = p_70097_2_;
+                p_70097_2_ = 0.0F;
+                if (!p_70097_1_.func_76352_a()) {
+                    Entity entity = p_70097_1_.func_76364_f();
+                    if (entity instanceof LivingEntity) {
+                        this.func_190629_c((LivingEntity) entity);
+                    }
+                }
+
+                flag = true;
+            }
+
+            this.field_70721_aZ = 1.5F;
+            boolean flag1 = true;
+            if ((float) this.field_70172_ad > (float) this.field_70771_an / 2.0F) { // CraftBukkit - restore use of maxNoDamageTicks
+                if (p_70097_2_ <= this.field_110153_bc) {
+                    this.forceExplosionKnockback = true; // CraftBukkit - SPIGOT-949 - for vanilla consistency, cooldown does not prevent explosion knockback
+                    return false;
+                }
+
+                // CraftBukkit start
+                if (!this.damageEntity0(p_70097_1_, p_70097_2_ - this.field_110153_bc)) {
+                    return false;
+                }
+                // CraftBukkit end
+                this.field_110153_bc = p_70097_2_;
+                flag1 = false;
+            } else {
+                // CraftBukkit start
+                if (!this.damageEntity0(p_70097_1_, p_70097_2_)) {
+                    return false;
+                }
+                // CraftBukkit end
+                this.field_110153_bc = p_70097_2_;
+                this.field_70172_ad = this.field_70771_an; // CraftBukkit - restore use of maxNoDamageTicks
+                this.field_70738_aO = 10;
+                this.field_70737_aN = this.field_70738_aO;
+            }
+
+            // CraftBukkit start
+            if (this instanceof AnimalEntity) {
+                ((AnimalEntity) this).func_70875_t();
+                if (this instanceof TameableEntity) {
+                    ((TameableEntity) this).func_233687_w_(false);
+                }
+            }
+            // CraftBukkit end
+
+            this.field_70739_aP = 0.0F;
+            Entity entity1 = p_70097_1_.func_76346_g();
             if (entity1 != null) {
-               double d1 = entity1.func_226277_ct_() - this.func_226277_ct_();
-
-               double d0;
-               for(d0 = entity1.func_226281_cx_() - this.func_226281_cx_(); d1 * d1 + d0 * d0 < 1.0E-4D; d0 = (Math.random() - Math.random()) * 0.01D) {
-                  d1 = (Math.random() - Math.random()) * 0.01D;
-               }
-
-               this.field_70739_aP = (float)(MathHelper.func_181159_b(d0, d1) * (double)(180F / (float)Math.PI) - (double)this.field_70177_z);
-               this.func_233627_a_(0.4F, d1, d0);
-            } else {
-               this.field_70739_aP = (float)((int)(Math.random() * 2.0D) * 180);
-            }
-         }
-
-         if (this.func_233643_dh_()) {
-            if (!this.func_190628_d(p_70097_1_)) {
-               SoundEvent soundevent = this.func_184615_bR();
-               if (flag1 && soundevent != null) {
-                  this.func_184185_a(soundevent, this.func_70599_aP(), this.func_70647_i());
-               }
-
-               this.func_70645_a(p_70097_1_);
-            }
-         } else if (flag1) {
-            this.func_184581_c(p_70097_1_);
-         }
-
-         boolean flag2 = !flag || p_70097_2_ > 0.0F;
-         if (flag2) {
-            this.field_189750_bF = p_70097_1_;
-            this.field_189751_bG = this.field_70170_p.func_82737_E();
-         }
-
-         if (this instanceof ServerPlayerEntity) {
-            CriteriaTriggers.field_192128_h.func_192200_a((ServerPlayerEntity)this, p_70097_1_, f, p_70097_2_, flag);
-            if (f1 > 0.0F && f1 < 3.4028235E37F) {
-               ((ServerPlayerEntity)this).func_195067_a(Stats.field_212737_I, Math.round(f1 * 10.0F));
-            }
-         }
-
-         if (entity1 instanceof ServerPlayerEntity) {
-            CriteriaTriggers.field_192127_g.func_192220_a((ServerPlayerEntity)entity1, this, p_70097_1_, f, p_70097_2_, flag);
-         }
-
-         return flag2;
-      }
-   }
-
-   protected void func_190629_c(LivingEntity p_190629_1_) {
-      p_190629_1_.func_213371_e(this);
-   }
-
-   protected void func_213371_e(LivingEntity p_213371_1_) {
-      p_213371_1_.func_233627_a_(0.5F, p_213371_1_.func_226277_ct_() - this.func_226277_ct_(), p_213371_1_.func_226281_cx_() - this.func_226281_cx_());
-   }
-
-   private boolean func_190628_d(DamageSource p_190628_1_) {
-      if (p_190628_1_.func_76357_e()) {
-         return false;
-      } else {
-         ItemStack itemstack = null;
-
-         for(Hand hand : Hand.values()) {
-            ItemStack itemstack1 = this.func_184586_b(hand);
-            if (itemstack1.func_77973_b() == Items.field_190929_cY) {
-               itemstack = itemstack1.func_77946_l();
-               itemstack1.func_190918_g(1);
-               break;
-            }
-         }
-
-         if (itemstack != null) {
+                if (entity1 instanceof LivingEntity) {
+                    this.func_70604_c((LivingEntity) entity1);
+                }
+
+                if (entity1 instanceof PlayerEntity) {
+                    this.field_70718_bc = 100;
+                    this.field_70717_bb = (PlayerEntity) entity1;
+                } else if (entity1 instanceof net.minecraft.entity.passive.TameableEntity) {
+                    net.minecraft.entity.passive.TameableEntity wolfentity = (net.minecraft.entity.passive.TameableEntity) entity1;
+                    if (wolfentity.func_70909_n()) {
+                        this.field_70718_bc = 100;
+                        LivingEntity livingentity = wolfentity.func_70902_q();
+                        if (livingentity != null && livingentity.func_200600_R() == EntityType.field_200729_aH) {
+                            this.field_70717_bb = (PlayerEntity) livingentity;
+                        } else {
+                            this.field_70717_bb = null;
+                        }
+                    }
+                }
+            }
+
+            if (flag1) {
+                if (flag) {
+                    this.field_70170_p.func_72960_a(this, (byte) 29);
+                } else if (p_70097_1_ instanceof EntityDamageSource && ((EntityDamageSource) p_70097_1_).func_180139_w()) {
+                    this.field_70170_p.func_72960_a(this, (byte) 33);
+                } else {
+                    byte b0;
+                    if (p_70097_1_ == DamageSource.field_76369_e) {
+                        b0 = 36;
+                    } else if (p_70097_1_.func_76347_k()) {
+                        b0 = 37;
+                    } else if (p_70097_1_ == DamageSource.field_220302_v) {
+                        b0 = 44;
+                    } else {
+                        b0 = 2;
+                    }
+
+                    this.field_70170_p.func_72960_a(this, b0);
+                }
+
+                if (p_70097_1_ != DamageSource.field_76369_e && (!flag || p_70097_2_ > 0.0F)) {
+                    this.func_70018_K();
+                }
+
+                if (entity1 != null) {
+                    double d1 = entity1.func_226277_ct_() - this.func_226277_ct_();
+
+                    double d0;
+                    for (d0 = entity1.func_226281_cx_() - this.func_226281_cx_(); d1 * d1 + d0 * d0 < 1.0E-4D; d0 = (Math.random() - Math.random()) * 0.01D) {
+                        d1 = (Math.random() - Math.random()) * 0.01D;
+                    }
+
+                    this.field_70739_aP = (float) (MathHelper.func_181159_b(d0, d1) * (double) (180F / (float) Math.PI) - (double) this.field_70177_z);
+                    this.func_233627_a_(0.4F, d1, d0);
+                } else {
+                    this.field_70739_aP = (float) ((int) (Math.random() * 2.0D) * 180);
+                }
+            }
+
+            if (this.func_233643_dh_()) {
+                if (!this.func_190628_d(p_70097_1_)) {
+                    SoundEvent soundevent = this.func_184615_bR();
+                    if (flag1 && soundevent != null) {
+                        this.func_184185_a(soundevent, this.func_70599_aP(), this.func_70647_i());
+                    }
+
+                    this.func_70645_a(p_70097_1_);
+                }
+            } else if (flag1) {
+                this.func_184581_c(p_70097_1_);
+            }
+
+            boolean flag2 = !flag || p_70097_2_ > 0.0F;
+            if (flag2) {
+                this.field_189750_bF = p_70097_1_;
+                this.field_189751_bG = this.field_70170_p.func_82737_E();
+            }
+
             if (this instanceof ServerPlayerEntity) {
-               ServerPlayerEntity serverplayerentity = (ServerPlayerEntity)this;
-               serverplayerentity.func_71029_a(Stats.field_75929_E.func_199076_b(Items.field_190929_cY));
-               CriteriaTriggers.field_193130_A.func_193187_a(serverplayerentity, itemstack);
-            }
-
-            this.func_70606_j(1.0F);
-            this.func_195061_cb();
-            this.func_195064_c(new EffectInstance(Effects.field_76428_l, 900, 1));
-            this.func_195064_c(new EffectInstance(Effects.field_76444_x, 100, 1));
-            this.func_195064_c(new EffectInstance(Effects.field_76426_n, 800, 0));
-            this.field_70170_p.func_72960_a(this, (byte)35);
-         }
-
-         return itemstack != null;
-      }
-   }
-
-   @Nullable
-   public DamageSource func_189748_bU() {
-      if (this.field_70170_p.func_82737_E() - this.field_189751_bG > 40L) {
-         this.field_189750_bF = null;
-      }
-
-      return this.field_189750_bF;
-   }
-
-   protected void func_184581_c(DamageSource p_184581_1_) {
-      SoundEvent soundevent = this.func_184601_bQ(p_184581_1_);
-      if (soundevent != null) {
-         this.func_184185_a(soundevent, this.func_70599_aP(), this.func_70647_i());
-      }
-
-   }
-
-   private boolean func_184583_d(DamageSource p_184583_1_) {
-      Entity entity = p_184583_1_.func_76364_f();
-      boolean flag = false;
-      if (entity instanceof AbstractArrowEntity) {
-         AbstractArrowEntity abstractarrowentity = (AbstractArrowEntity)entity;
-         if (abstractarrowentity.func_213874_s() > 0) {
-            flag = true;
-         }
-      }
-
-      if (!p_184583_1_.func_76363_c() && this.func_184585_cz() && !flag) {
-         Vector3d vector3d2 = p_184583_1_.func_188404_v();
-         if (vector3d2 != null) {
-            Vector3d vector3d = this.func_70676_i(1.0F);
-            Vector3d vector3d1 = vector3d2.func_72444_a(this.func_213303_ch()).func_72432_b();
-            vector3d1 = new Vector3d(vector3d1.field_72450_a, 0.0D, vector3d1.field_72449_c);
-            if (vector3d1.func_72430_b(vector3d) < 0.0D) {
-               return true;
-            }
-         }
-      }
-
-      return false;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   private void func_70669_a(ItemStack p_70669_1_) {
-      if (!p_70669_1_.func_190926_b()) {
-         if (!this.func_174814_R()) {
-            this.field_70170_p.func_184134_a(this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), SoundEvents.field_187635_cQ, this.func_184176_by(), 0.8F, 0.8F + this.field_70170_p.field_73012_v.nextFloat() * 0.4F, false);
-         }
-
-         this.func_195062_a(p_70669_1_, 5);
-      }
-
-   }
-
-   public void func_70645_a(DamageSource p_70645_1_) {
-      if (!this.field_70128_L && !this.field_70729_aU) {
-         Entity entity = p_70645_1_.func_76346_g();
-         LivingEntity livingentity = this.func_94060_bK();
-         if (this.field_70744_aE >= 0 && livingentity != null) {
-            livingentity.func_191956_a(this, this.field_70744_aE, p_70645_1_);
-         }
-
-         if (this.func_70608_bn()) {
-            this.func_213366_dy();
-         }
-
-         this.field_70729_aU = true;
-         this.func_110142_aN().func_94549_h();
-         if (this.field_70170_p instanceof ServerWorld) {
-            if (entity != null) {
-               entity.func_241847_a((ServerWorld)this.field_70170_p, this);
-            }
-
-            this.func_213345_d(p_70645_1_);
-            this.func_226298_f_(livingentity);
-         }
-
-         this.field_70170_p.func_72960_a(this, (byte)3);
-         this.func_213301_b(Pose.DYING);
-      }
-   }
-
-   protected void func_226298_f_(@Nullable LivingEntity p_226298_1_) {
-      if (!this.field_70170_p.field_72995_K) {
-         boolean flag = false;
-         if (p_226298_1_ instanceof WitherEntity) {
-            if (this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223599_b)) {
-               BlockPos blockpos = this.func_233580_cy_();
-               BlockState blockstate = Blocks.field_222388_bz.func_176223_P();
-               if (this.field_70170_p.func_180495_p(blockpos).func_196958_f() && blockstate.func_196955_c(this.field_70170_p, blockpos)) {
-                  this.field_70170_p.func_180501_a(blockpos, blockstate, 3);
-                  flag = true;
-               }
-            }
-
-            if (!flag) {
-               ItemEntity itementity = new ItemEntity(this.field_70170_p, this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), new ItemStack(Items.field_221690_bg));
-               this.field_70170_p.func_217376_c(itementity);
-            }
-         }
-
-      }
-   }
-
-   protected void func_213345_d(DamageSource p_213345_1_) {
-      Entity entity = p_213345_1_.func_76346_g();
-      int i;
-      if (entity instanceof PlayerEntity) {
-         i = EnchantmentHelper.func_185283_h((LivingEntity)entity);
-      } else {
-         i = 0;
-      }
-
-      boolean flag = this.field_70718_bc > 0;
-      if (this.func_230282_cS_() && this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223602_e)) {
-         this.func_213354_a(p_213345_1_, flag);
-         this.func_213333_a(p_213345_1_, i, flag);
-      }
-
-      this.func_213337_cE();
-      this.func_226294_cV_();
-   }
-
-   protected void func_213337_cE() {
-   }
-
-   protected void func_226294_cV_() {
-      if (!this.field_70170_p.field_72995_K && (this.func_70684_aJ() || this.field_70718_bc > 0 && this.func_146066_aG() && this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223602_e))) {
-         int i = this.func_70693_a(this.field_70717_bb);
-
-         while(i > 0) {
-            int j = ExperienceOrbEntity.func_70527_a(i);
-            i -= j;
-            this.field_70170_p.func_217376_c(new ExperienceOrbEntity(this.field_70170_p, this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), j));
-         }
-      }
-
-   }
-
-   protected void func_213333_a(DamageSource p_213333_1_, int p_213333_2_, boolean p_213333_3_) {
-   }
-
-   public ResourceLocation func_213346_cF() {
-      return this.func_200600_R().func_220348_g();
-   }
-
-   protected void func_213354_a(DamageSource p_213354_1_, boolean p_213354_2_) {
-      ResourceLocation resourcelocation = this.func_213346_cF();
-      LootTable loottable = this.field_70170_p.func_73046_m().func_200249_aQ().func_186521_a(resourcelocation);
-      LootContext.Builder lootcontext$builder = this.func_213363_a(p_213354_2_, p_213354_1_);
-      loottable.func_216120_b(lootcontext$builder.func_216022_a(LootParameterSets.field_216263_d), this::func_199701_a_);
-   }
-
-   protected LootContext.Builder func_213363_a(boolean p_213363_1_, DamageSource p_213363_2_) {
-      LootContext.Builder lootcontext$builder = (new LootContext.Builder((ServerWorld)this.field_70170_p)).func_216023_a(this.field_70146_Z).func_216015_a(LootParameters.field_216281_a, this).func_216015_a(LootParameters.field_237457_g_, this.func_213303_ch()).func_216015_a(LootParameters.field_216283_c, p_213363_2_).func_216021_b(LootParameters.field_216284_d, p_213363_2_.func_76346_g()).func_216021_b(LootParameters.field_216285_e, p_213363_2_.func_76364_f());
-      if (p_213363_1_ && this.field_70717_bb != null) {
-         lootcontext$builder = lootcontext$builder.func_216015_a(LootParameters.field_216282_b, this.field_70717_bb).func_186469_a(this.field_70717_bb.func_184817_da());
-      }
-
-      return lootcontext$builder;
-   }
-
-   public void func_233627_a_(float p_233627_1_, double p_233627_2_, double p_233627_4_) {
-      p_233627_1_ = (float)((double)p_233627_1_ * (1.0D - this.func_233637_b_(Attributes.field_233820_c_)));
-      if (!(p_233627_1_ <= 0.0F)) {
-         this.field_70160_al = true;
-         Vector3d vector3d = this.func_213322_ci();
-         Vector3d vector3d1 = (new Vector3d(p_233627_2_, 0.0D, p_233627_4_)).func_72432_b().func_186678_a((double)p_233627_1_);
-         this.func_213293_j(vector3d.field_72450_a / 2.0D - vector3d1.field_72450_a, this.field_70122_E ? Math.min(0.4D, vector3d.field_72448_b / 2.0D + (double)p_233627_1_) : vector3d.field_72448_b, vector3d.field_72449_c / 2.0D - vector3d1.field_72449_c);
-      }
-   }
-
-   @Nullable
-   protected SoundEvent func_184601_bQ(DamageSource p_184601_1_) {
-      return SoundEvents.field_187543_bD;
-   }
-
-   @Nullable
-   protected SoundEvent func_184615_bR() {
-      return SoundEvents.field_187661_by;
-   }
-
-   protected SoundEvent func_184588_d(int p_184588_1_) {
-      return p_184588_1_ > 4 ? SoundEvents.field_187655_bw : SoundEvents.field_187545_bE;
-   }
-
-   protected SoundEvent func_213351_c(ItemStack p_213351_1_) {
-      return p_213351_1_.func_226629_F_();
-   }
-
-   public SoundEvent func_213353_d(ItemStack p_213353_1_) {
-      return p_213353_1_.func_226630_G_();
-   }
-
-   public void func_230245_c_(boolean p_230245_1_) {
-      super.func_230245_c_(p_230245_1_);
-      if (p_230245_1_) {
-         this.field_233624_bE_ = Optional.empty();
-      }
-
-   }
-
-   public Optional<BlockPos> func_233644_dn_() {
-      return this.field_233624_bE_;
-   }
-
-   public boolean func_70617_f_() {
-      if (this.func_175149_v()) {
-         return false;
-      } else {
-         BlockPos blockpos = this.func_233580_cy_();
-         BlockState blockstate = this.func_213339_cH();
-         Block block = blockstate.func_177230_c();
-         if (block.func_203417_a(BlockTags.field_232878_as_)) {
-            this.field_233624_bE_ = Optional.of(blockpos);
-            return true;
-         } else if (block instanceof TrapDoorBlock && this.func_184604_a(blockpos, blockstate)) {
-            this.field_233624_bE_ = Optional.of(blockpos);
-            return true;
-         } else {
-            return false;
-         }
-      }
-   }
-
-   public BlockState func_213339_cH() {
-      return this.field_70170_p.func_180495_p(this.func_233580_cy_());
-   }
-
-   private boolean func_184604_a(BlockPos p_184604_1_, BlockState p_184604_2_) {
-      if (p_184604_2_.func_177229_b(TrapDoorBlock.field_176283_b)) {
-         BlockState blockstate = this.field_70170_p.func_180495_p(p_184604_1_.func_177977_b());
-         if (blockstate.func_203425_a(Blocks.field_150468_ap) && blockstate.func_177229_b(LadderBlock.field_176382_a) == p_184604_2_.func_177229_b(TrapDoorBlock.field_185512_D)) {
-            return true;
-         }
-      }
-
-      return false;
-   }
-
-   public boolean func_70089_S() {
-      return !this.field_70128_L && this.func_110143_aJ() > 0.0F;
-   }
-
-   public boolean func_225503_b_(float p_225503_1_, float p_225503_2_) {
-      boolean flag = super.func_225503_b_(p_225503_1_, p_225503_2_);
-      int i = this.func_225508_e_(p_225503_1_, p_225503_2_);
-      if (i > 0) {
-         this.func_184185_a(this.func_184588_d(i), 1.0F, 1.0F);
-         this.func_226295_cZ_();
-         this.func_70097_a(DamageSource.field_76379_h, (float)i);
-         return true;
-      } else {
-         return flag;
-      }
-   }
-
-   protected int func_225508_e_(float p_225508_1_, float p_225508_2_) {
-      EffectInstance effectinstance = this.func_70660_b(Effects.field_76430_j);
-      float f = effectinstance == null ? 0.0F : (float)(effectinstance.func_76458_c() + 1);
-      return MathHelper.func_76123_f((p_225508_1_ - 3.0F - f) * p_225508_2_);
-   }
-
-   protected void func_226295_cZ_() {
-      if (!this.func_174814_R()) {
-         int i = MathHelper.func_76128_c(this.func_226277_ct_());
-         int j = MathHelper.func_76128_c(this.func_226278_cu_() - (double)0.2F);
-         int k = MathHelper.func_76128_c(this.func_226281_cx_());
-         BlockState blockstate = this.field_70170_p.func_180495_p(new BlockPos(i, j, k));
-         if (!blockstate.func_196958_f()) {
-            SoundType soundtype = blockstate.func_215695_r();
-            this.func_184185_a(soundtype.func_185842_g(), soundtype.func_185843_a() * 0.5F, soundtype.func_185847_b() * 0.75F);
-         }
-
-      }
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public void func_70057_ab() {
-      this.field_70738_aO = 10;
-      this.field_70737_aN = this.field_70738_aO;
-      this.field_70739_aP = 0.0F;
-   }
-
-   public int func_70658_aO() {
-      return MathHelper.func_76128_c(this.func_233637_b_(Attributes.field_233826_i_));
-   }
-
-   protected void func_230294_b_(DamageSource p_230294_1_, float p_230294_2_) {
-   }
-
-   protected void func_184590_k(float p_184590_1_) {
-   }
-
-   protected float func_70655_b(DamageSource p_70655_1_, float p_70655_2_) {
-      if (!p_70655_1_.func_76363_c()) {
-         this.func_230294_b_(p_70655_1_, p_70655_2_);
-         p_70655_2_ = CombatRules.func_189427_a(p_70655_2_, (float)this.func_70658_aO(), (float)this.func_233637_b_(Attributes.field_233827_j_));
-      }
-
-      return p_70655_2_;
-   }
-
-   protected float func_70672_c(DamageSource p_70672_1_, float p_70672_2_) {
-      if (p_70672_1_.func_151517_h()) {
-         return p_70672_2_;
-      } else {
-         if (this.func_70644_a(Effects.field_76429_m) && p_70672_1_ != DamageSource.field_76380_i) {
-            int i = (this.func_70660_b(Effects.field_76429_m).func_76458_c() + 1) * 5;
-            int j = 25 - i;
-            float f = p_70672_2_ * (float)j;
-            float f1 = p_70672_2_;
-            p_70672_2_ = Math.max(f / 25.0F, 0.0F);
-            float f2 = f1 - p_70672_2_;
-            if (f2 > 0.0F && f2 < 3.4028235E37F) {
-               if (this instanceof ServerPlayerEntity) {
-                  ((ServerPlayerEntity)this).func_195067_a(Stats.field_212739_K, Math.round(f2 * 10.0F));
-               } else if (p_70672_1_.func_76346_g() instanceof ServerPlayerEntity) {
-                  ((ServerPlayerEntity)p_70672_1_.func_76346_g()).func_195067_a(Stats.field_212736_G, Math.round(f2 * 10.0F));
-               }
-            }
-         }
-
-         if (p_70672_2_ <= 0.0F) {
-            return 0.0F;
-         } else {
-            int k = EnchantmentHelper.func_77508_a(this.func_184193_aE(), p_70672_1_);
-            if (k > 0) {
-               p_70672_2_ = CombatRules.func_188401_b(p_70672_2_, (float)k);
-            }
-
+                CriteriaTriggers.field_192128_h.func_192200_a((ServerPlayerEntity) this, p_70097_1_, f, p_70097_2_, flag);
+                if (f1 > 0.0F && f1 < 3.4028235E37F) {
+                    ((ServerPlayerEntity) this).func_195067_a(Stats.field_212737_I, Math.round(f1 * 10.0F));
+                }
+            }
+
+            if (entity1 instanceof ServerPlayerEntity) {
+                CriteriaTriggers.field_192127_g.func_192220_a((ServerPlayerEntity) entity1, this, p_70097_1_, f, p_70097_2_, flag);
+            }
+
+            return flag2;
+        }
+    }
+
+    protected void func_190629_c(LivingEntity p_190629_1_) {
+        p_190629_1_.func_213371_e(this);
+    }
+
+    protected void func_213371_e(LivingEntity p_213371_1_) {
+        p_213371_1_.func_233627_a_(0.5F, p_213371_1_.func_226277_ct_() - this.func_226277_ct_(), p_213371_1_.func_226281_cx_() - this.func_226281_cx_());
+    }
+
+    private boolean func_190628_d(DamageSource p_190628_1_) {
+        if (p_190628_1_.func_76357_e()) {
+            return false;
+        } else {
+            ItemStack itemstack = null;
+            // CraftBukkit start
+            ItemStack itemstack1 = ItemStack.field_190927_a;
+
+            for (Hand hand : Hand.values()) {
+                itemstack1 = this.func_184586_b(hand);
+                if (itemstack1.func_77973_b() == Items.field_190929_cY) {
+                    itemstack = itemstack1.func_77946_l();
+                    // itemstack1.shrink(1);  // CraftBukkit
+                    break;
+                }
+            }
+
+            EntityResurrectEvent event = new EntityResurrectEvent((org.bukkit.entity.LivingEntity) this.getBukkitEntity());
+            event.setCancelled(itemstack == null);
+            this.field_70170_p.getCBServer().getPluginManager().callEvent(event);
+            if (!event.isCancelled()) {
+                if (!itemstack1.func_190926_b()) {
+                    itemstack1.func_190918_g(1);
+                }
+                if (itemstack != null && this instanceof ServerPlayerEntity) {
+                    // CraftBukkit end
+                    ServerPlayerEntity serverplayerentity = (ServerPlayerEntity) this;
+                    serverplayerentity.func_71029_a(Stats.field_75929_E.func_199076_b(Items.field_190929_cY));
+                    CriteriaTriggers.field_193130_A.func_193187_a(serverplayerentity, itemstack);
+                }
+
+                this.func_70606_j(1.0F);
+                // CraftBukkit start
+                this.clearActivePotions(Cause.TOTEM);
+                this.addEffect(new EffectInstance(Effects.field_76428_l, 900, 1), Cause.TOTEM);
+                this.addEffect(new EffectInstance(Effects.field_76444_x, 100, 1), Cause.TOTEM);
+                this.addEffect(new EffectInstance(Effects.field_76426_n, 800, 0), Cause.TOTEM);
+                // CraftBukkit end
+                this.field_70170_p.func_72960_a(this, (byte) 35);
+            }
+
+            return !event.isCancelled();
+        }
+    }
+
+    @Nullable
+    public DamageSource func_189748_bU() {
+        if (this.field_70170_p.func_82737_E() - this.field_189751_bG > 40L) {
+            this.field_189750_bF = null;
+        }
+
+        return this.field_189750_bF;
+    }
+
+    protected void func_184581_c(DamageSource p_184581_1_) {
+        SoundEvent soundevent = this.func_184601_bQ(p_184581_1_);
+        if (soundevent != null) {
+            this.func_184185_a(soundevent, this.func_70599_aP(), this.func_70647_i());
+        }
+
+    }
+
+    private boolean func_184583_d(DamageSource p_184583_1_) {
+        Entity entity = p_184583_1_.func_76364_f();
+        boolean flag = false;
+        if (entity instanceof AbstractArrowEntity) {
+            AbstractArrowEntity abstractarrowentity = (AbstractArrowEntity) entity;
+            if (abstractarrowentity.func_213874_s() > 0) {
+                flag = true;
+            }
+        }
+
+        if (!p_184583_1_.func_76363_c() && this.func_184585_cz() && !flag) {
+            Vector3d vector3d2 = p_184583_1_.func_188404_v();
+            if (vector3d2 != null) {
+                Vector3d vector3d = this.func_70676_i(1.0F);
+                Vector3d vector3d1 = vector3d2.func_72444_a(this.func_213303_ch()).func_72432_b();
+                vector3d1 = new Vector3d(vector3d1.field_72450_a, 0.0D, vector3d1.field_72449_c);
+               return vector3d1.func_72430_b(vector3d) < 0.0D;
+            }
+        }
+
+        return false;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    private void func_70669_a(ItemStack p_70669_1_) {
+        if (!p_70669_1_.func_190926_b()) {
+            if (!this.func_174814_R()) {
+                this.field_70170_p.func_184134_a(this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), SoundEvents.field_187635_cQ, this.func_184176_by(), 0.8F, 0.8F + this.field_70170_p.field_73012_v.nextFloat() * 0.4F, false);
+            }
+
+            this.func_195062_a(p_70669_1_, 5);
+        }
+
+    }
+
+    public void func_70645_a(DamageSource p_70645_1_) {
+        if (net.minecraftforge.common.ForgeHooks.onLivingDeath(this, p_70645_1_)) return;
+        if (!this.field_70128_L && !this.field_70729_aU) {
+            Entity entity = p_70645_1_.func_76346_g();
+            LivingEntity livingentity = this.func_94060_bK();
+            if (this.field_70744_aE >= 0 && livingentity != null) {
+                livingentity.func_191956_a(this, this.field_70744_aE, p_70645_1_);
+            }
+
+            if (this.func_70608_bn()) {
+                this.func_213366_dy();
+            }
+
+            this.field_70729_aU = true;
+            this.func_110142_aN().func_94549_h();
+            if (this.field_70170_p instanceof ServerWorld) {
+                if (entity != null) {
+                    entity.func_241847_a((ServerWorld) this.field_70170_p, this);
+                }
+
+                this.func_213345_d(p_70645_1_);
+                this.func_226298_f_(livingentity);
+            }
+
+            this.field_70170_p.func_72960_a(this, (byte) 3);
+            this.func_213301_b(Pose.DYING);
+        }
+    }
+
+    protected void func_226298_f_(@Nullable LivingEntity p_226298_1_) {
+        if (!this.field_70170_p.field_72995_K) {
+            boolean flag = false;
+            if (p_226298_1_ instanceof WitherEntity) {
+                if (net.minecraftforge.event.ForgeEventFactory.getMobGriefingEvent(this.field_70170_p, this)) {
+                    BlockPos blockpos = this.func_233580_cy_();
+                    BlockState blockstate = Blocks.field_222388_bz.func_176223_P();
+                    if (this.field_70170_p.func_175623_d(blockpos) && blockstate.func_196955_c(this.field_70170_p, blockpos)) {
+                        this.field_70170_p.func_180501_a(blockpos, blockstate, 3);
+                        flag = true;
+                    }
+                }
+
+                if (!flag) {
+                    ItemEntity itementity = new ItemEntity(this.field_70170_p, this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), new ItemStack(Items.field_221690_bg));
+
+                    // CraftBukkit start
+                    org.bukkit.event.entity.EntityDropItemEvent event = new org.bukkit.event.entity.EntityDropItemEvent(this.getBukkitEntity(), (org.bukkit.entity.Item) itementity.getBukkitEntity());
+                    CraftEventFactory.callEvent(event);
+                    if (event.isCancelled()) {
+                        return;
+                    }
+                    // CraftBukkit end
+                    this.field_70170_p.func_217376_c(itementity);
+                }
+            }
+
+        }
+    }
+
+    protected void func_213345_d(DamageSource p_213345_1_) {
+        Entity entity = p_213345_1_.func_76346_g();
+
+        int i = net.minecraftforge.common.ForgeHooks.getLootingLevel(this, entity, p_213345_1_);
+        this.captureDrops(new java.util.ArrayList<>());
+
+        boolean flag = this.field_70718_bc > 0;
+        this.func_213337_cE(); // CraftBukkit - from below
+        if (this.func_230282_cS_() && this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223602_e)) {
+            this.func_213354_a(p_213345_1_, flag);
+            this.func_213333_a(p_213345_1_, i, flag);
+        }
+
+        Collection<ItemEntity> drops = captureDrops(null);
+        if (!net.minecraftforge.common.ForgeHooks.onLivingDrops(this, p_213345_1_, drops, i, field_70718_bc > 0)) {
+            this.drops = new ArrayList<>();
+            for (ItemEntity drop : drops) {
+                this.drops.add(CraftItemStack.asCraftMirror(drop.func_92059_d()));
+            }
+            CraftEventFactory.callEntityDeathEvent(this, this.drops);
+        }
+    }
+
+    protected void func_213337_cE() {
+    }
+
+    // CraftBukkit start
+    public int getExpReward() {
+        if (!this.field_70170_p.field_72995_K && (this.func_70684_aJ() || this.field_70718_bc > 0 && this.func_146066_aG() && this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223602_e))) {
+            int i = this.func_70693_a(this.field_70717_bb);
+            return i;
+        } else {
+            return 0;
+        }
+    }
+    // CraftBukkit end
+
+    public void func_226294_cV_() {
+        // CraftBukkit start - Update getExpReward() above if the removed if() changes!
+        if (true) {
+            int i = this.expToDrop;
+
+            i = net.minecraftforge.event.ForgeEventFactory.getExperienceDrop(this, this.field_70717_bb, i);
+            while (i > 0) {
+                int j = ExperienceOrbEntity.func_70527_a(i);
+                i -= j;
+                this.field_70170_p.func_217376_c(new ExperienceOrbEntity(this.field_70170_p, this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), j));
+            }
+            this.expToDrop = 0;
+        }
+        // CraftBukkit end
+
+    }
+
+    protected void func_213333_a(DamageSource p_213333_1_, int p_213333_2_, boolean p_213333_3_) {
+    }
+
+    public ResourceLocation func_213346_cF() {
+        return this.func_200600_R().func_220348_g();
+    }
+
+    protected void func_213354_a(DamageSource p_213354_1_, boolean p_213354_2_) {
+        ResourceLocation resourcelocation = this.func_213346_cF();
+        LootTable loottable = this.field_70170_p.func_73046_m().func_200249_aQ().func_186521_a(resourcelocation);
+        LootContext.Builder lootcontext$builder = this.func_213363_a(p_213354_2_, p_213354_1_);
+        LootContext ctx = lootcontext$builder.func_216022_a(LootParameterSets.field_216263_d);
+        loottable.func_216113_a(ctx).forEach(this::func_199701_a_);
+    }
+
+    protected LootContext.Builder func_213363_a(boolean p_213363_1_, DamageSource p_213363_2_) {
+        LootContext.Builder lootcontext$builder = (new LootContext.Builder((ServerWorld) this.field_70170_p)).func_216023_a(this.field_70146_Z).func_216015_a(LootParameters.field_216281_a, this).func_216015_a(LootParameters.field_237457_g_, this.func_213303_ch()).func_216015_a(LootParameters.field_216283_c, p_213363_2_).func_216021_b(LootParameters.field_216284_d, p_213363_2_.func_76346_g()).func_216021_b(LootParameters.field_216285_e, p_213363_2_.func_76364_f());
+        if (p_213363_1_ && this.field_70717_bb != null) {
+            lootcontext$builder = lootcontext$builder.func_216015_a(LootParameters.field_216282_b, this.field_70717_bb).func_186469_a(this.field_70717_bb.func_184817_da());
+        }
+
+        return lootcontext$builder;
+    }
+
+    public void func_233627_a_(float p_233627_1_, double p_233627_2_, double p_233627_4_) {
+        net.minecraftforge.event.entity.living.LivingKnockBackEvent event = net.minecraftforge.common.ForgeHooks.onLivingKnockBack(this, p_233627_1_, p_233627_2_, p_233627_4_);
+        if (event.isCanceled()) return;
+        p_233627_1_ = event.getStrength();
+        p_233627_2_ = event.getRatioX();
+        p_233627_4_ = event.getRatioZ();
+        p_233627_1_ = (float) ((double) p_233627_1_ * (1.0D - this.func_233637_b_(Attributes.field_233820_c_)));
+        if (!(p_233627_1_ <= 0.0F)) {
+            this.field_70160_al = true;
+            Vector3d vector3d = this.func_213322_ci();
+            Vector3d vector3d1 = (new Vector3d(p_233627_2_, 0.0D, p_233627_4_)).func_72432_b().func_186678_a(p_233627_1_);
+            this.func_213293_j(vector3d.field_72450_a / 2.0D - vector3d1.field_72450_a, this.field_70122_E ? Math.min(0.4D, vector3d.field_72448_b / 2.0D + (double) p_233627_1_) : vector3d.field_72448_b, vector3d.field_72449_c / 2.0D - vector3d1.field_72449_c);
+        }
+    }
+
+    @Nullable
+    protected SoundEvent func_184601_bQ(DamageSource p_184601_1_) {
+        return SoundEvents.field_187543_bD;
+    }
+
+    @Nullable
+    protected SoundEvent func_184615_bR() {
+        return SoundEvents.field_187661_by;
+    }
+
+    protected SoundEvent func_184588_d(int p_184588_1_) {
+        return p_184588_1_ > 4 ? SoundEvents.field_187655_bw : SoundEvents.field_187545_bE;
+    }
+
+    protected SoundEvent func_213351_c(ItemStack p_213351_1_) {
+        return p_213351_1_.func_226629_F_();
+    }
+
+    public SoundEvent func_213353_d(ItemStack p_213353_1_) {
+        return p_213353_1_.func_226630_G_();
+    }
+
+    public void func_230245_c_(boolean p_230245_1_) {
+        super.func_230245_c_(p_230245_1_);
+        if (p_230245_1_) {
+            this.field_233624_bE_ = Optional.empty();
+        }
+
+    }
+
+    public Optional<BlockPos> func_233644_dn_() {
+        return this.field_233624_bE_;
+    }
+
+    public boolean func_70617_f_() {
+        if (this.func_175149_v()) {
+            return false;
+        } else {
+            BlockPos blockpos = this.func_233580_cy_();
+            BlockState blockstate = this.func_213339_cH();
+            return net.minecraftforge.common.ForgeHooks.isLivingOnLadder(blockstate, field_70170_p, blockpos, this);
+        }
+    }
+
+    public BlockState func_213339_cH() {
+        return this.field_70170_p.func_180495_p(this.func_233580_cy_());
+    }
+
+    private boolean func_184604_a(BlockPos p_184604_1_, BlockState p_184604_2_) {
+        if (p_184604_2_.func_177229_b(TrapDoorBlock.field_176283_b)) {
+            BlockState blockstate = this.field_70170_p.func_180495_p(p_184604_1_.func_177977_b());
+           return blockstate.func_203425_a(Blocks.field_150468_ap) && blockstate.func_177229_b(LadderBlock.field_176382_a) == p_184604_2_.func_177229_b(TrapDoorBlock.field_185512_D);
+        }
+
+        return false;
+    }
+
+    public boolean func_70089_S() {
+        return !this.field_70128_L && this.func_110143_aJ() > 0.0F;
+    }
+
+    public boolean func_225503_b_(float p_225503_1_, float p_225503_2_) {
+        float[] ret = net.minecraftforge.common.ForgeHooks.onLivingFall(this, p_225503_1_, p_225503_2_);
+        if (ret == null) return false;
+        p_225503_1_ = ret[0];
+        p_225503_2_ = ret[1];
+
+        boolean flag = super.func_225503_b_(p_225503_1_, p_225503_2_);
+        int i = this.func_225508_e_(p_225503_1_, p_225503_2_);
+        if (i > 0) {
+            // CraftBukkit start
+            if (!this.func_70097_a(DamageSource.field_76379_h, (float) i)) {
+                return true;
+            }
+            // CraftBukkit end
+            this.func_184185_a(this.func_184588_d(i), 1.0F, 1.0F);
+            this.func_226295_cZ_();
+            // this.attackEntityFrom(DamageSource.FALL, (float)i); // CraftBukkit - moved up
+            return true;
+        } else {
+            return flag;
+        }
+    }
+
+    protected int func_225508_e_(float p_225508_1_, float p_225508_2_) {
+        EffectInstance effectinstance = this.func_70660_b(Effects.field_76430_j);
+        float f = effectinstance == null ? 0.0F : (float) (effectinstance.func_76458_c() + 1);
+        return MathHelper.func_76123_f((p_225508_1_ - 3.0F - f) * p_225508_2_);
+    }
+
+    protected void func_226295_cZ_() {
+        if (!this.func_174814_R()) {
+            int i = MathHelper.func_76128_c(this.func_226277_ct_());
+            int j = MathHelper.func_76128_c(this.func_226278_cu_() - (double) 0.2F);
+            int k = MathHelper.func_76128_c(this.func_226281_cx_());
+            BlockPos pos = new BlockPos(i, j, k);
+            BlockState blockstate = this.field_70170_p.func_180495_p(pos);
+            if (!blockstate.isAir(this.field_70170_p, pos)) {
+                SoundType soundtype = blockstate.getSoundType(field_70170_p, pos, this);
+                this.func_184185_a(soundtype.func_185842_g(), soundtype.func_185843_a() * 0.5F, soundtype.func_185847_b() * 0.75F);
+            }
+
+        }
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public void func_70057_ab() {
+        this.field_70738_aO = 10;
+        this.field_70737_aN = this.field_70738_aO;
+        this.field_70739_aP = 0.0F;
+    }
+
+    public int func_70658_aO() {
+        return MathHelper.func_76128_c(this.func_233637_b_(Attributes.field_233826_i_));
+    }
+
+    protected void func_230294_b_(DamageSource p_230294_1_, float p_230294_2_) {
+    }
+
+    protected void func_184590_k(float p_184590_1_) {
+    }
+
+    // Mohist start - Prevent armor break if event is cancelled
+    protected float getDamageAfterArmorAbsorb(DamageSource p_70655_1_, float p_70655_2_, boolean onlyCheck) {
+        if (!p_70655_1_.func_76363_c()) {
+            if (!onlyCheck) this.func_230294_b_(p_70655_1_, p_70655_2_);
+            p_70655_2_ = CombatRules.func_189427_a(p_70655_2_, (float) this.func_70658_aO(), (float) this.func_233637_b_(Attributes.field_233827_j_));
+        }
+
+        return p_70655_2_;
+    }
+
+    protected float func_70655_b(DamageSource p_70655_1_, float p_70655_2_) {
+        return this.getDamageAfterArmorAbsorb(p_70655_1_, p_70655_2_, false);
+    }
+    // Mohist end
+
+    protected float func_70672_c(DamageSource p_70672_1_, float p_70672_2_) {
+        if (p_70672_1_.func_151517_h()) {
             return p_70672_2_;
-         }
-      }
-   }
-
-   protected void func_70665_d(DamageSource p_70665_1_, float p_70665_2_) {
-      if (!this.func_180431_b(p_70665_1_)) {
-         p_70665_2_ = this.func_70655_b(p_70665_1_, p_70665_2_);
-         p_70665_2_ = this.func_70672_c(p_70665_1_, p_70665_2_);
-         float f2 = Math.max(p_70665_2_ - this.func_110139_bj(), 0.0F);
-         this.func_110149_m(this.func_110139_bj() - (p_70665_2_ - f2));
-         float f = p_70665_2_ - f2;
-         if (f > 0.0F && f < 3.4028235E37F && p_70665_1_.func_76346_g() instanceof ServerPlayerEntity) {
-            ((ServerPlayerEntity)p_70665_1_.func_76346_g()).func_195067_a(Stats.field_212735_F, Math.round(f * 10.0F));
-         }
-
-         if (f2 != 0.0F) {
-            float f1 = this.func_110143_aJ();
-            this.func_70606_j(f1 - f2);
-            this.func_110142_aN().func_94547_a(p_70665_1_, f1, f2);
-            this.func_110149_m(this.func_110139_bj() - f2);
-         }
-      }
-   }
-
-   public CombatTracker func_110142_aN() {
-      return this.field_94063_bt;
-   }
-
-   @Nullable
-   public LivingEntity func_94060_bK() {
-      if (this.field_94063_bt.func_94550_c() != null) {
-         return this.field_94063_bt.func_94550_c();
-      } else if (this.field_70717_bb != null) {
-         return this.field_70717_bb;
-      } else {
-         return this.field_70755_b != null ? this.field_70755_b : null;
-      }
-   }
-
-   public final float func_110138_aP() {
-      return (float)this.func_233637_b_(Attributes.field_233818_a_);
-   }
-
-   public final int func_85035_bI() {
-      return this.field_70180_af.func_187225_a(field_184635_h);
-   }
-
-   public final void func_85034_r(int p_85034_1_) {
-      this.field_70180_af.func_187227_b(field_184635_h, p_85034_1_);
-   }
-
-   public final int func_226297_df_() {
-      return this.field_70180_af.func_187225_a(field_226291_bp_);
-   }
-
-   public final void func_226300_q_(int p_226300_1_) {
-      this.field_70180_af.func_187227_b(field_226291_bp_, p_226300_1_);
-   }
-
-   private int func_82166_i() {
-      if (EffectUtils.func_205135_a(this)) {
-         return 6 - (1 + EffectUtils.func_205134_b(this));
-      } else {
-         return this.func_70644_a(Effects.field_76419_f) ? 6 + (1 + this.func_70660_b(Effects.field_76419_f).func_76458_c()) * 2 : 6;
-      }
-   }
-
-   public void func_184609_a(Hand p_184609_1_) {
-      this.func_226292_a_(p_184609_1_, false);
-   }
-
-   public void func_226292_a_(Hand p_226292_1_, boolean p_226292_2_) {
-      if (!this.field_82175_bq || this.field_110158_av >= this.func_82166_i() / 2 || this.field_110158_av < 0) {
-         this.field_110158_av = -1;
-         this.field_82175_bq = true;
-         this.field_184622_au = p_226292_1_;
-         if (this.field_70170_p instanceof ServerWorld) {
-            SAnimateHandPacket sanimatehandpacket = new SAnimateHandPacket(this, p_226292_1_ == Hand.MAIN_HAND ? 0 : 3);
-            ServerChunkProvider serverchunkprovider = ((ServerWorld)this.field_70170_p).func_72863_F();
-            if (p_226292_2_) {
-               serverchunkprovider.func_217216_a(this, sanimatehandpacket);
-            } else {
-               serverchunkprovider.func_217218_b(this, sanimatehandpacket);
-            }
-         }
-      }
-
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public void func_70103_a(byte p_70103_1_) {
-      switch(p_70103_1_) {
-      case 2:
-      case 33:
-      case 36:
-      case 37:
-      case 44:
-         boolean flag1 = p_70103_1_ == 33;
-         boolean flag2 = p_70103_1_ == 36;
-         boolean flag3 = p_70103_1_ == 37;
-         boolean flag = p_70103_1_ == 44;
-         this.field_70721_aZ = 1.5F;
-         this.field_70172_ad = 20;
-         this.field_70738_aO = 10;
-         this.field_70737_aN = this.field_70738_aO;
-         this.field_70739_aP = 0.0F;
-         if (flag1) {
-            this.func_184185_a(SoundEvents.field_187903_gc, this.func_70599_aP(), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
-         }
-
-         DamageSource damagesource;
-         if (flag3) {
-            damagesource = DamageSource.field_76370_b;
-         } else if (flag2) {
-            damagesource = DamageSource.field_76369_e;
-         } else if (flag) {
-            damagesource = DamageSource.field_220302_v;
-         } else {
-            damagesource = DamageSource.field_76377_j;
-         }
-
-         SoundEvent soundevent1 = this.func_184601_bQ(damagesource);
-         if (soundevent1 != null) {
-            this.func_184185_a(soundevent1, this.func_70599_aP(), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
-         }
-
-         this.func_70097_a(DamageSource.field_76377_j, 0.0F);
-         break;
-      case 3:
-         SoundEvent soundevent = this.func_184615_bR();
-         if (soundevent != null) {
-            this.func_184185_a(soundevent, this.func_70599_aP(), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
-         }
-
-         if (!(this instanceof PlayerEntity)) {
-            this.func_70606_j(0.0F);
-            this.func_70645_a(DamageSource.field_76377_j);
-         }
-         break;
-      case 4:
-      case 5:
-      case 6:
-      case 7:
-      case 8:
-      case 9:
-      case 10:
-      case 11:
-      case 12:
-      case 13:
-      case 14:
-      case 15:
-      case 16:
-      case 17:
-      case 18:
-      case 19:
-      case 20:
-      case 21:
-      case 22:
-      case 23:
-      case 24:
-      case 25:
-      case 26:
-      case 27:
-      case 28:
-      case 31:
-      case 32:
-      case 34:
-      case 35:
-      case 38:
-      case 39:
-      case 40:
-      case 41:
-      case 42:
-      case 43:
-      case 45:
-      case 53:
-      default:
-         super.func_70103_a(p_70103_1_);
-         break;
-      case 29:
-         this.func_184185_a(SoundEvents.field_187767_eL, 1.0F, 0.8F + this.field_70170_p.field_73012_v.nextFloat() * 0.4F);
-         break;
-      case 30:
-         this.func_184185_a(SoundEvents.field_187769_eM, 0.8F, 0.8F + this.field_70170_p.field_73012_v.nextFloat() * 0.4F);
-         break;
-      case 46:
-         int i = 128;
-
-         for(int j = 0; j < 128; ++j) {
-            double d0 = (double)j / 127.0D;
-            float f = (this.field_70146_Z.nextFloat() - 0.5F) * 0.2F;
-            float f1 = (this.field_70146_Z.nextFloat() - 0.5F) * 0.2F;
-            float f2 = (this.field_70146_Z.nextFloat() - 0.5F) * 0.2F;
-            double d1 = MathHelper.func_219803_d(d0, this.field_70169_q, this.func_226277_ct_()) + (this.field_70146_Z.nextDouble() - 0.5D) * (double)this.func_213311_cf() * 2.0D;
-            double d2 = MathHelper.func_219803_d(d0, this.field_70167_r, this.func_226278_cu_()) + this.field_70146_Z.nextDouble() * (double)this.func_213302_cg();
-            double d3 = MathHelper.func_219803_d(d0, this.field_70166_s, this.func_226281_cx_()) + (this.field_70146_Z.nextDouble() - 0.5D) * (double)this.func_213311_cf() * 2.0D;
-            this.field_70170_p.func_195594_a(ParticleTypes.field_197599_J, d1, d2, d3, (double)f, (double)f1, (double)f2);
-         }
-         break;
-      case 47:
-         this.func_70669_a(this.func_184582_a(EquipmentSlotType.MAINHAND));
-         break;
-      case 48:
-         this.func_70669_a(this.func_184582_a(EquipmentSlotType.OFFHAND));
-         break;
-      case 49:
-         this.func_70669_a(this.func_184582_a(EquipmentSlotType.HEAD));
-         break;
-      case 50:
-         this.func_70669_a(this.func_184582_a(EquipmentSlotType.CHEST));
-         break;
-      case 51:
-         this.func_70669_a(this.func_184582_a(EquipmentSlotType.LEGS));
-         break;
-      case 52:
-         this.func_70669_a(this.func_184582_a(EquipmentSlotType.FEET));
-         break;
-      case 54:
-         HoneyBlock.func_226936_b_(this);
-         break;
-      case 55:
-         this.func_241352_p_();
-      }
-
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   private void func_241352_p_() {
-      ItemStack itemstack = this.func_184582_a(EquipmentSlotType.OFFHAND);
-      this.func_184201_a(EquipmentSlotType.OFFHAND, this.func_184582_a(EquipmentSlotType.MAINHAND));
-      this.func_184201_a(EquipmentSlotType.MAINHAND, itemstack);
-   }
-
-   protected void func_70076_C() {
-      this.func_70097_a(DamageSource.field_76380_i, 4.0F);
-   }
-
-   protected void func_82168_bl() {
-      int i = this.func_82166_i();
-      if (this.field_82175_bq) {
-         ++this.field_110158_av;
-         if (this.field_110158_av >= i) {
+        } else {
+            if (this.func_70644_a(Effects.field_76429_m) && p_70672_1_ != DamageSource.field_76380_i) {
+                int i = (this.func_70660_b(Effects.field_76429_m).func_76458_c() + 1) * 5;
+                int j = 25 - i;
+                float f = p_70672_2_ * (float) j;
+                float f1 = p_70672_2_;
+                p_70672_2_ = Math.max(f / 25.0F, 0.0F);
+                float f2 = f1 - p_70672_2_;
+                if (f2 > 0.0F && f2 < 3.4028235E37F) {
+                    if (this instanceof ServerPlayerEntity) {
+                        ((ServerPlayerEntity) this).func_195067_a(Stats.field_212739_K, Math.round(f2 * 10.0F));
+                    } else if (p_70672_1_.func_76346_g() instanceof ServerPlayerEntity) {
+                        ((ServerPlayerEntity) p_70672_1_.func_76346_g()).func_195067_a(Stats.field_212736_G, Math.round(f2 * 10.0F));
+                    }
+                }
+            }
+
+            if (p_70672_2_ <= 0.0F) {
+                return 0.0F;
+            } else {
+                int k = EnchantmentHelper.func_77508_a(this.func_184193_aE(), p_70672_1_);
+                if (k > 0) {
+                    p_70672_2_ = CombatRules.func_188401_b(p_70672_2_, (float) k);
+                }
+
+                return p_70672_2_;
+            }
+        }
+    }
+
+    protected void func_70665_d(DamageSource p_70665_1_, float p_70665_2_) {
+        damageEntity0(p_70665_1_, p_70665_2_);
+    }
+
+    // CraftBukkit start
+    protected boolean damageEntity0(final DamageSource damagesource, float f) { // void -> boolean, add final
+        if (!this.func_180431_b(damagesource)) {
+            final boolean human = this instanceof PlayerEntity;
+            if (!human || f > 0) {
+                f = net.minecraftforge.common.ForgeHooks.onLivingHurt(this, damagesource, f);
+                if (f <= 0) return true;
+            }
+            float originalDamage = f;
+            Function<Double, Double> hardHat = new Function<Double, Double>() {
+                @Override
+                public Double apply(Double f) {
+                    if ((damagesource == DamageSource.field_82728_o || damagesource == DamageSource.field_82729_p) && !LivingEntity.this.func_184582_a(EquipmentSlotType.HEAD).func_190926_b()) {
+                        return -(f - (f * 0.75F));
+                    }
+                    return -0.0;
+                }
+            };
+            float hardHatModifier = hardHat.apply((double) f).floatValue();
+            f += hardHatModifier;
+
+            Function<Double, Double> blocking = new Function<Double, Double>() {
+                @Override
+                public Double apply(Double f) {
+                    return -((LivingEntity.this.func_184583_d(damagesource)) ? f : 0.0);
+                }
+            };
+            float blockingModifier = blocking.apply((double) f).floatValue();
+            f += blockingModifier;
+
+            // Mohist start - Prevent armor break if event is cancelled
+            float dmgPreArmor = f;
+            Function<Double, Double> armor = new Function<Double, Double>() {
+                @Override
+                public Double apply(Double f) {
+                    return -(f - LivingEntity.this.getDamageAfterArmorAbsorb(damagesource, f.floatValue(), true));
+                }
+            };
+            // Mohist end
+            float armorModifier = armor.apply((double) f).floatValue();
+            f += armorModifier;
+
+            Function<Double, Double> resistance = new Function<Double, Double>() {
+                @Override
+                public Double apply(Double f) {
+                    if (!damagesource.func_151517_h() && LivingEntity.this.func_70644_a(Effects.field_76429_m) && damagesource != DamageSource.field_76380_i) {
+                        int i = (LivingEntity.this.func_70660_b(Effects.field_76429_m).func_76458_c() + 1) * 5;
+                        int j = 25 - i;
+                        float f1 = f.floatValue() * (float) j;
+                        return -(f - (f1 / 25.0F));
+                    }
+                    return -0.0;
+                }
+            };
+            float resistanceModifier = resistance.apply((double) f).floatValue();
+            f += resistanceModifier;
+
+            Function<Double, Double> magic = new Function<Double, Double>() {
+                @Override
+                public Double apply(Double f) {
+                    return -(f - LivingEntity.this.func_70672_c(damagesource, f.floatValue()));
+                }
+            };
+            float magicModifier = magic.apply((double) f).floatValue();
+            f += magicModifier;
+
+            Function<Double, Double> absorption = new Function<Double, Double>() {
+                @Override
+                public Double apply(Double f) {
+                    return -(Math.max(f - Math.max(f - LivingEntity.this.func_110139_bj(), 0.0F), 0.0F));
+                }
+            };
+            float absorptionModifier = absorption.apply((double) f).floatValue();
+
+            EntityDamageEvent event = CraftEventFactory.handleLivingEntityDamageEvent(this, damagesource, originalDamage, hardHatModifier, blockingModifier, armorModifier, resistanceModifier, magicModifier, absorptionModifier, hardHat, blocking, armor, resistance, magic, absorption);
+            if (damagesource.func_76346_g() instanceof PlayerEntity) {
+                ((PlayerEntity) damagesource.func_76346_g()).func_184821_cY(); // Moved from EntityHuman in order to make the cooldown reset get called after the damage event is fired
+            }
+            if (event.isCancelled()) {
+                return false;
+            }
+            // Mohist start - Prevent armor break if event is cancelled
+            else if (!damagesource.func_76363_c()) {
+                this.func_230294_b_(damagesource, dmgPreArmor);
+            }
+            // Mohist end
+
+            f = (float) event.getFinalDamage();
+
+            // Resistance
+            if (event.getDamage(EntityDamageEvent.DamageModifier.RESISTANCE) < 0) {
+                float f3 = (float) -event.getDamage(EntityDamageEvent.DamageModifier.RESISTANCE);
+                if (f3 > 0.0F && f3 < 3.4028235E37F) {
+                    if (this instanceof ServerPlayerEntity) {
+                        ((ServerPlayerEntity) this).func_195067_a(Stats.field_212739_K, Math.round(f3 * 10.0F));
+                    } else if (damagesource.func_76346_g() instanceof ServerPlayerEntity) {
+                        ((ServerPlayerEntity) damagesource.func_76346_g()).func_195067_a(Stats.field_212736_G, Math.round(f3 * 10.0F));
+                    }
+                }
+            }
+
+
+            // Apply damage to helmet
+            if ((damagesource == DamageSource.field_82728_o || damagesource == DamageSource.field_82729_p) && this.func_184582_a(EquipmentSlotType.HEAD) != null) {
+                this.func_184582_a(EquipmentSlotType.HEAD).func_222118_a((int) (event.getDamage() * 4.0F + this.field_70146_Z.nextFloat() * event.getDamage() * 2.0F), this, (entityliving) -> {
+                    entityliving.func_213361_c(EquipmentSlotType.HEAD);
+                });
+            }
+
+            // Apply damage to armor
+            if (!human && !damagesource.func_76363_c()) {
+                float armorDamage = (float) (event.getDamage() + event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING) + event.getDamage(EntityDamageEvent.DamageModifier.HARD_HAT));
+                this.func_230294_b_(damagesource, armorDamage);
+            }
+
+            // Apply blocking code // PAIL: steal from above
+            if (event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING) < 0) {
+                this.field_70170_p.func_72960_a(this, (byte) 29); // SPIGOT-4635 - shield damage sound
+                this.func_184590_k((float) -event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING));
+                Entity entity = damagesource.func_76364_f();
+
+                if (entity instanceof LivingEntity) {
+                    this.func_190629_c((LivingEntity) entity);
+                }
+            }
+
+            absorptionModifier = (float) -event.getDamage(EntityDamageEvent.DamageModifier.ABSORPTION);
+            this.func_110149_m(Math.max(this.func_110139_bj() - absorptionModifier, 0.0F));
+            f = ForgeHooks.onLivingDamage(this, damagesource, (float) event.getFinalDamage());
+            float f2 = absorptionModifier;
+            if (f2 > 0.0F && f2 < 3.4028235E37F && this instanceof PlayerEntity) {
+                ((PlayerEntity) this).func_195067_a(Stats.field_212738_J, Math.round(f2 * 10.0F));
+            }
+            if (f2 > 0.0F && f2 < 3.4028235E37F && damagesource.func_76346_g() instanceof ServerPlayerEntity) {
+                ((ServerPlayerEntity) damagesource.func_76346_g()).func_195067_a(Stats.field_212735_F, Math.round(f2 * 10.0F));
+            }
+            if (f > 0 || !human) {
+                if (human) {
+                    // PAIL: Be sure to drag all this code from the EntityPlayer subclass each update.
+                    ((PlayerEntity) this).withExhaustionReason(org.bukkit.event.entity.EntityExhaustionEvent.ExhaustionReason.DAMAGED);
+                    ((PlayerEntity) this).func_71020_j(damagesource.func_76345_d());
+                    ((PlayerEntity) this).setDefaultExhaustionReason();
+                    if (f < 3.4028235E37F) {
+                        ((PlayerEntity) this).func_195067_a(Stats.field_188112_z, Math.round(f * 10.0F));
+                    }
+                }
+                // CraftBukkit end
+                float f3 = this.func_110143_aJ();
+
+                this.func_70606_j(f3 - f);
+                this.func_110142_aN().func_94547_a(damagesource, f3, f);
+                // CraftBukkit start
+                if (!human) {
+                    this.func_110149_m(this.func_110139_bj() - f);
+                }
+
+                return true;
+            } else {
+                // Duplicate triggers if blocking
+                if (event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING) < 0) {
+                    if (this instanceof ServerPlayerEntity) {
+                        CriteriaTriggers.field_192128_h.func_192200_a((ServerPlayerEntity) this, damagesource, f, originalDamage, true);
+                        f2 = (float) -event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING);
+                        if (f2 > 0.0F && f2 < 3.4028235E37F) {
+                            ((ServerPlayerEntity) this).func_195067_a(Stats.field_212737_I, Math.round(originalDamage * 10.0F));
+                        }
+                    }
+
+                    if (damagesource.func_76346_g() instanceof ServerPlayerEntity) {
+                        CriteriaTriggers.field_192127_g.func_192220_a((ServerPlayerEntity) damagesource.func_76346_g(), this, damagesource, f, originalDamage, true);
+                    }
+
+                    return false;
+                } else {
+                    return originalDamage > 0;
+                }
+                // CraftBukkit end
+            }
+        }
+        return false; // CraftBukkit
+    }
+
+    public CombatTracker func_110142_aN() {
+        return this.field_94063_bt;
+    }
+
+    @Nullable
+    public LivingEntity func_94060_bK() {
+        if (this.field_94063_bt.func_94550_c() != null) {
+            return this.field_94063_bt.func_94550_c();
+        } else if (this.field_70717_bb != null) {
+            return this.field_70717_bb;
+        } else {
+            return this.field_70755_b != null ? this.field_70755_b : null;
+        }
+    }
+
+    public final float func_110138_aP() {
+        return (float) this.func_233637_b_(Attributes.field_233818_a_);
+    }
+
+    public final int func_85035_bI() {
+        return this.field_70180_af.func_187225_a(field_184635_h);
+    }
+
+    public final void func_85034_r(int p_85034_1_) {
+        // CraftBukkit start
+        setArrowCountInEntity(p_85034_1_, false);
+    }
+
+    public final void setArrowCountInEntity(int count, boolean flag) {
+        ArrowBodyCountChangeEvent event = CraftEventFactory.callArrowBodyCountChangeEvent(this, func_85035_bI(), count, flag);
+        if (event.isCancelled()) {
+            return;
+        }
+        this.field_70180_af.func_187227_b(field_184635_h, count);
+    }
+
+    public final int func_226297_df_() {
+        return this.field_70180_af.func_187225_a(field_226291_bp_);
+    }
+
+    public final void func_226300_q_(int p_226300_1_) {
+        this.field_70180_af.func_187227_b(field_226291_bp_, p_226300_1_);
+    }
+
+    private int func_82166_i() {
+        if (EffectUtils.func_205135_a(this)) {
+            return 6 - (1 + EffectUtils.func_205134_b(this));
+        } else {
+            return this.func_70644_a(Effects.field_76419_f) ? 6 + (1 + this.func_70660_b(Effects.field_76419_f).func_76458_c()) * 2 : 6;
+        }
+    }
+
+    public void func_184609_a(Hand p_184609_1_) {
+        this.func_226292_a_(p_184609_1_, false);
+    }
+
+    public void func_226292_a_(Hand p_226292_1_, boolean p_226292_2_) {
+        ItemStack stack = this.func_184586_b(p_226292_1_);
+        if (!stack.func_190926_b() && stack.onEntitySwing(this)) return;
+        if (!this.field_82175_bq || this.field_110158_av >= this.func_82166_i() / 2 || this.field_110158_av < 0) {
+            this.field_110158_av = -1;
+            this.field_82175_bq = true;
+            this.field_184622_au = p_226292_1_;
+            if (this.field_70170_p instanceof ServerWorld) {
+                SAnimateHandPacket sanimatehandpacket = new SAnimateHandPacket(this, p_226292_1_ == Hand.MAIN_HAND ? 0 : 3);
+                ServerChunkProvider serverchunkprovider = ((ServerWorld) this.field_70170_p).func_72863_F();
+                if (p_226292_2_) {
+                    serverchunkprovider.func_217216_a(this, sanimatehandpacket);
+                } else {
+                    serverchunkprovider.func_217218_b(this, sanimatehandpacket);
+                }
+            }
+        }
+
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public void func_70103_a(byte p_70103_1_) {
+        switch (p_70103_1_) {
+            case 2:
+            case 33:
+            case 36:
+            case 37:
+            case 44:
+                boolean flag1 = p_70103_1_ == 33;
+                boolean flag2 = p_70103_1_ == 36;
+                boolean flag3 = p_70103_1_ == 37;
+                boolean flag = p_70103_1_ == 44;
+                this.field_70721_aZ = 1.5F;
+                this.field_70172_ad = 20;
+                this.field_70738_aO = 10;
+                this.field_70737_aN = this.field_70738_aO;
+                this.field_70739_aP = 0.0F;
+                if (flag1) {
+                    this.func_184185_a(SoundEvents.field_187903_gc, this.func_70599_aP(), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
+                }
+
+                DamageSource damagesource;
+                if (flag3) {
+                    damagesource = DamageSource.field_76370_b;
+                } else if (flag2) {
+                    damagesource = DamageSource.field_76369_e;
+                } else if (flag) {
+                    damagesource = DamageSource.field_220302_v;
+                } else {
+                    damagesource = DamageSource.field_76377_j;
+                }
+
+                SoundEvent soundevent1 = this.func_184601_bQ(damagesource);
+                if (soundevent1 != null) {
+                    this.func_184185_a(soundevent1, this.func_70599_aP(), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
+                }
+
+                this.func_70097_a(DamageSource.field_76377_j, 0.0F);
+                break;
+            case 3:
+                SoundEvent soundevent = this.func_184615_bR();
+                if (soundevent != null) {
+                    this.func_184185_a(soundevent, this.func_70599_aP(), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
+                }
+
+                if (!(this instanceof PlayerEntity)) {
+                    this.func_70606_j(0.0F);
+                    this.func_70645_a(DamageSource.field_76377_j);
+                }
+                break;
+            case 4:
+            case 5:
+            case 6:
+            case 7:
+            case 8:
+            case 9:
+            case 10:
+            case 11:
+            case 12:
+            case 13:
+            case 14:
+            case 15:
+            case 16:
+            case 17:
+            case 18:
+            case 19:
+            case 20:
+            case 21:
+            case 22:
+            case 23:
+            case 24:
+            case 25:
+            case 26:
+            case 27:
+            case 28:
+            case 31:
+            case 32:
+            case 34:
+            case 35:
+            case 38:
+            case 39:
+            case 40:
+            case 41:
+            case 42:
+            case 43:
+            case 45:
+            case 53:
+            default:
+                super.func_70103_a(p_70103_1_);
+                break;
+            case 29:
+                this.func_184185_a(SoundEvents.field_187767_eL, 1.0F, 0.8F + this.field_70170_p.field_73012_v.nextFloat() * 0.4F);
+                break;
+            case 30:
+                this.func_184185_a(SoundEvents.field_187769_eM, 0.8F, 0.8F + this.field_70170_p.field_73012_v.nextFloat() * 0.4F);
+                break;
+            case 46:
+                int i = 128;
+
+                for (int j = 0; j < 128; ++j) {
+                    double d0 = (double) j / 127.0D;
+                    float f = (this.field_70146_Z.nextFloat() - 0.5F) * 0.2F;
+                    float f1 = (this.field_70146_Z.nextFloat() - 0.5F) * 0.2F;
+                    float f2 = (this.field_70146_Z.nextFloat() - 0.5F) * 0.2F;
+                    double d1 = MathHelper.func_219803_d(d0, this.field_70169_q, this.func_226277_ct_()) + (this.field_70146_Z.nextDouble() - 0.5D) * (double) this.func_213311_cf() * 2.0D;
+                    double d2 = MathHelper.func_219803_d(d0, this.field_70167_r, this.func_226278_cu_()) + this.field_70146_Z.nextDouble() * (double) this.func_213302_cg();
+                    double d3 = MathHelper.func_219803_d(d0, this.field_70166_s, this.func_226281_cx_()) + (this.field_70146_Z.nextDouble() - 0.5D) * (double) this.func_213311_cf() * 2.0D;
+                    this.field_70170_p.func_195594_a(ParticleTypes.field_197599_J, d1, d2, d3, f, f1, f2);
+                }
+                break;
+            case 47:
+                this.func_70669_a(this.func_184582_a(EquipmentSlotType.MAINHAND));
+                break;
+            case 48:
+                this.func_70669_a(this.func_184582_a(EquipmentSlotType.OFFHAND));
+                break;
+            case 49:
+                this.func_70669_a(this.func_184582_a(EquipmentSlotType.HEAD));
+                break;
+            case 50:
+                this.func_70669_a(this.func_184582_a(EquipmentSlotType.CHEST));
+                break;
+            case 51:
+                this.func_70669_a(this.func_184582_a(EquipmentSlotType.LEGS));
+                break;
+            case 52:
+                this.func_70669_a(this.func_184582_a(EquipmentSlotType.FEET));
+                break;
+            case 54:
+                HoneyBlock.func_226936_b_(this);
+                break;
+            case 55:
+                this.func_241352_p_();
+        }
+
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    private void func_241352_p_() {
+        ItemStack itemstack = this.func_184582_a(EquipmentSlotType.OFFHAND);
+        this.func_184201_a(EquipmentSlotType.OFFHAND, this.func_184582_a(EquipmentSlotType.MAINHAND));
+        this.func_184201_a(EquipmentSlotType.MAINHAND, itemstack);
+    }
+
+    protected void func_70076_C() {
+        this.func_70097_a(DamageSource.field_76380_i, 4.0F);
+    }
+
+    protected void func_82168_bl() {
+        int i = this.func_82166_i();
+        if (this.field_82175_bq) {
+            ++this.field_110158_av;
+            if (this.field_110158_av >= i) {
+                this.field_110158_av = 0;
+                this.field_82175_bq = false;
+            }
+        } else {
             this.field_110158_av = 0;
-            this.field_82175_bq = false;
-         }
-      } else {
-         this.field_110158_av = 0;
-      }
-
-      this.field_70733_aJ = (float)this.field_110158_av / (float)i;
-   }
-
-   @Nullable
-   public ModifiableAttributeInstance func_110148_a(Attribute p_110148_1_) {
-      return this.func_233645_dx_().func_233779_a_(p_110148_1_);
-   }
-
-   public double func_233637_b_(Attribute p_233637_1_) {
-      return this.func_233645_dx_().func_233795_c_(p_233637_1_);
-   }
-
-   public double func_233638_c_(Attribute p_233638_1_) {
-      return this.func_233645_dx_().func_233797_d_(p_233638_1_);
-   }
-
-   public AttributeModifierManager func_233645_dx_() {
-      return this.field_110155_d;
-   }
-
-   public CreatureAttribute func_70668_bt() {
-      return CreatureAttribute.field_223222_a_;
-   }
-
-   public ItemStack func_184614_ca() {
-      return this.func_184582_a(EquipmentSlotType.MAINHAND);
-   }
-
-   public ItemStack func_184592_cb() {
-      return this.func_184582_a(EquipmentSlotType.OFFHAND);
-   }
-
-   public boolean func_233631_a_(Item p_233631_1_) {
-      return this.func_233634_a_((p_233632_1_) -> {
-         return p_233632_1_ == p_233631_1_;
-      });
-   }
-
-   public boolean func_233634_a_(Predicate<Item> p_233634_1_) {
-      return p_233634_1_.test(this.func_184614_ca().func_77973_b()) || p_233634_1_.test(this.func_184592_cb().func_77973_b());
-   }
-
-   public ItemStack func_184586_b(Hand p_184586_1_) {
-      if (p_184586_1_ == Hand.MAIN_HAND) {
-         return this.func_184582_a(EquipmentSlotType.MAINHAND);
-      } else if (p_184586_1_ == Hand.OFF_HAND) {
-         return this.func_184582_a(EquipmentSlotType.OFFHAND);
-      } else {
-         throw new IllegalArgumentException("Invalid hand " + p_184586_1_);
-      }
-   }
-
-   public void func_184611_a(Hand p_184611_1_, ItemStack p_184611_2_) {
-      if (p_184611_1_ == Hand.MAIN_HAND) {
-         this.func_184201_a(EquipmentSlotType.MAINHAND, p_184611_2_);
-      } else {
-         if (p_184611_1_ != Hand.OFF_HAND) {
-            throw new IllegalArgumentException("Invalid hand " + p_184611_1_);
-         }
-
-         this.func_184201_a(EquipmentSlotType.OFFHAND, p_184611_2_);
-      }
-
-   }
-
-   public boolean func_190630_a(EquipmentSlotType p_190630_1_) {
-      return !this.func_184582_a(p_190630_1_).func_190926_b();
-   }
-
-   public abstract Iterable<ItemStack> func_184193_aE();
-
-   public abstract ItemStack func_184582_a(EquipmentSlotType p_184582_1_);
-
-   public abstract void func_184201_a(EquipmentSlotType p_184201_1_, ItemStack p_184201_2_);
-
-   public float func_213343_cS() {
-      Iterable<ItemStack> iterable = this.func_184193_aE();
-      int i = 0;
-      int j = 0;
-
-      for(ItemStack itemstack : iterable) {
-         if (!itemstack.func_190926_b()) {
-            ++j;
-         }
-
-         ++i;
-      }
-
-      return i > 0 ? (float)j / (float)i : 0.0F;
-   }
-
-   public void func_70031_b(boolean p_70031_1_) {
-      super.func_70031_b(p_70031_1_);
-      ModifiableAttributeInstance modifiableattributeinstance = this.func_110148_a(Attributes.field_233821_d_);
-      if (modifiableattributeinstance.func_111127_a(field_110156_b) != null) {
-         modifiableattributeinstance.func_111124_b(field_110157_c);
-      }
-
-      if (p_70031_1_) {
-         modifiableattributeinstance.func_233767_b_(field_110157_c);
-      }
-
-   }
-
-   protected float func_70599_aP() {
-      return 1.0F;
-   }
-
-   protected float func_70647_i() {
-      return this.func_70631_g_() ? (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.5F : (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F;
-   }
-
-   protected boolean func_70610_aX() {
-      return this.func_233643_dh_();
-   }
-
-   public void func_70108_f(Entity p_70108_1_) {
-      if (!this.func_70608_bn()) {
-         super.func_70108_f(p_70108_1_);
-      }
-
-   }
-
-   private void func_233628_a_(Entity p_233628_1_) {
-      Vector3d vector3d;
-      if (!p_233628_1_.field_70128_L && !this.field_70170_p.func_180495_p(p_233628_1_.func_233580_cy_()).func_177230_c().func_203417_a(BlockTags.field_226154_ad_)) {
-         vector3d = p_233628_1_.func_230268_c_(this);
-      } else {
-         vector3d = new Vector3d(p_233628_1_.func_226277_ct_(), p_233628_1_.func_226278_cu_() + (double)p_233628_1_.func_213302_cg(), p_233628_1_.func_226281_cx_());
-      }
-
-      this.func_70634_a(vector3d.field_72450_a, vector3d.field_72448_b, vector3d.field_72449_c);
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public boolean func_94059_bO() {
-      return this.func_174833_aM();
-   }
-
-   protected float func_175134_bD() {
-      return 0.42F * this.func_226269_ah_();
-   }
-
-   protected void func_70664_aZ() {
-      float f = this.func_175134_bD();
-      if (this.func_70644_a(Effects.field_76430_j)) {
-         f += 0.1F * (float)(this.func_70660_b(Effects.field_76430_j).func_76458_c() + 1);
-      }
-
-      Vector3d vector3d = this.func_213322_ci();
-      this.func_213293_j(vector3d.field_72450_a, (double)f, vector3d.field_72449_c);
-      if (this.func_70051_ag()) {
-         float f1 = this.field_70177_z * ((float)Math.PI / 180F);
-         this.func_213317_d(this.func_213322_ci().func_72441_c((double)(-MathHelper.func_76126_a(f1) * 0.2F), 0.0D, (double)(MathHelper.func_76134_b(f1) * 0.2F)));
-      }
-
-      this.field_70160_al = true;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   protected void func_203010_cG() {
-      this.func_213317_d(this.func_213322_ci().func_72441_c(0.0D, (double)-0.04F, 0.0D));
-   }
-
-   protected void func_180466_bG(ITag<Fluid> p_180466_1_) {
-      this.func_213317_d(this.func_213322_ci().func_72441_c(0.0D, (double)0.04F, 0.0D));
-   }
-
-   protected float func_189749_co() {
-      return 0.8F;
-   }
-
-   public boolean func_230285_a_(Fluid p_230285_1_) {
-      return false;
-   }
-
-   public void func_213352_e(Vector3d p_213352_1_) {
-      if (this.func_70613_aW() || this.func_184186_bw()) {
-         double d0 = 0.08D;
-         boolean flag = this.func_213322_ci().field_72448_b <= 0.0D;
-         if (flag && this.func_70644_a(Effects.field_204839_B)) {
-            d0 = 0.01D;
-            this.field_70143_R = 0.0F;
-         }
-
-         FluidState fluidstate = this.field_70170_p.func_204610_c(this.func_233580_cy_());
-         if (this.func_70090_H() && this.func_241208_cS_() && !this.func_230285_a_(fluidstate.func_206886_c())) {
-            double d8 = this.func_226278_cu_();
-            float f5 = this.func_70051_ag() ? 0.9F : this.func_189749_co();
-            float f6 = 0.02F;
-            float f7 = (float)EnchantmentHelper.func_185294_d(this);
-            if (f7 > 3.0F) {
-               f7 = 3.0F;
-            }
-
-            if (!this.field_70122_E) {
-               f7 *= 0.5F;
-            }
-
-            if (f7 > 0.0F) {
-               f5 += (0.54600006F - f5) * f7 / 3.0F;
-               f6 += (this.func_70689_ay() - f6) * f7 / 3.0F;
-            }
-
-            if (this.func_70644_a(Effects.field_206827_D)) {
-               f5 = 0.96F;
-            }
-
-            this.func_213309_a(f6, p_213352_1_);
-            this.func_213315_a(MoverType.SELF, this.func_213322_ci());
-            Vector3d vector3d6 = this.func_213322_ci();
-            if (this.field_70123_F && this.func_70617_f_()) {
-               vector3d6 = new Vector3d(vector3d6.field_72450_a, 0.2D, vector3d6.field_72449_c);
-            }
-
-            this.func_213317_d(vector3d6.func_216372_d((double)f5, (double)0.8F, (double)f5));
-            Vector3d vector3d2 = this.func_233626_a_(d0, flag, this.func_213322_ci());
-            this.func_213317_d(vector3d2);
-            if (this.field_70123_F && this.func_70038_c(vector3d2.field_72450_a, vector3d2.field_72448_b + (double)0.6F - this.func_226278_cu_() + d8, vector3d2.field_72449_c)) {
-               this.func_213293_j(vector3d2.field_72450_a, (double)0.3F, vector3d2.field_72449_c);
-            }
-         } else if (this.func_180799_ab() && this.func_241208_cS_() && !this.func_230285_a_(fluidstate.func_206886_c())) {
-            double d7 = this.func_226278_cu_();
-            this.func_213309_a(0.02F, p_213352_1_);
-            this.func_213315_a(MoverType.SELF, this.func_213322_ci());
-            if (this.func_233571_b_(FluidTags.field_206960_b) <= this.func_233579_cu_()) {
-               this.func_213317_d(this.func_213322_ci().func_216372_d(0.5D, (double)0.8F, 0.5D));
-               Vector3d vector3d3 = this.func_233626_a_(d0, flag, this.func_213322_ci());
-               this.func_213317_d(vector3d3);
-            } else {
-               this.func_213317_d(this.func_213322_ci().func_186678_a(0.5D));
-            }
-
-            if (!this.func_189652_ae()) {
-               this.func_213317_d(this.func_213322_ci().func_72441_c(0.0D, -d0 / 4.0D, 0.0D));
-            }
-
-            Vector3d vector3d4 = this.func_213322_ci();
-            if (this.field_70123_F && this.func_70038_c(vector3d4.field_72450_a, vector3d4.field_72448_b + (double)0.6F - this.func_226278_cu_() + d7, vector3d4.field_72449_c)) {
-               this.func_213293_j(vector3d4.field_72450_a, (double)0.3F, vector3d4.field_72449_c);
-            }
-         } else if (this.func_184613_cA()) {
-            Vector3d vector3d = this.func_213322_ci();
-            if (vector3d.field_72448_b > -0.5D) {
-               this.field_70143_R = 1.0F;
-            }
-
-            Vector3d vector3d1 = this.func_70040_Z();
-            float f = this.field_70125_A * ((float)Math.PI / 180F);
-            double d1 = Math.sqrt(vector3d1.field_72450_a * vector3d1.field_72450_a + vector3d1.field_72449_c * vector3d1.field_72449_c);
-            double d3 = Math.sqrt(func_213296_b(vector3d));
-            double d4 = vector3d1.func_72433_c();
-            float f1 = MathHelper.func_76134_b(f);
-            f1 = (float)((double)f1 * (double)f1 * Math.min(1.0D, d4 / 0.4D));
-            vector3d = this.func_213322_ci().func_72441_c(0.0D, d0 * (-1.0D + (double)f1 * 0.75D), 0.0D);
-            if (vector3d.field_72448_b < 0.0D && d1 > 0.0D) {
-               double d5 = vector3d.field_72448_b * -0.1D * (double)f1;
-               vector3d = vector3d.func_72441_c(vector3d1.field_72450_a * d5 / d1, d5, vector3d1.field_72449_c * d5 / d1);
-            }
-
-            if (f < 0.0F && d1 > 0.0D) {
-               double d9 = d3 * (double)(-MathHelper.func_76126_a(f)) * 0.04D;
-               vector3d = vector3d.func_72441_c(-vector3d1.field_72450_a * d9 / d1, d9 * 3.2D, -vector3d1.field_72449_c * d9 / d1);
-            }
-
-            if (d1 > 0.0D) {
-               vector3d = vector3d.func_72441_c((vector3d1.field_72450_a / d1 * d3 - vector3d.field_72450_a) * 0.1D, 0.0D, (vector3d1.field_72449_c / d1 * d3 - vector3d.field_72449_c) * 0.1D);
-            }
-
-            this.func_213317_d(vector3d.func_216372_d((double)0.99F, (double)0.98F, (double)0.99F));
-            this.func_213315_a(MoverType.SELF, this.func_213322_ci());
-            if (this.field_70123_F && !this.field_70170_p.field_72995_K) {
-               double d10 = Math.sqrt(func_213296_b(this.func_213322_ci()));
-               double d6 = d3 - d10;
-               float f2 = (float)(d6 * 10.0D - 3.0D);
-               if (f2 > 0.0F) {
-                  this.func_184185_a(this.func_184588_d((int)f2), 1.0F, 1.0F);
-                  this.func_70097_a(DamageSource.field_188406_j, f2);
-               }
-            }
-
-            if (this.field_70122_E && !this.field_70170_p.field_72995_K) {
-               this.func_70052_a(7, false);
-            }
-         } else {
-            BlockPos blockpos = this.func_226270_aj_();
-            float f3 = this.field_70170_p.func_180495_p(blockpos).func_177230_c().func_208618_m();
-            float f4 = this.field_70122_E ? f3 * 0.91F : 0.91F;
-            Vector3d vector3d5 = this.func_233633_a_(p_213352_1_, f3);
-            double d2 = vector3d5.field_72448_b;
-            if (this.func_70644_a(Effects.field_188424_y)) {
-               d2 += (0.05D * (double)(this.func_70660_b(Effects.field_188424_y).func_76458_c() + 1) - vector3d5.field_72448_b) * 0.2D;
-               this.field_70143_R = 0.0F;
-            } else if (this.field_70170_p.field_72995_K && !this.field_70170_p.func_175667_e(blockpos)) {
-               if (this.func_226278_cu_() > 0.0D) {
-                  d2 = -0.1D;
-               } else {
-                  d2 = 0.0D;
-               }
-            } else if (!this.func_189652_ae()) {
-               d2 -= d0;
-            }
-
-            this.func_213293_j(vector3d5.field_72450_a * (double)f4, d2 * (double)0.98F, vector3d5.field_72449_c * (double)f4);
-         }
-      }
-
-      this.func_233629_a_(this, this instanceof IFlyingAnimal);
-   }
-
-   public void func_233629_a_(LivingEntity p_233629_1_, boolean p_233629_2_) {
-      p_233629_1_.field_184618_aE = p_233629_1_.field_70721_aZ;
-      double d0 = p_233629_1_.func_226277_ct_() - p_233629_1_.field_70169_q;
-      double d1 = p_233629_2_ ? p_233629_1_.func_226278_cu_() - p_233629_1_.field_70167_r : 0.0D;
-      double d2 = p_233629_1_.func_226281_cx_() - p_233629_1_.field_70166_s;
-      float f = MathHelper.func_76133_a(d0 * d0 + d1 * d1 + d2 * d2) * 4.0F;
-      if (f > 1.0F) {
-         f = 1.0F;
-      }
-
-      p_233629_1_.field_70721_aZ += (f - p_233629_1_.field_70721_aZ) * 0.4F;
-      p_233629_1_.field_184619_aG += p_233629_1_.field_70721_aZ;
-   }
-
-   public Vector3d func_233633_a_(Vector3d p_233633_1_, float p_233633_2_) {
-      this.func_213309_a(this.func_213335_r(p_233633_2_), p_233633_1_);
-      this.func_213317_d(this.func_213362_f(this.func_213322_ci()));
-      this.func_213315_a(MoverType.SELF, this.func_213322_ci());
-      Vector3d vector3d = this.func_213322_ci();
-      if ((this.field_70123_F || this.field_70703_bu) && this.func_70617_f_()) {
-         vector3d = new Vector3d(vector3d.field_72450_a, 0.2D, vector3d.field_72449_c);
-      }
-
-      return vector3d;
-   }
-
-   public Vector3d func_233626_a_(double p_233626_1_, boolean p_233626_3_, Vector3d p_233626_4_) {
-      if (!this.func_189652_ae() && !this.func_70051_ag()) {
-         double d0;
-         if (p_233626_3_ && Math.abs(p_233626_4_.field_72448_b - 0.005D) >= 0.003D && Math.abs(p_233626_4_.field_72448_b - p_233626_1_ / 16.0D) < 0.003D) {
-            d0 = -0.003D;
-         } else {
-            d0 = p_233626_4_.field_72448_b - p_233626_1_ / 16.0D;
-         }
-
-         return new Vector3d(p_233626_4_.field_72450_a, d0, p_233626_4_.field_72449_c);
-      } else {
-         return p_233626_4_;
-      }
-   }
-
-   private Vector3d func_213362_f(Vector3d p_213362_1_) {
-      if (this.func_70617_f_()) {
-         this.field_70143_R = 0.0F;
-         float f = 0.15F;
-         double d0 = MathHelper.func_151237_a(p_213362_1_.field_72450_a, (double)-0.15F, (double)0.15F);
-         double d1 = MathHelper.func_151237_a(p_213362_1_.field_72449_c, (double)-0.15F, (double)0.15F);
-         double d2 = Math.max(p_213362_1_.field_72448_b, (double)-0.15F);
-         if (d2 < 0.0D && !this.func_213339_cH().func_203425_a(Blocks.field_222420_lI) && this.func_230491_ea_() && this instanceof PlayerEntity) {
-            d2 = 0.0D;
-         }
-
-         p_213362_1_ = new Vector3d(d0, d2, d1);
-      }
-
-      return p_213362_1_;
-   }
-
-   private float func_213335_r(float p_213335_1_) {
-      return this.field_70122_E ? this.func_70689_ay() * (0.21600002F / (p_213335_1_ * p_213335_1_ * p_213335_1_)) : this.field_70747_aH;
-   }
-
-   public float func_70689_ay() {
-      return this.field_70746_aG;
-   }
-
-   public void func_70659_e(float p_70659_1_) {
-      this.field_70746_aG = p_70659_1_;
-   }
-
-   public boolean func_70652_k(Entity p_70652_1_) {
-      this.func_130011_c(p_70652_1_);
-      return false;
-   }
-
-   public void func_70071_h_() {
-      super.func_70071_h_();
-      this.func_184608_ct();
-      this.func_205014_p();
-      if (!this.field_70170_p.field_72995_K) {
-         int i = this.func_85035_bI();
-         if (i > 0) {
-            if (this.field_70720_be <= 0) {
-               this.field_70720_be = 20 * (30 - i);
-            }
-
-            --this.field_70720_be;
-            if (this.field_70720_be <= 0) {
-               this.func_85034_r(i - 1);
-            }
-         }
-
-         int j = this.func_226297_df_();
-         if (j > 0) {
-            if (this.field_226290_au_ <= 0) {
-               this.field_226290_au_ = 20 * (30 - j);
-            }
-
-            --this.field_226290_au_;
-            if (this.field_226290_au_ <= 0) {
-               this.func_226300_q_(j - 1);
-            }
-         }
-
-         this.func_241353_q_();
-         if (this.field_70173_aa % 20 == 0) {
-            this.func_110142_aN().func_94549_h();
-         }
-
-         if (!this.field_184238_ar) {
-            boolean flag = this.func_70644_a(Effects.field_188423_x);
-            if (this.func_70083_f(6) != flag) {
-               this.func_70052_a(6, flag);
-            }
-         }
-
-         if (this.func_70608_bn() && !this.func_213359_p()) {
-            this.func_213366_dy();
-         }
-      }
-
-      this.func_70636_d();
-      double d0 = this.func_226277_ct_() - this.field_70169_q;
-      double d1 = this.func_226281_cx_() - this.field_70166_s;
-      float f = (float)(d0 * d0 + d1 * d1);
-      float f1 = this.field_70761_aq;
-      float f2 = 0.0F;
-      this.field_70768_au = this.field_110154_aX;
-      float f3 = 0.0F;
-      if (f > 0.0025000002F) {
-         f3 = 1.0F;
-         f2 = (float)Math.sqrt((double)f) * 3.0F;
-         float f4 = (float)MathHelper.func_181159_b(d1, d0) * (180F / (float)Math.PI) - 90.0F;
-         float f5 = MathHelper.func_76135_e(MathHelper.func_76142_g(this.field_70177_z) - f4);
-         if (95.0F < f5 && f5 < 265.0F) {
-            f1 = f4 - 180.0F;
-         } else {
-            f1 = f4;
-         }
-      }
-
-      if (this.field_70733_aJ > 0.0F) {
-         f1 = this.field_70177_z;
-      }
-
-      if (!this.field_70122_E) {
-         f3 = 0.0F;
-      }
-
-      this.field_110154_aX += (f3 - this.field_110154_aX) * 0.3F;
-      this.field_70170_p.func_217381_Z().func_76320_a("headTurn");
-      f2 = this.func_110146_f(f1, f2);
-      this.field_70170_p.func_217381_Z().func_76319_b();
-      this.field_70170_p.func_217381_Z().func_76320_a("rangeChecks");
-
-      while(this.field_70177_z - this.field_70126_B < -180.0F) {
-         this.field_70126_B -= 360.0F;
-      }
-
-      while(this.field_70177_z - this.field_70126_B >= 180.0F) {
-         this.field_70126_B += 360.0F;
-      }
-
-      while(this.field_70761_aq - this.field_70760_ar < -180.0F) {
-         this.field_70760_ar -= 360.0F;
-      }
-
-      while(this.field_70761_aq - this.field_70760_ar >= 180.0F) {
-         this.field_70760_ar += 360.0F;
-      }
-
-      while(this.field_70125_A - this.field_70127_C < -180.0F) {
-         this.field_70127_C -= 360.0F;
-      }
-
-      while(this.field_70125_A - this.field_70127_C >= 180.0F) {
-         this.field_70127_C += 360.0F;
-      }
-
-      while(this.field_70759_as - this.field_70758_at < -180.0F) {
-         this.field_70758_at -= 360.0F;
-      }
-
-      while(this.field_70759_as - this.field_70758_at >= 180.0F) {
-         this.field_70758_at += 360.0F;
-      }
-
-      this.field_70170_p.func_217381_Z().func_76319_b();
-      this.field_70764_aw += f2;
-      if (this.func_184613_cA()) {
-         ++this.field_184629_bo;
-      } else {
-         this.field_184629_bo = 0;
-      }
-
-      if (this.func_70608_bn()) {
-         this.field_70125_A = 0.0F;
-      }
-
-   }
-
-   private void func_241353_q_() {
-      Map<EquipmentSlotType, ItemStack> map = this.func_241354_r_();
-      if (map != null) {
-         this.func_241342_a_(map);
-         if (!map.isEmpty()) {
-            this.func_241344_b_(map);
-         }
-      }
-
-   }
-
-   @Nullable
-   private Map<EquipmentSlotType, ItemStack> func_241354_r_() {
-      Map<EquipmentSlotType, ItemStack> map = null;
-
-      for(EquipmentSlotType equipmentslottype : EquipmentSlotType.values()) {
-         ItemStack itemstack;
-         switch(equipmentslottype.func_188453_a()) {
-         case HAND:
-            itemstack = this.func_241347_e_(equipmentslottype);
-            break;
-         case ARMOR:
-            itemstack = this.func_241346_d_(equipmentslottype);
-            break;
-         default:
-            continue;
-         }
-
-         ItemStack itemstack1 = this.func_184582_a(equipmentslottype);
-         if (!ItemStack.func_77989_b(itemstack1, itemstack)) {
-            if (map == null) {
-               map = Maps.newEnumMap(EquipmentSlotType.class);
-            }
-
-            map.put(equipmentslottype, itemstack1);
+        }
+
+        this.field_70733_aJ = (float) this.field_110158_av / (float) i;
+    }
+
+    @Nullable
+    public ModifiableAttributeInstance func_110148_a(Attribute p_110148_1_) {
+        return this.func_233645_dx_().func_233779_a_(p_110148_1_);
+    }
+
+    public double func_233637_b_(Attribute p_233637_1_) {
+        return this.func_233645_dx_().func_233795_c_(p_233637_1_);
+    }
+
+    public double func_233638_c_(Attribute p_233638_1_) {
+        return this.func_233645_dx_().func_233797_d_(p_233638_1_);
+    }
+
+    public AttributeModifierManager func_233645_dx_() {
+        return this.field_110155_d;
+    }
+
+    public CreatureAttribute func_70668_bt() {
+        return CreatureAttribute.field_223222_a_;
+    }
+
+    public ItemStack func_184614_ca() {
+        return this.func_184582_a(EquipmentSlotType.MAINHAND);
+    }
+
+    public ItemStack func_184592_cb() {
+        return this.func_184582_a(EquipmentSlotType.OFFHAND);
+    }
+
+    public boolean func_233631_a_(Item p_233631_1_) {
+        return this.func_233634_a_((p_233632_1_) -> {
+            return p_233632_1_ == p_233631_1_;
+        });
+    }
+
+    public boolean func_233634_a_(Predicate<Item> p_233634_1_) {
+        return p_233634_1_.test(this.func_184614_ca().func_77973_b()) || p_233634_1_.test(this.func_184592_cb().func_77973_b());
+    }
+
+    public ItemStack func_184586_b(Hand p_184586_1_) {
+        if (p_184586_1_ == Hand.MAIN_HAND) {
+            return this.func_184582_a(EquipmentSlotType.MAINHAND);
+        } else if (p_184586_1_ == Hand.OFF_HAND) {
+            return this.func_184582_a(EquipmentSlotType.OFFHAND);
+        } else {
+            throw new IllegalArgumentException("Invalid hand " + p_184586_1_);
+        }
+    }
+
+    public void func_184611_a(Hand p_184611_1_, ItemStack p_184611_2_) {
+        if (p_184611_1_ == Hand.MAIN_HAND) {
+            this.func_184201_a(EquipmentSlotType.MAINHAND, p_184611_2_);
+        } else {
+            if (p_184611_1_ != Hand.OFF_HAND) {
+                throw new IllegalArgumentException("Invalid hand " + p_184611_1_);
+            }
+
+            this.func_184201_a(EquipmentSlotType.OFFHAND, p_184611_2_);
+        }
+
+    }
+
+    public boolean func_190630_a(EquipmentSlotType p_190630_1_) {
+        return !this.func_184582_a(p_190630_1_).func_190926_b();
+    }
+
+    public abstract Iterable<ItemStack> func_184193_aE();
+
+    public abstract ItemStack func_184582_a(EquipmentSlotType p_184582_1_);
+
+    // CraftBukkit start
+    public void setItemStackToSlot(EquipmentSlotType slotIn, ItemStack stack, boolean silent) {
+        this.func_184201_a(slotIn, stack);
+    }
+    // CraftBukkit end
+
+    public abstract void func_184201_a(EquipmentSlotType p_184201_1_, ItemStack p_184201_2_);
+
+    public float func_213343_cS() {
+        Iterable<ItemStack> iterable = this.func_184193_aE();
+        int i = 0;
+        int j = 0;
+
+        for (ItemStack itemstack : iterable) {
             if (!itemstack.func_190926_b()) {
-               this.func_233645_dx_().func_233785_a_(itemstack.func_111283_C(equipmentslottype));
-            }
-
-            if (!itemstack1.func_190926_b()) {
-               this.func_233645_dx_().func_233793_b_(itemstack1.func_111283_C(equipmentslottype));
-            }
-         }
-      }
-
-      return map;
-   }
-
-   private void func_241342_a_(Map<EquipmentSlotType, ItemStack> p_241342_1_) {
-      ItemStack itemstack = p_241342_1_.get(EquipmentSlotType.MAINHAND);
-      ItemStack itemstack1 = p_241342_1_.get(EquipmentSlotType.OFFHAND);
-      if (itemstack != null && itemstack1 != null && ItemStack.func_77989_b(itemstack, this.func_241347_e_(EquipmentSlotType.OFFHAND)) && ItemStack.func_77989_b(itemstack1, this.func_241347_e_(EquipmentSlotType.MAINHAND))) {
-         ((ServerWorld)this.field_70170_p).func_72863_F().func_217218_b(this, new SEntityStatusPacket(this, (byte)55));
-         p_241342_1_.remove(EquipmentSlotType.MAINHAND);
-         p_241342_1_.remove(EquipmentSlotType.OFFHAND);
-         this.func_241345_c_(EquipmentSlotType.MAINHAND, itemstack.func_77946_l());
-         this.func_241345_c_(EquipmentSlotType.OFFHAND, itemstack1.func_77946_l());
-      }
-
-   }
-
-   private void func_241344_b_(Map<EquipmentSlotType, ItemStack> p_241344_1_) {
-      List<Pair<EquipmentSlotType, ItemStack>> list = Lists.newArrayListWithCapacity(p_241344_1_.size());
-      p_241344_1_.forEach((p_241341_2_, p_241341_3_) -> {
-         ItemStack itemstack = p_241341_3_.func_77946_l();
-         list.add(Pair.of(p_241341_2_, itemstack));
-         switch(p_241341_2_.func_188453_a()) {
-         case HAND:
-            this.func_241345_c_(p_241341_2_, itemstack);
-            break;
-         case ARMOR:
-            this.func_241343_b_(p_241341_2_, itemstack);
-         }
-
-      });
-      ((ServerWorld)this.field_70170_p).func_72863_F().func_217218_b(this, new SEntityEquipmentPacket(this.func_145782_y(), list));
-   }
-
-   private ItemStack func_241346_d_(EquipmentSlotType p_241346_1_) {
-      return this.field_184631_bt.get(p_241346_1_.func_188454_b());
-   }
-
-   private void func_241343_b_(EquipmentSlotType p_241343_1_, ItemStack p_241343_2_) {
-      this.field_184631_bt.set(p_241343_1_.func_188454_b(), p_241343_2_);
-   }
-
-   private ItemStack func_241347_e_(EquipmentSlotType p_241347_1_) {
-      return this.field_184630_bs.get(p_241347_1_.func_188454_b());
-   }
-
-   private void func_241345_c_(EquipmentSlotType p_241345_1_, ItemStack p_241345_2_) {
-      this.field_184630_bs.set(p_241345_1_.func_188454_b(), p_241345_2_);
-   }
-
-   protected float func_110146_f(float p_110146_1_, float p_110146_2_) {
-      float f = MathHelper.func_76142_g(p_110146_1_ - this.field_70761_aq);
-      this.field_70761_aq += f * 0.3F;
-      float f1 = MathHelper.func_76142_g(this.field_70177_z - this.field_70761_aq);
-      boolean flag = f1 < -90.0F || f1 >= 90.0F;
-      if (f1 < -75.0F) {
-         f1 = -75.0F;
-      }
-
-      if (f1 >= 75.0F) {
-         f1 = 75.0F;
-      }
-
-      this.field_70761_aq = this.field_70177_z - f1;
-      if (f1 * f1 > 2500.0F) {
-         this.field_70761_aq += f1 * 0.2F;
-      }
-
-      if (flag) {
-         p_110146_2_ *= -1.0F;
-      }
-
-      return p_110146_2_;
-   }
-
-   public void func_70636_d() {
-      if (this.field_70773_bE > 0) {
-         --this.field_70773_bE;
-      }
-
-      if (this.func_184186_bw()) {
-         this.field_70716_bi = 0;
-         this.func_213312_b(this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_());
-      }
-
-      if (this.field_70716_bi > 0) {
-         double d0 = this.func_226277_ct_() + (this.field_184623_bh - this.func_226277_ct_()) / (double)this.field_70716_bi;
-         double d2 = this.func_226278_cu_() + (this.field_184624_bi - this.func_226278_cu_()) / (double)this.field_70716_bi;
-         double d4 = this.func_226281_cx_() + (this.field_184625_bj - this.func_226281_cx_()) / (double)this.field_70716_bi;
-         double d6 = MathHelper.func_76138_g(this.field_184626_bk - (double)this.field_70177_z);
-         this.field_70177_z = (float)((double)this.field_70177_z + d6 / (double)this.field_70716_bi);
-         this.field_70125_A = (float)((double)this.field_70125_A + (this.field_70709_bj - (double)this.field_70125_A) / (double)this.field_70716_bi);
-         --this.field_70716_bi;
-         this.func_70107_b(d0, d2, d4);
-         this.func_70101_b(this.field_70177_z, this.field_70125_A);
-      } else if (!this.func_70613_aW()) {
-         this.func_213317_d(this.func_213322_ci().func_186678_a(0.98D));
-      }
-
-      if (this.field_208002_br > 0) {
-         this.field_70759_as = (float)((double)this.field_70759_as + MathHelper.func_76138_g(this.field_208001_bq - (double)this.field_70759_as) / (double)this.field_208002_br);
-         --this.field_208002_br;
-      }
-
-      Vector3d vector3d = this.func_213322_ci();
-      double d1 = vector3d.field_72450_a;
-      double d3 = vector3d.field_72448_b;
-      double d5 = vector3d.field_72449_c;
-      if (Math.abs(vector3d.field_72450_a) < 0.003D) {
-         d1 = 0.0D;
-      }
-
-      if (Math.abs(vector3d.field_72448_b) < 0.003D) {
-         d3 = 0.0D;
-      }
-
-      if (Math.abs(vector3d.field_72449_c) < 0.003D) {
-         d5 = 0.0D;
-      }
-
-      this.func_213293_j(d1, d3, d5);
-      this.field_70170_p.func_217381_Z().func_76320_a("ai");
-      if (this.func_70610_aX()) {
-         this.field_70703_bu = false;
-         this.field_70702_br = 0.0F;
-         this.field_191988_bg = 0.0F;
-      } else if (this.func_70613_aW()) {
-         this.field_70170_p.func_217381_Z().func_76320_a("newAi");
-         this.func_70626_be();
-         this.field_70170_p.func_217381_Z().func_76319_b();
-      }
-
-      this.field_70170_p.func_217381_Z().func_76319_b();
-      this.field_70170_p.func_217381_Z().func_76320_a("jump");
-      if (this.field_70703_bu && this.func_241208_cS_()) {
-         double d7;
-         if (this.func_180799_ab()) {
-            d7 = this.func_233571_b_(FluidTags.field_206960_b);
-         } else {
-            d7 = this.func_233571_b_(FluidTags.field_206959_a);
-         }
-
-         boolean flag = this.func_70090_H() && d7 > 0.0D;
-         double d8 = this.func_233579_cu_();
-         if (!flag || this.field_70122_E && !(d7 > d8)) {
-            if (!this.func_180799_ab() || this.field_70122_E && !(d7 > d8)) {
-               if ((this.field_70122_E || flag && d7 <= d8) && this.field_70773_bE == 0) {
-                  this.func_70664_aZ();
-                  this.field_70773_bE = 10;
-               }
-            } else {
-               this.func_180466_bG(FluidTags.field_206960_b);
-            }
-         } else {
-            this.func_180466_bG(FluidTags.field_206959_a);
-         }
-      } else {
-         this.field_70773_bE = 0;
-      }
-
-      this.field_70170_p.func_217381_Z().func_76319_b();
-      this.field_70170_p.func_217381_Z().func_76320_a("travel");
-      this.field_70702_br *= 0.98F;
-      this.field_191988_bg *= 0.98F;
-      this.func_184616_r();
-      AxisAlignedBB axisalignedbb = this.func_174813_aQ();
-      this.func_213352_e(new Vector3d((double)this.field_70702_br, (double)this.field_70701_bs, (double)this.field_191988_bg));
-      this.field_70170_p.func_217381_Z().func_76319_b();
-      this.field_70170_p.func_217381_Z().func_76320_a("push");
-      if (this.field_204807_bs > 0) {
-         --this.field_204807_bs;
-         this.func_204801_a(axisalignedbb, this.func_174813_aQ());
-      }
-
-      this.func_85033_bc();
-      this.field_70170_p.func_217381_Z().func_76319_b();
-      if (!this.field_70170_p.field_72995_K && this.func_230270_dK_() && this.func_203008_ap()) {
-         this.func_70097_a(DamageSource.field_76369_e, 1.0F);
-      }
-
-   }
-
-   public boolean func_230270_dK_() {
-      return false;
-   }
-
-   private void func_184616_r() {
-      boolean flag = this.func_70083_f(7);
-      if (flag && !this.field_70122_E && !this.func_184218_aH() && !this.func_70644_a(Effects.field_188424_y)) {
-         ItemStack itemstack = this.func_184582_a(EquipmentSlotType.CHEST);
-         if (itemstack.func_77973_b() == Items.field_185160_cR && ElytraItem.func_185069_d(itemstack)) {
-            flag = true;
-            if (!this.field_70170_p.field_72995_K && (this.field_184629_bo + 1) % 20 == 0) {
-               itemstack.func_222118_a(1, this, (p_233652_0_) -> {
-                  p_233652_0_.func_213361_c(EquipmentSlotType.CHEST);
-               });
-            }
-         } else {
-            flag = false;
-         }
-      } else {
-         flag = false;
-      }
-
-      if (!this.field_70170_p.field_72995_K) {
-         this.func_70052_a(7, flag);
-      }
-
-   }
-
-   protected void func_70626_be() {
-   }
-
-   protected void func_85033_bc() {
-      List<Entity> list = this.field_70170_p.func_175674_a(this, this.func_174813_aQ(), EntityPredicates.func_200823_a(this));
-      if (!list.isEmpty()) {
-         int i = this.field_70170_p.func_82736_K().func_223592_c(GameRules.field_223616_s);
-         if (i > 0 && list.size() > i - 1 && this.field_70146_Z.nextInt(4) == 0) {
-            int j = 0;
-
-            for(int k = 0; k < list.size(); ++k) {
-               if (!list.get(k).func_184218_aH()) {
-                  ++j;
-               }
-            }
-
-            if (j > i - 1) {
-               this.func_70097_a(DamageSource.field_191291_g, 6.0F);
-            }
-         }
-
-         for(int l = 0; l < list.size(); ++l) {
-            Entity entity = list.get(l);
-            this.func_82167_n(entity);
-         }
-      }
-
-   }
-
-   protected void func_204801_a(AxisAlignedBB p_204801_1_, AxisAlignedBB p_204801_2_) {
-      AxisAlignedBB axisalignedbb = p_204801_1_.func_111270_a(p_204801_2_);
-      List<Entity> list = this.field_70170_p.func_72839_b(this, axisalignedbb);
-      if (!list.isEmpty()) {
-         for(int i = 0; i < list.size(); ++i) {
-            Entity entity = list.get(i);
-            if (entity instanceof LivingEntity) {
-               this.func_204804_d((LivingEntity)entity);
-               this.field_204807_bs = 0;
-               this.func_213317_d(this.func_213322_ci().func_186678_a(-0.2D));
-               break;
-            }
-         }
-      } else if (this.field_70123_F) {
-         this.field_204807_bs = 0;
-      }
-
-      if (!this.field_70170_p.field_72995_K && this.field_204807_bs <= 0) {
-         this.func_204802_c(4, false);
-      }
-
-   }
-
-   protected void func_82167_n(Entity p_82167_1_) {
-      p_82167_1_.func_70108_f(this);
-   }
-
-   protected void func_204804_d(LivingEntity p_204804_1_) {
-   }
-
-   public void func_204803_n(int p_204803_1_) {
-      this.field_204807_bs = p_204803_1_;
-      if (!this.field_70170_p.field_72995_K) {
-         this.func_204802_c(4, true);
-      }
-
-   }
-
-   public boolean func_204805_cN() {
-      return (this.field_70180_af.func_187225_a(field_184621_as) & 4) != 0;
-   }
-
-   public void func_184210_p() {
-      Entity entity = this.func_184187_bx();
-      super.func_184210_p();
-      if (entity != null && entity != this.func_184187_bx() && !this.field_70170_p.field_72995_K) {
-         this.func_233628_a_(entity);
-      }
-
-   }
-
-   public void func_70098_U() {
-      super.func_70098_U();
-      this.field_70768_au = this.field_110154_aX;
-      this.field_110154_aX = 0.0F;
-      this.field_70143_R = 0.0F;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public void func_180426_a(double p_180426_1_, double p_180426_3_, double p_180426_5_, float p_180426_7_, float p_180426_8_, int p_180426_9_, boolean p_180426_10_) {
-      this.field_184623_bh = p_180426_1_;
-      this.field_184624_bi = p_180426_3_;
-      this.field_184625_bj = p_180426_5_;
-      this.field_184626_bk = (double)p_180426_7_;
-      this.field_70709_bj = (double)p_180426_8_;
-      this.field_70716_bi = p_180426_9_;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public void func_208000_a(float p_208000_1_, int p_208000_2_) {
-      this.field_208001_bq = (double)p_208000_1_;
-      this.field_208002_br = p_208000_2_;
-   }
-
-   public void func_70637_d(boolean p_70637_1_) {
-      this.field_70703_bu = p_70637_1_;
-   }
-
-   public void func_233630_a_(ItemEntity p_233630_1_) {
-      PlayerEntity playerentity = p_233630_1_.func_200214_m() != null ? this.field_70170_p.func_217371_b(p_233630_1_.func_200214_m()) : null;
-      if (playerentity instanceof ServerPlayerEntity) {
-         CriteriaTriggers.field_232609_O_.func_234830_a_((ServerPlayerEntity)playerentity, p_233630_1_.func_92059_d(), this);
-      }
-
-   }
-
-   public void func_71001_a(Entity p_71001_1_, int p_71001_2_) {
-      if (!p_71001_1_.field_70128_L && !this.field_70170_p.field_72995_K && (p_71001_1_ instanceof ItemEntity || p_71001_1_ instanceof AbstractArrowEntity || p_71001_1_ instanceof ExperienceOrbEntity)) {
-         ((ServerWorld)this.field_70170_p).func_72863_F().func_217218_b(p_71001_1_, new SCollectItemPacket(p_71001_1_.func_145782_y(), this.func_145782_y(), p_71001_2_));
-      }
-
-   }
-
-   public boolean func_70685_l(Entity p_70685_1_) {
-      Vector3d vector3d = new Vector3d(this.func_226277_ct_(), this.func_226280_cw_(), this.func_226281_cx_());
-      Vector3d vector3d1 = new Vector3d(p_70685_1_.func_226277_ct_(), p_70685_1_.func_226280_cw_(), p_70685_1_.func_226281_cx_());
-      return this.field_70170_p.func_217299_a(new RayTraceContext(vector3d, vector3d1, RayTraceContext.BlockMode.COLLIDER, RayTraceContext.FluidMode.NONE, this)).func_216346_c() == RayTraceResult.Type.MISS;
-   }
-
-   public float func_195046_g(float p_195046_1_) {
-      return p_195046_1_ == 1.0F ? this.field_70759_as : MathHelper.func_219799_g(p_195046_1_, this.field_70758_at, this.field_70759_as);
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public float func_70678_g(float p_70678_1_) {
-      float f = this.field_70733_aJ - this.field_70732_aI;
-      if (f < 0.0F) {
-         ++f;
-      }
-
-      return this.field_70732_aI + f * p_70678_1_;
-   }
-
-   public boolean func_70613_aW() {
-      return !this.field_70170_p.field_72995_K;
-   }
-
-   public boolean func_70067_L() {
-      return !this.field_70128_L;
-   }
-
-   public boolean func_70104_M() {
-      return this.func_70089_S() && !this.func_175149_v() && !this.func_70617_f_();
-   }
-
-   protected void func_70018_K() {
-      this.field_70133_I = this.field_70146_Z.nextDouble() >= this.func_233637_b_(Attributes.field_233820_c_);
-   }
-
-   public float func_70079_am() {
-      return this.field_70759_as;
-   }
-
-   public void func_70034_d(float p_70034_1_) {
-      this.field_70759_as = p_70034_1_;
-   }
-
-   public void func_181013_g(float p_181013_1_) {
-      this.field_70761_aq = p_181013_1_;
-   }
-
-   protected Vector3d func_241839_a(Direction.Axis p_241839_1_, TeleportationRepositioner.Result p_241839_2_) {
-      return func_242288_h(super.func_241839_a(p_241839_1_, p_241839_2_));
-   }
-
-   public static Vector3d func_242288_h(Vector3d p_242288_0_) {
-      return new Vector3d(p_242288_0_.field_72450_a, p_242288_0_.field_72448_b, 0.0D);
-   }
-
-   public float func_110139_bj() {
-      return this.field_110151_bq;
-   }
-
-   public void func_110149_m(float p_110149_1_) {
-      if (p_110149_1_ < 0.0F) {
-         p_110149_1_ = 0.0F;
-      }
-
-      this.field_110151_bq = p_110149_1_;
-   }
-
-   public void func_152111_bt() {
-   }
-
-   public void func_152112_bu() {
-   }
-
-   protected void func_175136_bO() {
-      this.field_70752_e = true;
-   }
-
-   public abstract HandSide func_184591_cq();
-
-   public boolean func_184587_cr() {
-      return (this.field_70180_af.func_187225_a(field_184621_as) & 1) > 0;
-   }
-
-   public Hand func_184600_cs() {
-      return (this.field_70180_af.func_187225_a(field_184621_as) & 2) > 0 ? Hand.OFF_HAND : Hand.MAIN_HAND;
-   }
-
-   private void func_184608_ct() {
-      if (this.func_184587_cr()) {
-         if (ItemStack.func_185132_d(this.func_184586_b(this.func_184600_cs()), this.field_184627_bm)) {
-            this.field_184627_bm = this.func_184586_b(this.func_184600_cs());
-            this.field_184627_bm.func_222121_b(this.field_70170_p, this, this.func_184605_cv());
-            if (this.func_226299_p_()) {
-               this.func_226293_b_(this.field_184627_bm, 5);
-            }
-
-            if (--this.field_184628_bn == 0 && !this.field_70170_p.field_72995_K && !this.field_184627_bm.func_222122_m()) {
-               this.func_71036_o();
-            }
-         } else {
-            this.func_184602_cy();
-         }
-      }
-
-   }
-
-   private boolean func_226299_p_() {
-      int i = this.func_184605_cv();
-      Food food = this.field_184627_bm.func_77973_b().func_219967_s();
-      boolean flag = food != null && food.func_221465_e();
-      flag = flag | i <= this.field_184627_bm.func_77988_m() - 7;
-      return flag && i % 4 == 0;
-   }
-
-   private void func_205014_p() {
-      this.field_205018_bM = this.field_205017_bL;
-      if (this.func_213314_bj()) {
-         this.field_205017_bL = Math.min(1.0F, this.field_205017_bL + 0.09F);
-      } else {
-         this.field_205017_bL = Math.max(0.0F, this.field_205017_bL - 0.09F);
-      }
-
-   }
-
-   protected void func_204802_c(int p_204802_1_, boolean p_204802_2_) {
-      int i = this.field_70180_af.func_187225_a(field_184621_as);
-      if (p_204802_2_) {
-         i = i | p_204802_1_;
-      } else {
-         i = i & ~p_204802_1_;
-      }
-
-      this.field_70180_af.func_187227_b(field_184621_as, (byte)i);
-   }
-
-   public void func_184598_c(Hand p_184598_1_) {
-      ItemStack itemstack = this.func_184586_b(p_184598_1_);
-      if (!itemstack.func_190926_b() && !this.func_184587_cr()) {
-         this.field_184627_bm = itemstack;
-         this.field_184628_bn = itemstack.func_77988_m();
-         if (!this.field_70170_p.field_72995_K) {
-            this.func_204802_c(1, true);
-            this.func_204802_c(2, p_184598_1_ == Hand.OFF_HAND);
-         }
-
-      }
-   }
-
-   public void func_184206_a(DataParameter<?> p_184206_1_) {
-      super.func_184206_a(p_184206_1_);
-      if (field_213379_bs.equals(p_184206_1_)) {
-         if (this.field_70170_p.field_72995_K) {
-            this.func_213374_dv().ifPresent(this::func_213370_a);
-         }
-      } else if (field_184621_as.equals(p_184206_1_) && this.field_70170_p.field_72995_K) {
-         if (this.func_184587_cr() && this.field_184627_bm.func_190926_b()) {
-            this.field_184627_bm = this.func_184586_b(this.func_184600_cs());
-            if (!this.field_184627_bm.func_190926_b()) {
-               this.field_184628_bn = this.field_184627_bm.func_77988_m();
-            }
-         } else if (!this.func_184587_cr() && !this.field_184627_bm.func_190926_b()) {
-            this.field_184627_bm = ItemStack.field_190927_a;
-            this.field_184628_bn = 0;
-         }
-      }
-
-   }
-
-   public void func_200602_a(EntityAnchorArgument.Type p_200602_1_, Vector3d p_200602_2_) {
-      super.func_200602_a(p_200602_1_, p_200602_2_);
-      this.field_70758_at = this.field_70759_as;
-      this.field_70761_aq = this.field_70759_as;
-      this.field_70760_ar = this.field_70761_aq;
-   }
-
-   protected void func_226293_b_(ItemStack p_226293_1_, int p_226293_2_) {
-      if (!p_226293_1_.func_190926_b() && this.func_184587_cr()) {
-         if (p_226293_1_.func_77975_n() == UseAction.DRINK) {
-            this.func_184185_a(this.func_213351_c(p_226293_1_), 0.5F, this.field_70170_p.field_73012_v.nextFloat() * 0.1F + 0.9F);
-         }
-
-         if (p_226293_1_.func_77975_n() == UseAction.EAT) {
-            this.func_195062_a(p_226293_1_, p_226293_2_);
-            this.func_184185_a(this.func_213353_d(p_226293_1_), 0.5F + 0.5F * (float)this.field_70146_Z.nextInt(2), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
-         }
-
-      }
-   }
-
-   private void func_195062_a(ItemStack p_195062_1_, int p_195062_2_) {
-      for(int i = 0; i < p_195062_2_; ++i) {
-         Vector3d vector3d = new Vector3d(((double)this.field_70146_Z.nextFloat() - 0.5D) * 0.1D, Math.random() * 0.1D + 0.1D, 0.0D);
-         vector3d = vector3d.func_178789_a(-this.field_70125_A * ((float)Math.PI / 180F));
-         vector3d = vector3d.func_178785_b(-this.field_70177_z * ((float)Math.PI / 180F));
-         double d0 = (double)(-this.field_70146_Z.nextFloat()) * 0.6D - 0.3D;
-         Vector3d vector3d1 = new Vector3d(((double)this.field_70146_Z.nextFloat() - 0.5D) * 0.3D, d0, 0.6D);
-         vector3d1 = vector3d1.func_178789_a(-this.field_70125_A * ((float)Math.PI / 180F));
-         vector3d1 = vector3d1.func_178785_b(-this.field_70177_z * ((float)Math.PI / 180F));
-         vector3d1 = vector3d1.func_72441_c(this.func_226277_ct_(), this.func_226280_cw_(), this.func_226281_cx_());
-         this.field_70170_p.func_195594_a(new ItemParticleData(ParticleTypes.field_197591_B, p_195062_1_), vector3d1.field_72450_a, vector3d1.field_72448_b, vector3d1.field_72449_c, vector3d.field_72450_a, vector3d.field_72448_b + 0.05D, vector3d.field_72449_c);
-      }
-
-   }
-
-   protected void func_71036_o() {
-      Hand hand = this.func_184600_cs();
-      if (!this.field_184627_bm.equals(this.func_184586_b(hand))) {
-         this.func_184597_cx();
-      } else {
-         if (!this.field_184627_bm.func_190926_b() && this.func_184587_cr()) {
-            this.func_226293_b_(this.field_184627_bm, 16);
-            ItemStack itemstack = this.field_184627_bm.func_77950_b(this.field_70170_p, this);
-            if (itemstack != this.field_184627_bm) {
-               this.func_184611_a(hand, itemstack);
-            }
-
-            this.func_184602_cy();
-         }
-
-      }
-   }
-
-   public ItemStack func_184607_cu() {
-      return this.field_184627_bm;
-   }
-
-   public int func_184605_cv() {
-      return this.field_184628_bn;
-   }
-
-   public int func_184612_cw() {
-      return this.func_184587_cr() ? this.field_184627_bm.func_77988_m() - this.func_184605_cv() : 0;
-   }
-
-   public void func_184597_cx() {
-      if (!this.field_184627_bm.func_190926_b()) {
-         this.field_184627_bm.func_77974_b(this.field_70170_p, this, this.func_184605_cv());
-         if (this.field_184627_bm.func_222122_m()) {
-            this.func_184608_ct();
-         }
-      }
-
-      this.func_184602_cy();
-   }
-
-   public void func_184602_cy() {
-      if (!this.field_70170_p.field_72995_K) {
-         this.func_204802_c(1, false);
-      }
-
-      this.field_184627_bm = ItemStack.field_190927_a;
-      this.field_184628_bn = 0;
-   }
-
-   public boolean func_184585_cz() {
-      if (this.func_184587_cr() && !this.field_184627_bm.func_190926_b()) {
-         Item item = this.field_184627_bm.func_77973_b();
-         if (item.func_77661_b(this.field_184627_bm) != UseAction.BLOCK) {
-            return false;
-         } else {
-            return item.func_77626_a(this.field_184627_bm) - this.field_184628_bn >= 5;
-         }
-      } else {
-         return false;
-      }
-   }
-
-   public boolean func_230491_ea_() {
-      return this.func_225608_bj_();
-   }
-
-   public boolean func_184613_cA() {
-      return this.func_70083_f(7);
-   }
-
-   public boolean func_213314_bj() {
-      return super.func_213314_bj() || !this.func_184613_cA() && this.func_213283_Z() == Pose.FALL_FLYING;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public int func_184599_cB() {
-      return this.field_184629_bo;
-   }
-
-   public boolean func_213373_a(double p_213373_1_, double p_213373_3_, double p_213373_5_, boolean p_213373_7_) {
-      double d0 = this.func_226277_ct_();
-      double d1 = this.func_226278_cu_();
-      double d2 = this.func_226281_cx_();
-      double d3 = p_213373_3_;
-      boolean flag = false;
-      BlockPos blockpos = new BlockPos(p_213373_1_, p_213373_3_, p_213373_5_);
-      World world = this.field_70170_p;
-      if (world.func_175667_e(blockpos)) {
-         boolean flag1 = false;
-
-         while(!flag1 && blockpos.func_177956_o() > 0) {
-            BlockPos blockpos1 = blockpos.func_177977_b();
-            BlockState blockstate = world.func_180495_p(blockpos1);
-            if (blockstate.func_185904_a().func_76230_c()) {
-               flag1 = true;
-            } else {
-               --d3;
-               blockpos = blockpos1;
-            }
-         }
-
-         if (flag1) {
-            this.func_70634_a(p_213373_1_, d3, p_213373_5_);
-            if (world.func_226669_j_(this) && !world.func_72953_d(this.func_174813_aQ())) {
-               flag = true;
-            }
-         }
-      }
-
-      if (!flag) {
-         this.func_70634_a(d0, d1, d2);
-         return false;
-      } else {
-         if (p_213373_7_) {
-            world.func_72960_a(this, (byte)46);
-         }
-
-         if (this instanceof CreatureEntity) {
-            ((CreatureEntity)this).func_70661_as().func_75499_g();
-         }
-
-         return true;
-      }
-   }
-
-   public boolean func_184603_cC() {
-      return true;
-   }
-
-   public boolean func_190631_cK() {
-      return true;
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public void func_191987_a(BlockPos p_191987_1_, boolean p_191987_2_) {
-   }
-
-   public boolean func_213365_e(ItemStack p_213365_1_) {
-      return false;
-   }
-
-   public IPacket<?> func_213297_N() {
-      return new SSpawnMobPacket(this);
-   }
-
-   public EntitySize func_213305_a(Pose p_213305_1_) {
-      return p_213305_1_ == Pose.SLEEPING ? field_213377_as : super.func_213305_a(p_213305_1_).func_220313_a(this.func_213355_cm());
-   }
-
-   public ImmutableList<Pose> func_230297_ef_() {
-      return ImmutableList.of(Pose.STANDING);
-   }
-
-   public AxisAlignedBB func_233648_f_(Pose p_233648_1_) {
-      EntitySize entitysize = this.func_213305_a(p_233648_1_);
-      return new AxisAlignedBB((double)(-entitysize.field_220315_a / 2.0F), 0.0D, (double)(-entitysize.field_220315_a / 2.0F), (double)(entitysize.field_220315_a / 2.0F), (double)entitysize.field_220316_b, (double)(entitysize.field_220315_a / 2.0F));
-   }
-
-   public Optional<BlockPos> func_213374_dv() {
-      return this.field_70180_af.func_187225_a(field_213379_bs);
-   }
-
-   public void func_213369_d(BlockPos p_213369_1_) {
-      this.field_70180_af.func_187227_b(field_213379_bs, Optional.of(p_213369_1_));
-   }
-
-   public void func_213372_dw() {
-      this.field_70180_af.func_187227_b(field_213379_bs, Optional.empty());
-   }
-
-   public boolean func_70608_bn() {
-      return this.func_213374_dv().isPresent();
-   }
-
-   public void func_213342_e(BlockPos p_213342_1_) {
-      if (this.func_184218_aH()) {
-         this.func_184210_p();
-      }
-
-      BlockState blockstate = this.field_70170_p.func_180495_p(p_213342_1_);
-      if (blockstate.func_177230_c() instanceof BedBlock) {
-         this.field_70170_p.func_180501_a(p_213342_1_, blockstate.func_206870_a(BedBlock.field_176471_b, Boolean.valueOf(true)), 3);
-      }
-
-      this.func_213301_b(Pose.SLEEPING);
-      this.func_213370_a(p_213342_1_);
-      this.func_213369_d(p_213342_1_);
-      this.func_213317_d(Vector3d.field_186680_a);
-      this.field_70160_al = true;
-   }
-
-   private void func_213370_a(BlockPos p_213370_1_) {
-      this.func_70107_b((double)p_213370_1_.func_177958_n() + 0.5D, (double)p_213370_1_.func_177956_o() + 0.6875D, (double)p_213370_1_.func_177952_p() + 0.5D);
-   }
-
-   private boolean func_213359_p() {
-      return this.func_213374_dv().map((p_241350_1_) -> {
-         return this.field_70170_p.func_180495_p(p_241350_1_).func_177230_c() instanceof BedBlock;
-      }).orElse(false);
-   }
-
-   public void func_213366_dy() {
-      this.func_213374_dv().filter(this.field_70170_p::func_175667_e).ifPresent((p_241348_1_) -> {
-         BlockState blockstate = this.field_70170_p.func_180495_p(p_241348_1_);
-         if (blockstate.func_177230_c() instanceof BedBlock) {
-            this.field_70170_p.func_180501_a(p_241348_1_, blockstate.func_206870_a(BedBlock.field_176471_b, Boolean.valueOf(false)), 3);
-            Vector3d vector3d1 = BedBlock.func_242652_a(this.func_200600_R(), this.field_70170_p, p_241348_1_, this.field_70177_z).orElseGet(() -> {
-               BlockPos blockpos = p_241348_1_.func_177984_a();
-               return new Vector3d((double)blockpos.func_177958_n() + 0.5D, (double)blockpos.func_177956_o() + 0.1D, (double)blockpos.func_177952_p() + 0.5D);
-            });
-            Vector3d vector3d2 = Vector3d.func_237492_c_(p_241348_1_).func_178788_d(vector3d1).func_72432_b();
-            float f = (float)MathHelper.func_76138_g(MathHelper.func_181159_b(vector3d2.field_72449_c, vector3d2.field_72450_a) * (double)(180F / (float)Math.PI) - 90.0D);
-            this.func_70107_b(vector3d1.field_72450_a, vector3d1.field_72448_b, vector3d1.field_72449_c);
-            this.field_70177_z = f;
+                ++j;
+            }
+
+            ++i;
+        }
+
+        return i > 0 ? (float) j / (float) i : 0.0F;
+    }
+
+    public void func_70031_b(boolean p_70031_1_) {
+        super.func_70031_b(p_70031_1_);
+        ModifiableAttributeInstance modifiableattributeinstance = this.func_110148_a(Attributes.field_233821_d_);
+        if (modifiableattributeinstance.func_111127_a(field_110156_b) != null) {
+            modifiableattributeinstance.func_111124_b(field_110157_c);
+        }
+
+        if (p_70031_1_) {
+            modifiableattributeinstance.func_233767_b_(field_110157_c);
+        }
+
+    }
+
+    protected float func_70599_aP() {
+        return 1.0F;
+    }
+
+    protected float func_70647_i() {
+        return this.func_70631_g_() ? (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.5F : (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F;
+    }
+
+    protected boolean func_70610_aX() {
+        return this.func_233643_dh_();
+    }
+
+    public void func_70108_f(Entity p_70108_1_) {
+        if (!this.func_70608_bn()) {
+            super.func_70108_f(p_70108_1_);
+        }
+
+    }
+
+    private void func_233628_a_(Entity p_233628_1_) {
+        Vector3d vector3d;
+        if (!p_233628_1_.field_70128_L && !this.field_70170_p.func_180495_p(p_233628_1_.func_233580_cy_()).func_177230_c().func_203417_a(BlockTags.field_226154_ad_)) {
+            vector3d = p_233628_1_.func_230268_c_(this);
+        } else {
+            vector3d = new Vector3d(p_233628_1_.func_226277_ct_(), p_233628_1_.func_226278_cu_() + (double) p_233628_1_.func_213302_cg(), p_233628_1_.func_226281_cx_());
+        }
+
+        this.func_70634_a(vector3d.field_72450_a, vector3d.field_72448_b, vector3d.field_72449_c);
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public boolean func_94059_bO() {
+        return this.func_174833_aM();
+    }
+
+    protected float func_175134_bD() {
+        return 0.42F * this.func_226269_ah_();
+    }
+
+    protected void func_70664_aZ() {
+        float f = this.func_175134_bD();
+        if (this.func_70644_a(Effects.field_76430_j)) {
+            f += 0.1F * (float) (this.func_70660_b(Effects.field_76430_j).func_76458_c() + 1);
+        }
+
+        Vector3d vector3d = this.func_213322_ci();
+        this.func_213293_j(vector3d.field_72450_a, f, vector3d.field_72449_c);
+        if (this.func_70051_ag()) {
+            float f1 = this.field_70177_z * ((float) Math.PI / 180F);
+            this.func_213317_d(this.func_213322_ci().func_72441_c(-MathHelper.func_76126_a(f1) * 0.2F, 0.0D, MathHelper.func_76134_b(f1) * 0.2F));
+        }
+
+        this.field_70160_al = true;
+        net.minecraftforge.common.ForgeHooks.onLivingJump(this);
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    protected void func_203010_cG() {
+        this.func_213317_d(this.func_213322_ci().func_72441_c(0.0D, (double) -0.04F * this.func_110148_a(net.minecraftforge.common.ForgeMod.SWIM_SPEED.get()).func_111126_e(), 0.0D));
+    }
+
+    protected void func_180466_bG(ITag<Fluid> p_180466_1_) {
+        this.func_213317_d(this.func_213322_ci().func_72441_c(0.0D, (double) 0.04F * this.func_110148_a(net.minecraftforge.common.ForgeMod.SWIM_SPEED.get()).func_111126_e(), 0.0D));
+    }
+
+    protected float func_189749_co() {
+        return 0.8F;
+    }
+
+    public boolean func_230285_a_(Fluid p_230285_1_) {
+        return false;
+    }
+
+    public void func_213352_e(Vector3d p_213352_1_) {
+        if (this.func_70613_aW() || this.func_184186_bw()) {
+            double d0 = 0.08D;
+            ModifiableAttributeInstance gravity = this.func_110148_a(net.minecraftforge.common.ForgeMod.ENTITY_GRAVITY.get());
+            boolean flag = this.func_213322_ci().field_72448_b <= 0.0D;
+            if (flag && this.func_70644_a(Effects.field_204839_B)) {
+                if (!gravity.func_180374_a(SLOW_FALLING)) gravity.func_233767_b_(SLOW_FALLING);
+                this.field_70143_R = 0.0F;
+            } else if (gravity.func_180374_a(SLOW_FALLING)) {
+                gravity.func_111124_b(SLOW_FALLING);
+            }
+            d0 = gravity.func_111126_e();
+
+            FluidState fluidstate = this.field_70170_p.func_204610_c(this.func_233580_cy_());
+            if (this.func_70090_H() && this.func_241208_cS_() && !this.func_230285_a_(fluidstate.func_206886_c())) {
+                double d8 = this.func_226278_cu_();
+                float f5 = this.func_70051_ag() ? 0.9F : this.func_189749_co();
+                float f6 = 0.02F;
+                float f7 = (float) EnchantmentHelper.func_185294_d(this);
+                if (f7 > 3.0F) {
+                    f7 = 3.0F;
+                }
+
+                if (!this.field_70122_E) {
+                    f7 *= 0.5F;
+                }
+
+                if (f7 > 0.0F) {
+                    f5 += (0.54600006F - f5) * f7 / 3.0F;
+                    f6 += (this.func_70689_ay() - f6) * f7 / 3.0F;
+                }
+
+                if (this.func_70644_a(Effects.field_206827_D)) {
+                    f5 = 0.96F;
+                }
+
+                f6 *= (float) this.func_110148_a(net.minecraftforge.common.ForgeMod.SWIM_SPEED.get()).func_111126_e();
+                this.func_213309_a(f6, p_213352_1_);
+                this.func_213315_a(MoverType.SELF, this.func_213322_ci());
+                Vector3d vector3d6 = this.func_213322_ci();
+                if (this.field_70123_F && this.func_70617_f_()) {
+                    vector3d6 = new Vector3d(vector3d6.field_72450_a, 0.2D, vector3d6.field_72449_c);
+                }
+
+                this.func_213317_d(vector3d6.func_216372_d(f5, 0.8F, f5));
+                Vector3d vector3d2 = this.func_233626_a_(d0, flag, this.func_213322_ci());
+                this.func_213317_d(vector3d2);
+                if (this.field_70123_F && this.func_70038_c(vector3d2.field_72450_a, vector3d2.field_72448_b + (double) 0.6F - this.func_226278_cu_() + d8, vector3d2.field_72449_c)) {
+                    this.func_213293_j(vector3d2.field_72450_a, 0.3F, vector3d2.field_72449_c);
+                }
+            } else if (this.func_180799_ab() && this.func_241208_cS_() && !this.func_230285_a_(fluidstate.func_206886_c())) {
+                double d7 = this.func_226278_cu_();
+                this.func_213309_a(0.02F, p_213352_1_);
+                this.func_213315_a(MoverType.SELF, this.func_213322_ci());
+                if (this.func_233571_b_(FluidTags.field_206960_b) <= this.func_233579_cu_()) {
+                    this.func_213317_d(this.func_213322_ci().func_216372_d(0.5D, 0.8F, 0.5D));
+                    Vector3d vector3d3 = this.func_233626_a_(d0, flag, this.func_213322_ci());
+                    this.func_213317_d(vector3d3);
+                } else {
+                    this.func_213317_d(this.func_213322_ci().func_186678_a(0.5D));
+                }
+
+                if (!this.func_189652_ae()) {
+                    this.func_213317_d(this.func_213322_ci().func_72441_c(0.0D, -d0 / 4.0D, 0.0D));
+                }
+
+                Vector3d vector3d4 = this.func_213322_ci();
+                if (this.field_70123_F && this.func_70038_c(vector3d4.field_72450_a, vector3d4.field_72448_b + (double) 0.6F - this.func_226278_cu_() + d7, vector3d4.field_72449_c)) {
+                    this.func_213293_j(vector3d4.field_72450_a, 0.3F, vector3d4.field_72449_c);
+                }
+            } else if (this.func_184613_cA()) {
+                Vector3d vector3d = this.func_213322_ci();
+                if (vector3d.field_72448_b > -0.5D) {
+                    this.field_70143_R = 1.0F;
+                }
+
+                Vector3d vector3d1 = this.func_70040_Z();
+                float f = this.field_70125_A * ((float) Math.PI / 180F);
+                double d1 = Math.sqrt(vector3d1.field_72450_a * vector3d1.field_72450_a + vector3d1.field_72449_c * vector3d1.field_72449_c);
+                double d3 = Math.sqrt(func_213296_b(vector3d));
+                double d4 = vector3d1.func_72433_c();
+                float f1 = MathHelper.func_76134_b(f);
+                f1 = (float) ((double) f1 * (double) f1 * Math.min(1.0D, d4 / 0.4D));
+                vector3d = this.func_213322_ci().func_72441_c(0.0D, d0 * (-1.0D + (double) f1 * 0.75D), 0.0D);
+                if (vector3d.field_72448_b < 0.0D && d1 > 0.0D) {
+                    double d5 = vector3d.field_72448_b * -0.1D * (double) f1;
+                    vector3d = vector3d.func_72441_c(vector3d1.field_72450_a * d5 / d1, d5, vector3d1.field_72449_c * d5 / d1);
+                }
+
+                if (f < 0.0F && d1 > 0.0D) {
+                    double d9 = d3 * (double) (-MathHelper.func_76126_a(f)) * 0.04D;
+                    vector3d = vector3d.func_72441_c(-vector3d1.field_72450_a * d9 / d1, d9 * 3.2D, -vector3d1.field_72449_c * d9 / d1);
+                }
+
+                if (d1 > 0.0D) {
+                    vector3d = vector3d.func_72441_c((vector3d1.field_72450_a / d1 * d3 - vector3d.field_72450_a) * 0.1D, 0.0D, (vector3d1.field_72449_c / d1 * d3 - vector3d.field_72449_c) * 0.1D);
+                }
+
+                this.func_213317_d(vector3d.func_216372_d(0.99F, 0.98F, 0.99F));
+                this.func_213315_a(MoverType.SELF, this.func_213322_ci());
+                if (this.field_70123_F && !this.field_70170_p.field_72995_K) {
+                    double d10 = Math.sqrt(func_213296_b(this.func_213322_ci()));
+                    double d6 = d3 - d10;
+                    float f2 = (float) (d6 * 10.0D - 3.0D);
+                    if (f2 > 0.0F) {
+                        this.func_184185_a(this.func_184588_d((int) f2), 1.0F, 1.0F);
+                        this.func_70097_a(DamageSource.field_188406_j, f2);
+                    }
+                }
+
+                if (this.field_70122_E && !this.field_70170_p.field_72995_K) {
+                    if (func_70083_f(7) && !CraftEventFactory.callToggleGlideEvent(this, false).isCancelled()) // CraftBukkit
+                        this.func_70052_a(7, false);
+                }
+            } else {
+                BlockPos blockpos = this.func_226270_aj_();
+                float f3 = this.field_70170_p.func_180495_p(this.func_226270_aj_()).getSlipperiness(field_70170_p, this.func_226270_aj_(), this);
+                float f4 = this.field_70122_E ? f3 * 0.91F : 0.91F;
+                Vector3d vector3d5 = this.func_233633_a_(p_213352_1_, f3);
+                double d2 = vector3d5.field_72448_b;
+                if (this.func_70644_a(Effects.field_188424_y)) {
+                    d2 += (0.05D * (double) (this.func_70660_b(Effects.field_188424_y).func_76458_c() + 1) - vector3d5.field_72448_b) * 0.2D;
+                    this.field_70143_R = 0.0F;
+                } else if (this.field_70170_p.field_72995_K && !this.field_70170_p.func_175667_e(blockpos)) {
+                    if (this.func_226278_cu_() > 0.0D) {
+                        d2 = -0.1D;
+                    } else {
+                        d2 = 0.0D;
+                    }
+                } else if (!this.func_189652_ae()) {
+                    d2 -= d0;
+                }
+
+                this.func_213293_j(vector3d5.field_72450_a * (double) f4, d2 * (double) 0.98F, vector3d5.field_72449_c * (double) f4);
+            }
+        }
+
+        this.func_233629_a_(this, this instanceof IFlyingAnimal);
+    }
+
+    public void func_233629_a_(LivingEntity p_233629_1_, boolean p_233629_2_) {
+        p_233629_1_.field_184618_aE = p_233629_1_.field_70721_aZ;
+        double d0 = p_233629_1_.func_226277_ct_() - p_233629_1_.field_70169_q;
+        double d1 = p_233629_2_ ? p_233629_1_.func_226278_cu_() - p_233629_1_.field_70167_r : 0.0D;
+        double d2 = p_233629_1_.func_226281_cx_() - p_233629_1_.field_70166_s;
+        float f = MathHelper.func_76133_a(d0 * d0 + d1 * d1 + d2 * d2) * 4.0F;
+        if (f > 1.0F) {
+            f = 1.0F;
+        }
+
+        p_233629_1_.field_70721_aZ += (f - p_233629_1_.field_70721_aZ) * 0.4F;
+        p_233629_1_.field_184619_aG += p_233629_1_.field_70721_aZ;
+    }
+
+    public Vector3d func_233633_a_(Vector3d p_233633_1_, float p_233633_2_) {
+        this.func_213309_a(this.func_213335_r(p_233633_2_), p_233633_1_);
+        this.func_213317_d(this.func_213362_f(this.func_213322_ci()));
+        this.func_213315_a(MoverType.SELF, this.func_213322_ci());
+        Vector3d vector3d = this.func_213322_ci();
+        if ((this.field_70123_F || this.field_70703_bu) && this.func_70617_f_()) {
+            vector3d = new Vector3d(vector3d.field_72450_a, 0.2D, vector3d.field_72449_c);
+        }
+
+        return vector3d;
+    }
+
+    public Vector3d func_233626_a_(double p_233626_1_, boolean p_233626_3_, Vector3d p_233626_4_) {
+        if (!this.func_189652_ae() && !this.func_70051_ag()) {
+            double d0;
+            if (p_233626_3_ && Math.abs(p_233626_4_.field_72448_b - 0.005D) >= 0.003D && Math.abs(p_233626_4_.field_72448_b - p_233626_1_ / 16.0D) < 0.003D) {
+                d0 = -0.003D;
+            } else {
+                d0 = p_233626_4_.field_72448_b - p_233626_1_ / 16.0D;
+            }
+
+            return new Vector3d(p_233626_4_.field_72450_a, d0, p_233626_4_.field_72449_c);
+        } else {
+            return p_233626_4_;
+        }
+    }
+
+    private Vector3d func_213362_f(Vector3d p_213362_1_) {
+        if (this.func_70617_f_()) {
+            this.field_70143_R = 0.0F;
+            float f = 0.15F;
+            double d0 = MathHelper.func_151237_a(p_213362_1_.field_72450_a, -0.15F, 0.15F);
+            double d1 = MathHelper.func_151237_a(p_213362_1_.field_72449_c, -0.15F, 0.15F);
+            double d2 = Math.max(p_213362_1_.field_72448_b, -0.15F);
+            if (d2 < 0.0D && !this.func_213339_cH().isScaffolding(this) && this.func_230491_ea_() && this instanceof PlayerEntity) {
+                d2 = 0.0D;
+            }
+
+            p_213362_1_ = new Vector3d(d0, d2, d1);
+        }
+
+        return p_213362_1_;
+    }
+
+    private float func_213335_r(float p_213335_1_) {
+        return this.field_70122_E ? this.func_70689_ay() * (0.21600002F / (p_213335_1_ * p_213335_1_ * p_213335_1_)) : this.field_70747_aH;
+    }
+
+    public float func_70689_ay() {
+        return this.field_70746_aG;
+    }
+
+    public void func_70659_e(float p_70659_1_) {
+        this.field_70746_aG = p_70659_1_;
+    }
+
+    public boolean func_70652_k(Entity p_70652_1_) {
+        this.func_130011_c(p_70652_1_);
+        return false;
+    }
+
+    public void func_70071_h_() {
+        if (net.minecraftforge.common.ForgeHooks.onLivingUpdate(this)) return;
+        super.func_70071_h_();
+        this.func_184608_ct();
+        this.func_205014_p();
+        if (!this.field_70170_p.field_72995_K) {
+            int i = this.func_85035_bI();
+            if (i > 0) {
+                if (this.field_70720_be <= 0) {
+                    this.field_70720_be = 20 * (30 - i);
+                }
+
+                --this.field_70720_be;
+                if (this.field_70720_be <= 0) {
+                    this.func_85034_r(i - 1);
+                }
+            }
+
+            int j = this.func_226297_df_();
+            if (j > 0) {
+                if (this.field_226290_au_ <= 0) {
+                    this.field_226290_au_ = 20 * (30 - j);
+                }
+
+                --this.field_226290_au_;
+                if (this.field_226290_au_ <= 0) {
+                    this.func_226300_q_(j - 1);
+                }
+            }
+
+            this.func_241353_q_();
+            if (this.field_70173_aa % 20 == 0) {
+                this.func_110142_aN().func_94549_h();
+            }
+
+            if (!this.field_184238_ar) {
+                boolean flag = this.func_70644_a(Effects.field_188423_x);
+                if (this.func_70083_f(6) != flag) {
+                    this.func_70052_a(6, flag);
+                }
+            }
+
+            if (this.func_70608_bn() && !this.func_213359_p()) {
+                this.func_213366_dy();
+            }
+        }
+
+        this.func_70636_d();
+        double d0 = this.func_226277_ct_() - this.field_70169_q;
+        double d1 = this.func_226281_cx_() - this.field_70166_s;
+        float f = (float) (d0 * d0 + d1 * d1);
+        float f1 = this.field_70761_aq;
+        float f2 = 0.0F;
+        this.field_70768_au = this.field_110154_aX;
+        float f3 = 0.0F;
+        if (f > 0.0025000002F) {
+            f3 = 1.0F;
+            f2 = (float) Math.sqrt(f) * 3.0F;
+            float f4 = (float) MathHelper.func_181159_b(d1, d0) * (180F / (float) Math.PI) - 90.0F;
+            float f5 = MathHelper.func_76135_e(MathHelper.func_76142_g(this.field_70177_z) - f4);
+            if (95.0F < f5 && f5 < 265.0F) {
+                f1 = f4 - 180.0F;
+            } else {
+                f1 = f4;
+            }
+        }
+
+        if (this.field_70733_aJ > 0.0F) {
+            f1 = this.field_70177_z;
+        }
+
+        if (!this.field_70122_E) {
+            f3 = 0.0F;
+        }
+
+        this.field_110154_aX += (f3 - this.field_110154_aX) * 0.3F;
+        this.field_70170_p.func_217381_Z().func_76320_a("headTurn");
+        f2 = this.func_110146_f(f1, f2);
+        this.field_70170_p.func_217381_Z().func_76319_b();
+        this.field_70170_p.func_217381_Z().func_76320_a("rangeChecks");
+
+        while (this.field_70177_z - this.field_70126_B < -180.0F) {
+            this.field_70126_B -= 360.0F;
+        }
+
+        while (this.field_70177_z - this.field_70126_B >= 180.0F) {
+            this.field_70126_B += 360.0F;
+        }
+
+        while (this.field_70761_aq - this.field_70760_ar < -180.0F) {
+            this.field_70760_ar -= 360.0F;
+        }
+
+        while (this.field_70761_aq - this.field_70760_ar >= 180.0F) {
+            this.field_70760_ar += 360.0F;
+        }
+
+        while (this.field_70125_A - this.field_70127_C < -180.0F) {
+            this.field_70127_C -= 360.0F;
+        }
+
+        while (this.field_70125_A - this.field_70127_C >= 180.0F) {
+            this.field_70127_C += 360.0F;
+        }
+
+        while (this.field_70759_as - this.field_70758_at < -180.0F) {
+            this.field_70758_at -= 360.0F;
+        }
+
+        while (this.field_70759_as - this.field_70758_at >= 180.0F) {
+            this.field_70758_at += 360.0F;
+        }
+
+        this.field_70170_p.func_217381_Z().func_76319_b();
+        this.field_70764_aw += f2;
+        if (this.func_184613_cA()) {
+            ++this.field_184629_bo;
+        } else {
+            this.field_184629_bo = 0;
+        }
+
+        if (this.func_70608_bn()) {
             this.field_70125_A = 0.0F;
-         }
-
-      });
-      Vector3d vector3d = this.func_213303_ch();
-      this.func_213301_b(Pose.STANDING);
-      this.func_70107_b(vector3d.field_72450_a, vector3d.field_72448_b, vector3d.field_72449_c);
-      this.func_213372_dw();
-   }
-
-   @Nullable
-   @OnlyIn(Dist.CLIENT)
-   public Direction func_213376_dz() {
-      BlockPos blockpos = this.func_213374_dv().orElse((BlockPos)null);
-      return blockpos != null ? BedBlock.func_220174_a(this.field_70170_p, blockpos) : null;
-   }
-
-   public boolean func_70094_T() {
-      return !this.func_70608_bn() && super.func_70094_T();
-   }
-
-   protected final float func_213316_a(Pose p_213316_1_, EntitySize p_213316_2_) {
-      return p_213316_1_ == Pose.SLEEPING ? 0.2F : this.func_213348_b(p_213316_1_, p_213316_2_);
-   }
-
-   protected float func_213348_b(Pose p_213348_1_, EntitySize p_213348_2_) {
-      return super.func_213316_a(p_213348_1_, p_213348_2_);
-   }
-
-   public ItemStack func_213356_f(ItemStack p_213356_1_) {
-      return ItemStack.field_190927_a;
-   }
-
-   public ItemStack func_213357_a(World p_213357_1_, ItemStack p_213357_2_) {
-      if (p_213357_2_.func_222117_E()) {
-         p_213357_1_.func_184148_a((PlayerEntity)null, this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), this.func_213353_d(p_213357_2_), SoundCategory.NEUTRAL, 1.0F, 1.0F + (p_213357_1_.field_73012_v.nextFloat() - p_213357_1_.field_73012_v.nextFloat()) * 0.4F);
-         this.func_213349_a(p_213357_2_, p_213357_1_, this);
-         if (!(this instanceof PlayerEntity) || !((PlayerEntity)this).field_71075_bZ.field_75098_d) {
-            p_213357_2_.func_190918_g(1);
-         }
-      }
-
-      return p_213357_2_;
-   }
-
-   private void func_213349_a(ItemStack p_213349_1_, World p_213349_2_, LivingEntity p_213349_3_) {
-      Item item = p_213349_1_.func_77973_b();
-      if (item.func_219971_r()) {
-         for(Pair<EffectInstance, Float> pair : item.func_219967_s().func_221464_f()) {
-            if (!p_213349_2_.field_72995_K && pair.getFirst() != null && p_213349_2_.field_73012_v.nextFloat() < pair.getSecond()) {
-               p_213349_3_.func_195064_c(new EffectInstance(pair.getFirst()));
-            }
-         }
-      }
-
-   }
-
-   private static byte func_213350_d(EquipmentSlotType p_213350_0_) {
-      switch(p_213350_0_) {
-      case MAINHAND:
-         return 47;
-      case OFFHAND:
-         return 48;
-      case HEAD:
-         return 49;
-      case CHEST:
-         return 50;
-      case FEET:
-         return 52;
-      case LEGS:
-         return 51;
-      default:
-         return 47;
-      }
-   }
-
-   public void func_213361_c(EquipmentSlotType p_213361_1_) {
-      this.field_70170_p.func_72960_a(this, func_213350_d(p_213361_1_));
-   }
-
-   public void func_213334_d(Hand p_213334_1_) {
-      this.func_213361_c(p_213334_1_ == Hand.MAIN_HAND ? EquipmentSlotType.MAINHAND : EquipmentSlotType.OFFHAND);
-   }
-
-   @OnlyIn(Dist.CLIENT)
-   public AxisAlignedBB func_184177_bl() {
-      if (this.func_184582_a(EquipmentSlotType.HEAD).func_77973_b() == Items.field_196151_dA) {
-         float f = 0.5F;
-         return this.func_174813_aQ().func_72314_b(0.5D, 0.5D, 0.5D);
-      } else {
-         return super.func_184177_bl();
-      }
-   }
+        }
+    }
+
+    public void func_241353_q_() {
+        Map<EquipmentSlotType, ItemStack> map = this.func_241354_r_();
+        if (map != null) {
+            this.func_241342_a_(map);
+            if (!map.isEmpty()) {
+                this.func_241344_b_(map);
+            }
+        }
+
+    }
+
+    @Nullable
+    private Map<EquipmentSlotType, ItemStack> func_241354_r_() {
+        Map<EquipmentSlotType, ItemStack> map = null;
+
+        for (EquipmentSlotType equipmentslottype : EquipmentSlotType.values()) {
+            ItemStack itemstack;
+            switch (equipmentslottype.func_188453_a()) {
+                case HAND:
+                    itemstack = this.func_241347_e_(equipmentslottype);
+                    break;
+                case ARMOR:
+                    itemstack = this.func_241346_d_(equipmentslottype);
+                    break;
+                default:
+                    continue;
+            }
+
+            ItemStack itemstack1 = this.func_184582_a(equipmentslottype);
+            if (!ItemStack.func_77989_b(itemstack1, itemstack)) {
+                net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.living.LivingEquipmentChangeEvent(this, equipmentslottype, itemstack, itemstack1));
+                if (map == null) {
+                    map = Maps.newEnumMap(EquipmentSlotType.class);
+                }
+
+                map.put(equipmentslottype, itemstack1);
+                if (!itemstack.func_190926_b()) {
+                    this.func_233645_dx_().func_233785_a_(itemstack.func_111283_C(equipmentslottype));
+                }
+
+                if (!itemstack1.func_190926_b()) {
+                    this.func_233645_dx_().func_233793_b_(itemstack1.func_111283_C(equipmentslottype));
+                }
+            }
+        }
+
+        return map;
+    }
+
+    private void func_241342_a_(Map<EquipmentSlotType, ItemStack> p_241342_1_) {
+        ItemStack itemstack = p_241342_1_.get(EquipmentSlotType.MAINHAND);
+        ItemStack itemstack1 = p_241342_1_.get(EquipmentSlotType.OFFHAND);
+        if (itemstack != null && itemstack1 != null && ItemStack.func_77989_b(itemstack, this.func_241347_e_(EquipmentSlotType.OFFHAND)) && ItemStack.func_77989_b(itemstack1, this.func_241347_e_(EquipmentSlotType.MAINHAND))) {
+            ((ServerWorld) this.field_70170_p).func_72863_F().func_217218_b(this, new SEntityStatusPacket(this, (byte) 55));
+            p_241342_1_.remove(EquipmentSlotType.MAINHAND);
+            p_241342_1_.remove(EquipmentSlotType.OFFHAND);
+            this.func_241345_c_(EquipmentSlotType.MAINHAND, itemstack.func_77946_l());
+            this.func_241345_c_(EquipmentSlotType.OFFHAND, itemstack1.func_77946_l());
+        }
+
+    }
+
+    private void func_241344_b_(Map<EquipmentSlotType, ItemStack> p_241344_1_) {
+        List<Pair<EquipmentSlotType, ItemStack>> list = Lists.newArrayListWithCapacity(p_241344_1_.size());
+        p_241344_1_.forEach((p_241341_2_, p_241341_3_) -> {
+            ItemStack itemstack = p_241341_3_.func_77946_l();
+            list.add(Pair.of(p_241341_2_, itemstack));
+            switch (p_241341_2_.func_188453_a()) {
+                case HAND:
+                    this.func_241345_c_(p_241341_2_, itemstack);
+                    break;
+                case ARMOR:
+                    this.func_241343_b_(p_241341_2_, itemstack);
+            }
+
+        });
+        ((ServerWorld) this.field_70170_p).func_72863_F().func_217218_b(this, new SEntityEquipmentPacket(this.func_145782_y(), list));
+    }
+
+    private ItemStack func_241346_d_(EquipmentSlotType p_241346_1_) {
+        return this.field_184631_bt.get(p_241346_1_.func_188454_b());
+    }
+
+    private void func_241343_b_(EquipmentSlotType p_241343_1_, ItemStack p_241343_2_) {
+        this.field_184631_bt.set(p_241343_1_.func_188454_b(), p_241343_2_);
+    }
+
+    private ItemStack func_241347_e_(EquipmentSlotType p_241347_1_) {
+        return this.field_184630_bs.get(p_241347_1_.func_188454_b());
+    }
+
+    private void func_241345_c_(EquipmentSlotType p_241345_1_, ItemStack p_241345_2_) {
+        this.field_184630_bs.set(p_241345_1_.func_188454_b(), p_241345_2_);
+    }
+
+    protected float func_110146_f(float p_110146_1_, float p_110146_2_) {
+        float f = MathHelper.func_76142_g(p_110146_1_ - this.field_70761_aq);
+        this.field_70761_aq += f * 0.3F;
+        float f1 = MathHelper.func_76142_g(this.field_70177_z - this.field_70761_aq);
+        boolean flag = f1 < -90.0F || f1 >= 90.0F;
+        if (f1 < -75.0F) {
+            f1 = -75.0F;
+        }
+
+        if (f1 >= 75.0F) {
+            f1 = 75.0F;
+        }
+
+        this.field_70761_aq = this.field_70177_z - f1;
+        if (f1 * f1 > 2500.0F) {
+            this.field_70761_aq += f1 * 0.2F;
+        }
+
+        if (flag) {
+            p_110146_2_ *= -1.0F;
+        }
+
+        return p_110146_2_;
+    }
+
+    public void func_70636_d() {
+        if (this.field_70773_bE > 0) {
+            --this.field_70773_bE;
+        }
+
+        if (this.func_184186_bw()) {
+            this.field_70716_bi = 0;
+            this.func_213312_b(this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_());
+        }
+
+        if (this.field_70716_bi > 0) {
+            double d0 = this.func_226277_ct_() + (this.field_184623_bh - this.func_226277_ct_()) / (double) this.field_70716_bi;
+            double d2 = this.func_226278_cu_() + (this.field_184624_bi - this.func_226278_cu_()) / (double) this.field_70716_bi;
+            double d4 = this.func_226281_cx_() + (this.field_184625_bj - this.func_226281_cx_()) / (double) this.field_70716_bi;
+            double d6 = MathHelper.func_76138_g(this.field_184626_bk - (double) this.field_70177_z);
+            this.field_70177_z = (float) ((double) this.field_70177_z + d6 / (double) this.field_70716_bi);
+            this.field_70125_A = (float) ((double) this.field_70125_A + (this.field_70709_bj - (double) this.field_70125_A) / (double) this.field_70716_bi);
+            --this.field_70716_bi;
+            this.func_70107_b(d0, d2, d4);
+            this.func_70101_b(this.field_70177_z, this.field_70125_A);
+        } else if (!this.func_70613_aW()) {
+            this.func_213317_d(this.func_213322_ci().func_186678_a(0.98D));
+        }
+
+        if (this.field_208002_br > 0) {
+            this.field_70759_as = (float) ((double) this.field_70759_as + MathHelper.func_76138_g(this.field_208001_bq - (double) this.field_70759_as) / (double) this.field_208002_br);
+            --this.field_208002_br;
+        }
+
+        Vector3d vector3d = this.func_213322_ci();
+        double d1 = vector3d.field_72450_a;
+        double d3 = vector3d.field_72448_b;
+        double d5 = vector3d.field_72449_c;
+        if (Math.abs(vector3d.field_72450_a) < 0.003D) {
+            d1 = 0.0D;
+        }
+
+        if (Math.abs(vector3d.field_72448_b) < 0.003D) {
+            d3 = 0.0D;
+        }
+
+        if (Math.abs(vector3d.field_72449_c) < 0.003D) {
+            d5 = 0.0D;
+        }
+
+        this.func_213293_j(d1, d3, d5);
+        this.field_70170_p.func_217381_Z().func_76320_a("ai");
+        if (this.func_70610_aX()) {
+            this.field_70703_bu = false;
+            this.field_70702_br = 0.0F;
+            this.field_191988_bg = 0.0F;
+        } else if (this.func_70613_aW()) {
+            this.field_70170_p.func_217381_Z().func_76320_a("newAi");
+            this.func_70626_be();
+            this.field_70170_p.func_217381_Z().func_76319_b();
+        }
+
+        this.field_70170_p.func_217381_Z().func_76319_b();
+        this.field_70170_p.func_217381_Z().func_76320_a("jump");
+        if (this.field_70703_bu && this.func_241208_cS_()) {
+            double d7;
+            if (this.func_180799_ab()) {
+                d7 = this.func_233571_b_(FluidTags.field_206960_b);
+            } else {
+                d7 = this.func_233571_b_(FluidTags.field_206959_a);
+            }
+
+            boolean flag = this.func_70090_H() && d7 > 0.0D;
+            double d8 = this.func_233579_cu_();
+            if (!flag || this.field_70122_E && !(d7 > d8)) {
+                if (!this.func_180799_ab() || this.field_70122_E && !(d7 > d8)) {
+                    if ((this.field_70122_E || flag && d7 <= d8) && this.field_70773_bE == 0) {
+                        this.func_70664_aZ();
+                        this.field_70773_bE = 10;
+                    }
+                } else {
+                    this.func_180466_bG(FluidTags.field_206960_b);
+                }
+            } else {
+                this.func_180466_bG(FluidTags.field_206959_a);
+            }
+        } else {
+            this.field_70773_bE = 0;
+        }
+
+        this.field_70170_p.func_217381_Z().func_76319_b();
+        this.field_70170_p.func_217381_Z().func_76320_a("travel");
+        this.field_70702_br *= 0.98F;
+        this.field_191988_bg *= 0.98F;
+        this.func_184616_r();
+        AxisAlignedBB axisalignedbb = this.func_174813_aQ();
+        this.func_213352_e(new Vector3d(this.field_70702_br, this.field_70701_bs, this.field_191988_bg));
+        this.field_70170_p.func_217381_Z().func_76319_b();
+        this.field_70170_p.func_217381_Z().func_76320_a("push");
+        if (this.field_204807_bs > 0) {
+            --this.field_204807_bs;
+            this.func_204801_a(axisalignedbb, this.func_174813_aQ());
+        }
+
+        this.func_85033_bc();
+        this.field_70170_p.func_217381_Z().func_76319_b();
+        // Paper/Mohist start
+        if (this.field_70142_S != func_226277_ct_() || this.field_70137_T != func_226278_cu_() || this.field_70136_U != func_226281_cx_()
+                || this.func_195046_g(0.0F) != this.func_195046_g(1.0F)
+                || this.func_195050_f(0.0F) != this.func_195050_f(1.0F)) {
+            Location from = new Location(field_70170_p.getWorld(),
+                    this.field_70142_S,
+                    this.field_70137_T,
+                    this.field_70136_U,
+                    this.func_195046_g(0.0F),
+                    this.func_195050_f(0.0F));
+            Location to = new Location(field_70170_p.getWorld(),
+                    func_226277_ct_(),
+                    func_226278_cu_(),
+                    func_226281_cx_(),
+                    this.func_195046_g(1.0F),
+                    this.func_195050_f(1.0F));
+            EntityMoveEvent event = new EntityMoveEvent(
+                    (org.bukkit.entity.LivingEntity) this.getBukkitEntity(),
+                    from.clone(),
+                    to.clone());
+            Bukkit.getServer().getPluginManager().callEvent(event);
+            if (event.isCancelled()) {
+                this.func_70107_b(from.getX(), from.getY(), from.getZ());
+                this.func_70101_b(from.getYaw(), from.getPitch());
+            } else if (!to.equals(event.getTo())) {
+                this.func_70107_b(event.getTo().getX(),
+                        event.getTo().getY(),
+                        event.getTo().getZ());
+                this.func_70101_b(event.getTo().getYaw(), event.getTo().getPitch());
+            }
+        }
+        // Paper/Mohist end
+        if (!this.field_70170_p.field_72995_K && this.func_230270_dK_() && this.func_203008_ap()) {
+            this.func_70097_a(DamageSource.field_76369_e, 1.0F);
+        }
+
+    }
+
+    public boolean func_230270_dK_() {
+        return false;
+    }
+
+    private void func_184616_r() {
+        boolean flag = this.func_70083_f(7);
+        if (flag && !this.field_70122_E && !this.func_184218_aH() && !this.func_70644_a(Effects.field_188424_y)) {
+            ItemStack itemstack = this.func_184582_a(EquipmentSlotType.CHEST);
+            flag = itemstack.canElytraFly(this) && itemstack.elytraFlightTick(this, this.field_184629_bo);
+            if (false) //Forge: Moved to ElytraItem
+                if (itemstack.func_77973_b() == Items.field_185160_cR && ElytraItem.func_185069_d(itemstack)) {
+                    flag = true;
+                    if (!this.field_70170_p.field_72995_K && (this.field_184629_bo + 1) % 20 == 0) {
+                        itemstack.func_222118_a(1, this, (p_233652_0_) -> {
+                            p_233652_0_.func_213361_c(EquipmentSlotType.CHEST);
+                        });
+                    }
+                } else {
+                    flag = false;
+                }
+        } else {
+            flag = false;
+        }
+
+        if (!this.field_70170_p.field_72995_K) {
+            if (flag != this.func_70083_f(7) && !CraftEventFactory.callToggleGlideEvent(this, flag).isCancelled()) // CraftBukkit
+                this.func_70052_a(7, flag);
+        }
+
+    }
+
+    protected void func_70626_be() {
+    }
+
+    protected void func_85033_bc() {
+        List<Entity> list = this.field_70170_p.func_175674_a(this, this.func_174813_aQ(), EntityPredicates.func_200823_a(this));
+        if (!list.isEmpty()) {
+            int i = this.field_70170_p.func_82736_K().func_223592_c(GameRules.field_223616_s);
+            if (i > 0 && list.size() > i - 1 && this.field_70146_Z.nextInt(4) == 0) {
+                int j = 0;
+
+                for (int k = 0; k < list.size(); ++k) {
+                    if (!list.get(k).func_184218_aH()) {
+                        ++j;
+                    }
+                }
+
+                if (j > i - 1) {
+                    this.func_70097_a(DamageSource.field_191291_g, 6.0F);
+                }
+            }
+
+            for (int l = 0; l < list.size(); ++l) {
+                Entity entity = list.get(l);
+                this.func_82167_n(entity);
+            }
+        }
+
+    }
+
+    protected void func_204801_a(AxisAlignedBB p_204801_1_, AxisAlignedBB p_204801_2_) {
+        AxisAlignedBB axisalignedbb = p_204801_1_.func_111270_a(p_204801_2_);
+        List<Entity> list = this.field_70170_p.func_72839_b(this, axisalignedbb);
+        if (!list.isEmpty()) {
+            for (int i = 0; i < list.size(); ++i) {
+                Entity entity = list.get(i);
+                if (entity instanceof LivingEntity) {
+                    this.func_204804_d((LivingEntity) entity);
+                    this.field_204807_bs = 0;
+                    this.func_213317_d(this.func_213322_ci().func_186678_a(-0.2D));
+                    break;
+                }
+            }
+        } else if (this.field_70123_F) {
+            this.field_204807_bs = 0;
+        }
+
+        if (!this.field_70170_p.field_72995_K && this.field_204807_bs <= 0) {
+            this.func_204802_c(4, false);
+        }
+
+    }
+
+    protected void func_82167_n(Entity p_82167_1_) {
+        p_82167_1_.func_70108_f(this);
+    }
+
+    protected void func_204804_d(LivingEntity p_204804_1_) {
+    }
+
+    public void func_204803_n(int p_204803_1_) {
+        this.field_204807_bs = p_204803_1_;
+        if (!this.field_70170_p.field_72995_K) {
+            this.func_204802_c(4, true);
+        }
+
+    }
+
+    public boolean func_204805_cN() {
+        return (this.field_70180_af.func_187225_a(field_184621_as) & 4) != 0;
+    }
+
+    public void func_184210_p() {
+        Entity entity = this.func_184187_bx();
+        super.func_184210_p();
+        if (entity != null && entity != this.func_184187_bx() && !this.field_70170_p.field_72995_K) {
+            this.func_233628_a_(entity);
+        }
+
+    }
+
+    public void func_70098_U() {
+        super.func_70098_U();
+        this.field_70768_au = this.field_110154_aX;
+        this.field_110154_aX = 0.0F;
+        this.field_70143_R = 0.0F;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public void func_180426_a(double p_180426_1_, double p_180426_3_, double p_180426_5_, float p_180426_7_, float p_180426_8_, int p_180426_9_, boolean p_180426_10_) {
+        this.field_184623_bh = p_180426_1_;
+        this.field_184624_bi = p_180426_3_;
+        this.field_184625_bj = p_180426_5_;
+        this.field_184626_bk = p_180426_7_;
+        this.field_70709_bj = p_180426_8_;
+        this.field_70716_bi = p_180426_9_;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public void func_208000_a(float p_208000_1_, int p_208000_2_) {
+        this.field_208001_bq = p_208000_1_;
+        this.field_208002_br = p_208000_2_;
+    }
+
+    public void func_70637_d(boolean p_70637_1_) {
+        this.field_70703_bu = p_70637_1_;
+    }
+
+    public void func_233630_a_(ItemEntity p_233630_1_) {
+        PlayerEntity playerentity = p_233630_1_.func_200214_m() != null ? this.field_70170_p.func_217371_b(p_233630_1_.func_200214_m()) : null;
+        if (playerentity instanceof ServerPlayerEntity) {
+            CriteriaTriggers.field_232609_O_.func_234830_a_((ServerPlayerEntity) playerentity, p_233630_1_.func_92059_d(), this);
+        }
+
+    }
+
+    public void func_71001_a(Entity p_71001_1_, int p_71001_2_) {
+        if (!p_71001_1_.field_70128_L && !this.field_70170_p.field_72995_K && (p_71001_1_ instanceof ItemEntity || p_71001_1_ instanceof AbstractArrowEntity || p_71001_1_ instanceof ExperienceOrbEntity)) {
+            ((ServerWorld) this.field_70170_p).func_72863_F().func_217218_b(p_71001_1_, new SCollectItemPacket(p_71001_1_.func_145782_y(), this.func_145782_y(), p_71001_2_));
+        }
+
+    }
+
+    public boolean func_70685_l(Entity p_70685_1_) {
+        if (this.field_70170_p != p_70685_1_.field_70170_p) return false; // CraftBukkit - SPIGOT-5675, SPIGOT-5798, MC-149563
+        Vector3d vector3d = new Vector3d(this.func_226277_ct_(), this.func_226280_cw_(), this.func_226281_cx_());
+        Vector3d vector3d1 = new Vector3d(p_70685_1_.func_226277_ct_(), p_70685_1_.func_226280_cw_(), p_70685_1_.func_226281_cx_());
+        return this.field_70170_p.func_217299_a(new RayTraceContext(vector3d, vector3d1, RayTraceContext.BlockMode.COLLIDER, RayTraceContext.FluidMode.NONE, this)).func_216346_c() == RayTraceResult.Type.MISS;
+    }
+
+    public float func_195046_g(float p_195046_1_) {
+        return p_195046_1_ == 1.0F ? this.field_70759_as : MathHelper.func_219799_g(p_195046_1_, this.field_70758_at, this.field_70759_as);
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public float func_70678_g(float p_70678_1_) {
+        float f = this.field_70733_aJ - this.field_70732_aI;
+        if (f < 0.0F) {
+            ++f;
+        }
+
+        return this.field_70732_aI + f * p_70678_1_;
+    }
+
+    public boolean func_70613_aW() {
+        return !this.field_70170_p.field_72995_K;
+    }
+
+    public boolean func_70067_L() {
+        return !this.field_70128_L && this.collides; // CraftBukkit
+    }
+
+    public boolean func_70104_M() {
+        return this.func_70089_S() && !this.func_175149_v() && !this.func_70617_f_() && this.collides; // CraftBukkit
+    }
+
+    // CraftBukkit start - collidable API
+    @Override
+    public boolean canCollideWithCB(Entity entity) {
+        return func_70104_M() && this.collides != this.collidableExemptions.contains(entity.func_110124_au());
+    }
+    // CraftBukkit end
+
+    protected void func_70018_K() {
+        this.field_70133_I = this.field_70146_Z.nextDouble() >= this.func_233637_b_(Attributes.field_233820_c_);
+    }
+
+    public float func_70079_am() {
+        return this.field_70759_as;
+    }
+
+    public void func_70034_d(float p_70034_1_) {
+        this.field_70759_as = p_70034_1_;
+    }
+
+    public void func_181013_g(float p_181013_1_) {
+        this.field_70761_aq = p_181013_1_;
+    }
+
+    protected Vector3d func_241839_a(Direction.Axis p_241839_1_, TeleportationRepositioner.Result p_241839_2_) {
+        return func_242288_h(super.func_241839_a(p_241839_1_, p_241839_2_));
+    }
+
+    public static Vector3d func_242288_h(Vector3d p_242288_0_) {
+        return new Vector3d(p_242288_0_.field_72450_a, p_242288_0_.field_72448_b, 0.0D);
+    }
+
+    public float func_110139_bj() {
+        return this.field_110151_bq;
+    }
+
+    public void func_110149_m(float p_110149_1_) {
+        if (p_110149_1_ < 0.0F) {
+            p_110149_1_ = 0.0F;
+        }
+
+        this.field_110151_bq = p_110149_1_;
+    }
+
+    public void func_152111_bt() {
+    }
+
+    public void func_152112_bu() {
+    }
+
+    protected void func_175136_bO() {
+        this.field_70752_e = true;
+    }
+
+    public abstract HandSide func_184591_cq();
+
+    public boolean func_184587_cr() {
+        return (this.field_70180_af.func_187225_a(field_184621_as) & 1) > 0;
+    }
+
+    public Hand func_184600_cs() {
+        return (this.field_70180_af.func_187225_a(field_184621_as) & 2) > 0 ? Hand.OFF_HAND : Hand.MAIN_HAND;
+    }
+
+    // Paper start - lag compensate eating
+    protected long eatStartTime;
+    protected int totalEatTimeTicks;
+    // Paper end
+
+    private void func_184608_ct() {
+        if (this.func_184587_cr()) {
+            ItemStack itemStack = this.func_184586_b(this.func_184600_cs());
+            if (net.minecraftforge.common.ForgeHooks.canContinueUsing(this.field_184627_bm, itemStack))
+                this.field_184627_bm = itemStack;
+            if (itemStack == this.field_184627_bm) {
+
+                if (!this.field_184627_bm.func_190926_b()) {
+                    field_184628_bn = net.minecraftforge.event.ForgeEventFactory.onItemUseTick(this, field_184627_bm, field_184628_bn);
+                    if (field_184628_bn > 0)
+                        field_184627_bm.onUsingTick(this, field_184628_bn);
+                }
+
+                this.field_184627_bm.func_222121_b(this.field_70170_p, this, this.func_184605_cv());
+                if (this.func_226299_p_()) {
+                    this.func_226293_b_(this.field_184627_bm, 5);
+                }
+
+                //if (--this.useItemRemaining == 0 && !this.level.isClientSide && !this.useItem.useOnRelease()) {
+                // Paper start - lag compensate eating
+                // we add 1 to the expected time to avoid lag compensating when we should not
+                boolean shouldLagCompensate = this.field_184627_bm.func_77973_b().isFood() && this.eatStartTime != -1 && (System.nanoTime() - this.eatStartTime) > ((1 + this.totalEatTimeTicks) * 50 * (1000 * 1000));
+                if ((--this.field_184628_bn == 0 || shouldLagCompensate) && !this.field_70170_p.field_72995_K && !this.field_184627_bm.func_222122_m()) {
+                    this.setEatTimeTicks(0);
+                    // Paper end
+                    this.func_71036_o();
+                }
+            } else {
+                this.func_184602_cy();
+            }
+        }
+
+    }
+
+    private boolean func_226299_p_() {
+        int i = this.func_184605_cv();
+        Food food = this.field_184627_bm.func_77973_b().func_219967_s();
+        boolean flag = food != null && food.func_221465_e();
+        flag = flag | i <= this.field_184627_bm.func_77988_m() - 7;
+        return flag && i % 4 == 0;
+    }
+
+    private void func_205014_p() {
+        this.field_205018_bM = this.field_205017_bL;
+        if (this.func_213314_bj()) {
+            this.field_205017_bL = Math.min(1.0F, this.field_205017_bL + 0.09F);
+        } else {
+            this.field_205017_bL = Math.max(0.0F, this.field_205017_bL - 0.09F);
+        }
+
+    }
+
+    protected void func_204802_c(int p_204802_1_, boolean p_204802_2_) {
+        int i = this.field_70180_af.func_187225_a(field_184621_as);
+        if (p_204802_2_) {
+            i = i | p_204802_1_;
+        } else {
+            i = i & ~p_204802_1_;
+        }
+
+        this.field_70180_af.func_187227_b(field_184621_as, (byte) i);
+    }
+
+    public void func_184598_c(Hand p_184598_1_) {
+        ItemStack itemstack = this.func_184586_b(p_184598_1_);
+        if (!itemstack.func_190926_b() && !this.func_184587_cr()) {
+            int duration = net.minecraftforge.event.ForgeEventFactory.onItemUseStart(this, itemstack, itemstack.func_77988_m());
+            if (duration <= 0) return;
+            this.field_184627_bm = itemstack;
+            // Paper start - lag compensate eating
+            this.field_184628_bn = this.totalEatTimeTicks = duration;
+            this.eatStartTime = System.nanoTime();
+            // Paper end
+            if (!this.field_70170_p.field_72995_K) {
+                this.func_204802_c(1, true);
+                this.func_204802_c(2, p_184598_1_ == Hand.OFF_HAND);
+            }
+
+        }
+    }
+
+    public void func_184206_a(DataParameter<?> p_184206_1_) {
+        super.func_184206_a(p_184206_1_);
+        if (field_213379_bs.equals(p_184206_1_)) {
+            if (this.field_70170_p.field_72995_K) {
+                this.func_213374_dv().ifPresent(this::func_213370_a);
+            }
+        } else if (field_184621_as.equals(p_184206_1_) && this.field_70170_p.field_72995_K) {
+            if (this.func_184587_cr() && this.field_184627_bm.func_190926_b()) {
+                this.field_184627_bm = this.func_184586_b(this.func_184600_cs());
+                if (!this.field_184627_bm.func_190926_b()) {
+                    this.field_184628_bn = this.field_184627_bm.func_77988_m();
+                }
+            } else if (!this.func_184587_cr() && !this.field_184627_bm.func_190926_b()) {
+                this.field_184627_bm = ItemStack.field_190927_a;
+                // Paper start - lag compensate eating
+                this.field_184628_bn = this.totalEatTimeTicks = 0;
+                this.eatStartTime = -1L;
+                // Paper end
+            }
+        }
+
+    }
+
+    public void func_200602_a(EntityAnchorArgument.Type p_200602_1_, Vector3d p_200602_2_) {
+        super.func_200602_a(p_200602_1_, p_200602_2_);
+        this.field_70758_at = this.field_70759_as;
+        this.field_70761_aq = this.field_70759_as;
+        this.field_70760_ar = this.field_70761_aq;
+    }
+
+    protected void func_226293_b_(ItemStack p_226293_1_, int p_226293_2_) {
+        if (!p_226293_1_.func_190926_b() && this.func_184587_cr()) {
+            if (p_226293_1_.func_77975_n() == UseAction.DRINK) {
+                this.func_184185_a(this.func_213351_c(p_226293_1_), 0.5F, this.field_70170_p.field_73012_v.nextFloat() * 0.1F + 0.9F);
+            }
+
+            if (p_226293_1_.func_77975_n() == UseAction.EAT) {
+                this.func_195062_a(p_226293_1_, p_226293_2_);
+                this.func_184185_a(this.func_213353_d(p_226293_1_), 0.5F + 0.5F * (float) this.field_70146_Z.nextInt(2), (this.field_70146_Z.nextFloat() - this.field_70146_Z.nextFloat()) * 0.2F + 1.0F);
+            }
+
+        }
+    }
+
+    private void func_195062_a(ItemStack p_195062_1_, int p_195062_2_) {
+        for (int i = 0; i < p_195062_2_; ++i) {
+            Vector3d vector3d = new Vector3d(((double) this.field_70146_Z.nextFloat() - 0.5D) * 0.1D, Math.random() * 0.1D + 0.1D, 0.0D);
+            vector3d = vector3d.func_178789_a(-this.field_70125_A * ((float) Math.PI / 180F));
+            vector3d = vector3d.func_178785_b(-this.field_70177_z * ((float) Math.PI / 180F));
+            double d0 = (double) (-this.field_70146_Z.nextFloat()) * 0.6D - 0.3D;
+            Vector3d vector3d1 = new Vector3d(((double) this.field_70146_Z.nextFloat() - 0.5D) * 0.3D, d0, 0.6D);
+            vector3d1 = vector3d1.func_178789_a(-this.field_70125_A * ((float) Math.PI / 180F));
+            vector3d1 = vector3d1.func_178785_b(-this.field_70177_z * ((float) Math.PI / 180F));
+            vector3d1 = vector3d1.func_72441_c(this.func_226277_ct_(), this.func_226280_cw_(), this.func_226281_cx_());
+            if (this.field_70170_p instanceof ServerWorld) //Forge: Fix MC-2518 spawnParticle is nooped on server, need to use server specific variant
+                ((ServerWorld) this.field_70170_p).func_195598_a(new ItemParticleData(ParticleTypes.field_197591_B, p_195062_1_), vector3d1.field_72450_a, vector3d1.field_72448_b, vector3d1.field_72449_c, 1, vector3d.field_72450_a, vector3d.field_72448_b + 0.05D, vector3d.field_72449_c, 0.0D);
+            else
+                this.field_70170_p.func_195594_a(new ItemParticleData(ParticleTypes.field_197591_B, p_195062_1_), vector3d1.field_72450_a, vector3d1.field_72448_b, vector3d1.field_72449_c, vector3d.field_72450_a, vector3d.field_72448_b + 0.05D, vector3d.field_72449_c);
+        }
+
+    }
+
+    protected void func_71036_o() {
+        Hand hand = this.func_184600_cs();
+        if (!this.field_184627_bm.equals(this.func_184586_b(hand))) {
+            this.func_184597_cx();
+        } else {
+            if (!this.field_184627_bm.func_190926_b() && this.func_184587_cr()) {
+                this.func_226293_b_(this.field_184627_bm, 16);
+                ItemStack copy = this.field_184627_bm.func_77946_l();
+                ItemStack stack = net.minecraftforge.event.ForgeEventFactory.onItemUseFinish(this, copy, func_184605_cv(), this.field_184627_bm.func_77950_b(this.field_70170_p, this));
+
+                // CraftBukkit start - fire PlayerItemConsumeEvent
+                ItemStack itemstack;
+                if (this instanceof ServerPlayerEntity) {
+                    org.bukkit.inventory.ItemStack craftItem = CraftItemStack.asBukkitCopy(copy);
+                    PlayerItemConsumeEvent event = new PlayerItemConsumeEvent((Player) this.getBukkitEntity(), craftItem);
+                    field_70170_p.getCBServer().getPluginManager().callEvent(event);
+
+                    if (event.isCancelled()) {
+                        // Update client
+                        ((ServerPlayerEntity) this).getBukkitEntity().updateInventory();
+                        ((ServerPlayerEntity) this).getBukkitEntity().updateScaledHealth();
+                        return;
+                    }
+                    itemstack = (craftItem.equals(event.getItem())) ? stack : CraftItemStack.asNMSCopy(event.getItem()).func_77950_b(field_70170_p, this);
+                } else {
+                    itemstack = stack;
+                }
+                // CraftBukkit end
+
+                if (itemstack != this.field_184627_bm) {
+                    this.func_184611_a(hand, itemstack);
+                }
+
+                this.func_184602_cy();
+            }
+
+        }
+    }
+
+    public ItemStack func_184607_cu() {
+        return this.field_184627_bm;
+    }
+
+    public int func_184605_cv() {
+        return this.field_184628_bn;
+    }
+
+    public int func_184612_cw() {
+        return this.func_184587_cr() ? this.field_184627_bm.func_77988_m() - this.func_184605_cv() : 0;
+    }
+
+    public void func_184597_cx() {
+        if (!this.field_184627_bm.func_190926_b()) {
+            if (!net.minecraftforge.event.ForgeEventFactory.onUseItemStop(this, field_184627_bm, this.func_184605_cv())) {
+                ItemStack copy = this instanceof PlayerEntity ? field_184627_bm.func_77946_l() : null;
+                this.field_184627_bm.func_77974_b(this.field_70170_p, this, this.func_184605_cv());
+                if (copy != null && field_184627_bm.func_190926_b())
+                    net.minecraftforge.event.ForgeEventFactory.onPlayerDestroyItem((PlayerEntity) this, copy, func_184600_cs());
+            }
+            if (this.field_184627_bm.func_222122_m()) {
+                this.func_184608_ct();
+            }
+        }
+
+        this.func_184602_cy();
+    }
+
+    public void func_184602_cy() {
+        if (!this.field_70170_p.field_72995_K) {
+            this.func_204802_c(1, false);
+        }
+
+        this.field_184627_bm = ItemStack.field_190927_a;
+        // Paper start - lag compensate eating
+        this.field_184628_bn = this.totalEatTimeTicks = 0;
+        this.eatStartTime = -1L;
+        // Paper end
+    }
+
+    public boolean func_184585_cz() {
+        if (this.func_184587_cr() && !this.field_184627_bm.func_190926_b()) {
+            Item item = this.field_184627_bm.func_77973_b();
+            if (item.func_77661_b(this.field_184627_bm) != UseAction.BLOCK) {
+                return false;
+            } else {
+                return item.func_77626_a(this.field_184627_bm) - this.field_184628_bn >= 5;
+            }
+        } else {
+            return false;
+        }
+    }
+
+    public boolean func_230491_ea_() {
+        return this.func_225608_bj_();
+    }
+
+    public boolean func_184613_cA() {
+        return this.func_70083_f(7);
+    }
+
+    public boolean func_213314_bj() {
+        return super.func_213314_bj() || !this.func_184613_cA() && this.func_213283_Z() == Pose.FALL_FLYING;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public int func_184599_cB() {
+        return this.field_184629_bo;
+    }
+
+    public boolean func_213373_a(double p_213373_1_, double p_213373_3_, double p_213373_5_, boolean p_213373_7_) {
+        double d0 = this.func_226277_ct_();
+        double d1 = this.func_226278_cu_();
+        double d2 = this.func_226281_cx_();
+        double d3 = p_213373_3_;
+        boolean flag = false;
+        BlockPos blockpos = new BlockPos(p_213373_1_, p_213373_3_, p_213373_5_);
+        World world = this.field_70170_p;
+        if (world.func_175667_e(blockpos)) {
+            boolean flag1 = false;
+
+            while (!flag1 && blockpos.func_177956_o() > 0) {
+                BlockPos blockpos1 = blockpos.func_177977_b();
+                BlockState blockstate = world.func_180495_p(blockpos1);
+                if (blockstate.func_185904_a().func_76230_c()) {
+                    flag1 = true;
+                } else {
+                    --d3;
+                    blockpos = blockpos1;
+                }
+            }
+
+            if (flag1) {
+                // CraftBukkit start - Teleport event
+                // this.setPositionAndUpdate(x, d3, z);
+                EntityTeleportEvent teleport = new EntityTeleportEvent(this.getBukkitEntity(), new Location(this.field_70170_p.getWorld(), d0, d1, d2), new Location(this.field_70170_p.getWorld(), p_213373_1_, d3, p_213373_5_));
+                this.field_70170_p.getCBServer().getPluginManager().callEvent(teleport);
+                if (!teleport.isCancelled()) {
+                    Location to = teleport.getTo();
+                    this.func_70634_a(to.getX(), to.getY(), to.getZ());
+                    if (world.func_226669_j_(this) && !world.func_72953_d(this.func_174813_aQ())) {
+                        flag = true;
+                    }
+                }
+                // CraftBukkit end
+            }
+        }
+
+        if (!flag) {
+            this.func_70634_a(d0, d1, d2);
+            return false;
+        } else {
+            if (p_213373_7_) {
+                world.func_72960_a(this, (byte) 46);
+            }
+
+            if (this instanceof CreatureEntity) {
+                ((CreatureEntity) this).func_70661_as().func_75499_g();
+            }
+
+            return true;
+        }
+    }
+
+    public boolean func_184603_cC() {
+        return true;
+    }
+
+    public boolean func_190631_cK() {
+        return true;
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public void func_191987_a(BlockPos p_191987_1_, boolean p_191987_2_) {
+    }
+
+    public boolean func_213365_e(ItemStack p_213365_1_) {
+        return false;
+    }
+
+    public IPacket<?> func_213297_N() {
+        return new SSpawnMobPacket(this);
+    }
+
+    public EntitySize func_213305_a(Pose p_213305_1_) {
+        return p_213305_1_ == Pose.SLEEPING ? field_213377_as : super.func_213305_a(p_213305_1_).func_220313_a(this.func_213355_cm());
+    }
+
+    public ImmutableList<Pose> func_230297_ef_() {
+        return ImmutableList.of(Pose.STANDING);
+    }
+
+    public AxisAlignedBB func_233648_f_(Pose p_233648_1_) {
+        EntitySize entitysize = this.func_213305_a(p_233648_1_);
+        return new AxisAlignedBB(-entitysize.field_220315_a / 2.0F, 0.0D, -entitysize.field_220315_a / 2.0F, entitysize.field_220315_a / 2.0F, entitysize.field_220316_b, entitysize.field_220315_a / 2.0F);
+    }
+
+    public Optional<BlockPos> func_213374_dv() {
+        return this.field_70180_af.func_187225_a(field_213379_bs);
+    }
+
+    public void func_213369_d(BlockPos p_213369_1_) {
+        this.field_70180_af.func_187227_b(field_213379_bs, Optional.of(p_213369_1_));
+    }
+
+    public void func_213372_dw() {
+        this.field_70180_af.func_187227_b(field_213379_bs, Optional.empty());
+    }
+
+    public boolean func_70608_bn() {
+        return this.func_213374_dv().isPresent();
+    }
+
+    public void func_213342_e(BlockPos p_213342_1_) {
+        if (this.func_184218_aH()) {
+            this.func_184210_p();
+        }
+
+        BlockState blockstate = this.field_70170_p.func_180495_p(p_213342_1_);
+        if (blockstate.isBed(field_70170_p, p_213342_1_, this)) {
+            blockstate.setBedOccupied(field_70170_p, p_213342_1_, this, true);
+        }
+
+        this.func_213301_b(Pose.SLEEPING);
+        this.func_213370_a(p_213342_1_);
+        this.func_213369_d(p_213342_1_);
+        this.func_213317_d(Vector3d.field_186680_a);
+        this.field_70160_al = true;
+    }
+
+    private void func_213370_a(BlockPos p_213370_1_) {
+        this.func_70107_b((double) p_213370_1_.func_177958_n() + 0.5D, (double) p_213370_1_.func_177956_o() + 0.6875D, (double) p_213370_1_.func_177952_p() + 0.5D);
+    }
+
+    private boolean func_213359_p() {
+        return this.func_213374_dv().map((p_241350_1_) -> {
+            return net.minecraftforge.event.ForgeEventFactory.fireSleepingLocationCheck(this, p_241350_1_);
+        }).orElse(false);
+    }
+
+    public void func_213366_dy() {
+        this.func_213374_dv().filter(this.field_70170_p::func_175667_e).ifPresent((p_241348_1_) -> {
+            BlockState blockstate = this.field_70170_p.func_180495_p(p_241348_1_);
+            if (blockstate.isBed(field_70170_p, p_241348_1_, this)) {
+                blockstate.setBedOccupied(field_70170_p, p_241348_1_, this, false);
+                Vector3d vector3d1 = BedBlock.func_242652_a(this.func_200600_R(), this.field_70170_p, p_241348_1_, this.field_70177_z).orElseGet(() -> {
+                    BlockPos blockpos = p_241348_1_.func_177984_a();
+                    return new Vector3d((double) blockpos.func_177958_n() + 0.5D, (double) blockpos.func_177956_o() + 0.1D, (double) blockpos.func_177952_p() + 0.5D);
+                });
+                Vector3d vector3d2 = Vector3d.func_237492_c_(p_241348_1_).func_178788_d(vector3d1).func_72432_b();
+                float f = (float) MathHelper.func_76138_g(MathHelper.func_181159_b(vector3d2.field_72449_c, vector3d2.field_72450_a) * (double) (180F / (float) Math.PI) - 90.0D);
+                this.func_70107_b(vector3d1.field_72450_a, vector3d1.field_72448_b, vector3d1.field_72449_c);
+                this.field_70177_z = f;
+                this.field_70125_A = 0.0F;
+            }
+
+        });
+        Vector3d vector3d = this.func_213303_ch();
+        this.func_213301_b(Pose.STANDING);
+        this.func_70107_b(vector3d.field_72450_a, vector3d.field_72448_b, vector3d.field_72449_c);
+        this.func_213372_dw();
+    }
+
+    @Nullable
+    @OnlyIn(Dist.CLIENT)
+    public Direction func_213376_dz() {
+        BlockPos blockpos = this.func_213374_dv().orElse(null);
+        if (blockpos == null) return Direction.UP;
+        BlockState state = this.field_70170_p.func_180495_p(blockpos);
+        return !state.isBed(field_70170_p, blockpos, this) ? Direction.UP : state.getBedDirection(field_70170_p, blockpos);
+    }
+
+    public boolean func_70094_T() {
+        return !this.func_70608_bn() && super.func_70094_T();
+    }
+
+    protected final float func_213316_a(Pose p_213316_1_, EntitySize p_213316_2_) {
+        return p_213316_1_ == Pose.SLEEPING ? 0.2F : this.func_213348_b(p_213316_1_, p_213316_2_);
+    }
+
+    protected float func_213348_b(Pose p_213348_1_, EntitySize p_213348_2_) {
+        return super.func_213316_a(p_213348_1_, p_213348_2_);
+    }
+
+    public ItemStack func_213356_f(ItemStack p_213356_1_) {
+        return ItemStack.field_190927_a;
+    }
+
+    public ItemStack func_213357_a(World p_213357_1_, ItemStack p_213357_2_) {
+        if (p_213357_2_.func_222117_E()) {
+            p_213357_1_.func_184148_a(null, this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), this.func_213353_d(p_213357_2_), SoundCategory.NEUTRAL, 1.0F, 1.0F + (p_213357_1_.field_73012_v.nextFloat() - p_213357_1_.field_73012_v.nextFloat()) * 0.4F);
+            this.func_213349_a(p_213357_2_, p_213357_1_, this);
+            if (!(this instanceof PlayerEntity) || !((PlayerEntity) this).field_71075_bZ.field_75098_d) {
+                p_213357_2_.func_190918_g(1);
+            }
+        }
+
+        return p_213357_2_;
+    }
+
+    private void func_213349_a(ItemStack p_213349_1_, World p_213349_2_, LivingEntity p_213349_3_) {
+        Item item = p_213349_1_.func_77973_b();
+        if (item.func_219971_r()) {
+            for (Pair<EffectInstance, Float> pair : item.func_219967_s().func_221464_f()) {
+                if (!p_213349_2_.field_72995_K && pair.getFirst() != null && p_213349_2_.field_73012_v.nextFloat() < pair.getSecond()) {
+                    p_213349_3_.addEffect(new EffectInstance(pair.getFirst()), Cause.FOOD); // CraftBukkit
+                }
+            }
+        }
+
+    }
+
+    private static byte func_213350_d(EquipmentSlotType p_213350_0_) {
+        switch (p_213350_0_) {
+            case MAINHAND:
+                return 47;
+            case OFFHAND:
+                return 48;
+            case HEAD:
+                return 49;
+            case CHEST:
+                return 50;
+            case FEET:
+                return 52;
+            case LEGS:
+                return 51;
+            default:
+                return 47;
+        }
+    }
+
+    public void func_213361_c(EquipmentSlotType p_213361_1_) {
+        this.field_70170_p.func_72960_a(this, func_213350_d(p_213361_1_));
+    }
+
+    public void func_213334_d(Hand p_213334_1_) {
+        this.func_213361_c(p_213334_1_ == Hand.MAIN_HAND ? EquipmentSlotType.MAINHAND : EquipmentSlotType.OFFHAND);
+    }
+
+    /* ==== FORGE START ==== */
+
+    /***
+     * Removes all potion effects that have curativeItem as a curative item for its effect
+     * @param curativeItem The itemstack we are using to cure potion effects
+     */
+    public boolean curePotionEffects(ItemStack curativeItem) {
+        if (this.field_70170_p.field_72995_K)
+            return false;
+        boolean ret = false;
+        Iterator<EffectInstance> itr = this.field_70713_bf.values().iterator();
+        while (itr.hasNext()) {
+            EffectInstance effect = itr.next();
+            if (effect.isCurativeItem(curativeItem) && !net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.living.PotionEvent.PotionRemoveEvent(this, effect))) {
+                this.func_70688_c(effect);
+                itr.remove();
+                ret = true;
+                this.field_70752_e = true;
+            }
+        }
+        return ret;
+    }
+
+    /**
+     * Returns true if the entity's rider (EntityPlayer) should face forward when mounted.
+     * currently only used in vanilla code by pigs.
+     *
+     * @param player The player who is riding the entity.
+     * @return If the player should orient the same direction as this entity.
+     */
+    public boolean shouldRiderFaceForward(PlayerEntity player) {
+        return this instanceof net.minecraft.entity.passive.PigEntity;
+    }
+
+    private final net.minecraftforge.common.util.LazyOptional<?>[] handlers = net.minecraftforge.items.wrapper.EntityEquipmentInvWrapper.create(this);
+
+    @Override
+    public <T> net.minecraftforge.common.util.LazyOptional<T> getCapability(net.minecraftforge.common.capabilities.Capability<T> capability, @Nullable Direction facing) {
+        if (this.func_70089_S() && capability == net.minecraftforge.items.CapabilityItemHandler.ITEM_HANDLER_CAPABILITY) {
+            if (facing == null) return handlers[2].cast();
+            else if (facing.func_176740_k().func_200128_b()) return handlers[0].cast();
+            else if (facing.func_176740_k().func_176722_c()) return handlers[1].cast();
+        }
+        return super.getCapability(capability, facing);
+    }
+
+    @Override
+    protected void invalidateCaps() {
+        super.invalidateCaps();
+        for (int x = 0; x < handlers.length; x++)
+            handlers[x].invalidate();
+    }
+
+    @OnlyIn(Dist.CLIENT)
+    public AxisAlignedBB func_184177_bl() {
+        if (this.func_184582_a(EquipmentSlotType.HEAD).func_77973_b() == Items.field_196151_dA) {
+            float f = 0.5F;
+            return this.func_174813_aQ().func_72314_b(0.5D, 0.5D, 0.5D);
+        } else {
+            return super.func_184177_bl();
+        }
+    }
+
+    protected final int getEatTimeTicks() {
+        return this.field_184628_bn;
+    }
+
+    protected final void setEatTimeTicks(int value) {
+        this.field_184628_bn = value;
+    } // Paper - OBFHELPER
+
 }
